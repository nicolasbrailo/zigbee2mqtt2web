"use strict";class CamViewer extends React.Component{static buildProps(api_base_path="",svc_full_url="",cam_host=""){return{key:`cam_viewer_${cam_host}`,api_base_path,svc_full_url,cam_host}}constructor(props){super(props);this.state={imageTimestamp:Date.now(),isLoading:false,isRecording:false,recordDuration:20,recordingTimeLeft:0,cameras:[],selectedCamera:props.cam_host||"",camerasLoading:!props.cam_host,imageError:false};this.countdownInterval=null;this.onSnapRequested=this.onSnapRequested.bind(this);this.onRecordRequested=this.onRecordRequested.bind(this);this.onCameraSelected=this.onCameraSelected.bind(this);this.onImageError=this.onImageError.bind(this)}componentDidMount(){if(!this.props.cam_host){this.fetchCameras()}}fetchCameras(){mJsonGet(`${this.props.api_base_path}/ls_cams`,cameras=>{this.setState({cameras:cameras,camerasLoading:false,selectedCamera:cameras.length>0?cameras[0]:""})},err=>{showGlobalError("Failed to fetch cameras: "+err);this.setState({camerasLoading:false})})}onCameraSelected(e){this.setState({selectedCamera:e.target.value,imageTimestamp:Date.now(),imageError:false})}onImageError(){this.setState({imageError:true})}on_app_became_visible(){}onSnapRequested(){this.setState({isLoading:true});const cam_host=this.state.selectedCamera||this.props.cam_host;mTextGet(`${this.props.api_base_path}/snap/${cam_host}`,()=>{console.log("Snapshot captured");setTimeout(()=>{this.setState({imageTimestamp:Date.now(),isLoading:false,imageError:false})},500)},err=>{showGlobalError("Failed to capture snapshot: "+err);this.setState({isLoading:false})})}onRecordRequested(){const secs=this.state.recordDuration;const cam_host=this.state.selectedCamera||this.props.cam_host;this.setState({isRecording:true,recordingTimeLeft:secs});mTextGet(`${this.props.api_base_path}/record/${cam_host}?secs=${secs}`,()=>{console.log(`Recording started for ${secs} seconds`);this.countdownInterval=setInterval(()=>{this.setState(prevState=>{const newTime=prevState.recordingTimeLeft-1;if(newTime<=0){clearInterval(this.countdownInterval);return{isRecording:false,recordingTimeLeft:0}}return{recordingTimeLeft:newTime}})},1000)},err=>{showGlobalError("Failed to start recording: "+err.response);this.setState({isRecording:false,recordingTimeLeft:0})})}render(){const{api_base_path,svc_full_url}=this.props;const{selectedCamera,cameras,camerasLoading,imageError}=this.state;const cam_host=selectedCamera||this.props.cam_host;const lastSnapUrl=cam_host?`${api_base_path}/lastsnap/${cam_host}?t=${this.state.imageTimestamp}`:"";const imgSrc=imageError?`${api_base_path}/no-snap.png`:lastSnapUrl;const showCameraSelector=!this.props.cam_host&&cameras.length>0;if(camerasLoading){return React.createElement("section",{id:"zwm_reolink_doorcam"},React.createElement("p",null,"Loading cameras..."))}if(!cam_host){return React.createElement("section",{id:"zwm_reolink_doorcam"},React.createElement("p",null,"No cameras available"))}return React.createElement("section",{id:"zwm_reolink_doorcam"},showCameraSelector&&React.createElement("div",null,React.createElement("label",null,"Camera: "),React.createElement("select",{value:selectedCamera,onChange:this.onCameraSelected},cameras.map(cam=>React.createElement("option",{key:cam,value:cam},cam)))),React.createElement("div",null,React.createElement("button",{onClick:this.onSnapRequested,disabled:this.state.isLoading||this.state.isRecording},this.state.isLoading?"Capturing...":"Take New Snapshot"),React.createElement("button",{onClick:this.onRecordRequested,disabled:this.state.isRecording||this.state.isLoading},this.state.isRecording?`Recording (${this.state.recordingTimeLeft}s)...`:`Record Video (${this.state.recordDuration}s)`),React.createElement("button",{onClick:()=>window.location.href=`${svc_full_url}/nvr`},"View Recordings"),React.createElement("input",{type:"range",min:"10",max:"100",value:this.state.recordDuration,onChange:e=>this.setState({recordDuration:parseInt(e.target.value)}),disabled:this.state.isRecording})),React.createElement("a",{href:lastSnapUrl},React.createElement("img",{className:"img-always-on-screen quite-round",src:imgSrc,alt:`Last snap from ${cam_host}`,onError:this.onImageError})))}}
