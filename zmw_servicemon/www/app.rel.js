"use strict";function _formatDate(timestamp){const d=new Date(timestamp);return`${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`}class ServiceMonitor extends React.Component{static buildProps(){return{key:"ServiceMonitor"}}constructor(props){super(props);this.state={services:null,systemdServicesStdout:null,monitoredSystemdServices:null,uptimeStdout:null,recentErrors:null}}componentDidMount(){this.on_app_became_visible()}on_app_became_visible(){mJsonGet("/ls",data=>{this.setState({services:data})});mJsonGet("/recent_errors",data=>{this.setState({recentErrors:data})});mJsonGet("/systemd_services_status",data=>{this.setState({monitoredSystemdServices:data})});mTextGet("/systemd_status",stdout=>{this.setState({systemdServicesStdout:stdout})});mTextGet("/system_uptime",stdout=>{this.setState({uptimeStdout:stdout})})}isStale(lastSeen){if(!lastSeen)return true;const last=new Date(lastSeen.replace(" ","T"));const now=new Date;const diffMs=now-last;const diffMinutes=diffMs/1000/60;return diffMinutes>5}formatServiceName(srv){let name=srv.name;if(name.startsWith("Zmw")){name=name.slice(3)}if(srv.www){try{const url=new URL(srv.www);const port=url.port||(url.protocol==="https:"?"443":"80");name=`${name}:${port}`}catch(e){}}return name}renderServices(){if(!this.state.services)return React.createElement("div",null,"Loading services...");const services=Object.values(this.state.services);const total=services.length;const running=services.filter(srv=>!this.isStale(srv.last_seen)).length;const unhealthy=total-running;let statusSummary=`${running} out of ${total} services up and running`;if(unhealthy>0){statusSummary+=`, ${unhealthy} service${unhealthy>1?"s":""} unhealthy`}return React.createElement("section",{id:"zmw_services",className:"card"},React.createElement("h3",null,"ZMW Services"),React.createElement("p",null,statusSummary),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"10px",marginBottom:"20px"}},services.map(srv=>React.createElement("div",{key:srv.name,className:"card",style:{padding:"10px",position:"relative",paddingBottom:"35px"}},React.createElement("h4",{style:{margin:"0 0 5px 0"}},srv.www?React.createElement("a",{href:srv.www,target:"_blank",rel:"noopener noreferrer"},React.createElement("img",{src:`${srv.www}/favicon.ico`,style:{width:"16px",height:"16px",marginRight:"5px",verticalAlign:"middle"}}),this.formatServiceName(srv)):React.createElement("strong",null,this.formatServiceName(srv))),React.createElement("div",{style:{fontSize:"0.9em",color:this.isStale(srv.last_seen)?"red":"inherit",marginBottom:"5px"}},srv.last_seen||"Service down"),srv.methods&&srv.methods.length>0&&React.createElement("div",{style:{fontSize:"0.85em",color:"#666"}},React.createElement("em",null,"Methods:")," ",srv.methods.join(", ")),srv.www&&React.createElement("a",{href:`${srv.www}/svc_logs.html`,target:"_blank",rel:"noopener noreferrer",style:{position:"absolute",bottom:"8px",right:"8px",fontSize:"0.8em"}},"\uD83D\uDCDC Logs")))))}renderMonitoredSystemdServices(){if(!this.state.monitoredSystemdServices)return null;if(this.state.monitoredSystemdServices.length===0)return null;const services=this.state.monitoredSystemdServices;const total=services.length;const running=services.filter(srv=>srv.running).length;const unhealthy=total-running;let statusSummary=`${running} out of ${total} services up and running`;if(unhealthy>0){statusSummary+=`, ${unhealthy} service${unhealthy>1?"s":""} unhealthy`}return React.createElement("section",{id:"monitored_systemd_services",className:"card"},React.createElement("h3",null,"Monitored Systemd non-ZMW Services"),React.createElement("p",null,statusSummary),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"10px",marginBottom:"20px"}},services.map(srv=>React.createElement("div",{key:srv.name,className:"card",style:{padding:"10px",position:"relative",paddingBottom:"35px"}},React.createElement("h4",{style:{margin:"0 0 5px 0"}},React.createElement("strong",null,srv.name)),React.createElement("div",{style:{fontSize:"0.9em",color:srv.running?"green":"red",marginBottom:"5px"}},srv.status),React.createElement("a",{href:`/systemd_logs?service=${encodeURIComponent(srv.name)}`,target:"_blank",rel:"noopener noreferrer",style:{position:"absolute",bottom:"8px",right:"8px",fontSize:"0.8em"}},"Logs")))))}renderSystemdStatus(){let statusSummary=null;if(this.state.systemdServicesStdout){const lines=this.state.systemdServicesStdout.split("\n").filter(line=>line.trim());const total=lines.length;const running=lines.filter(line=>line.includes("active")&&line.includes("running")).length;const unhealthy=total-running;statusSummary=`${running} out of ${total} services up and running`;if(unhealthy>0){statusSummary+=`, ${unhealthy} service${unhealthy>1?"s":""} unhealthy`}}return React.createElement("section",{id:"systemd_status",className:"card"},React.createElement("h3",null,"Systemd services status"),!this.state.systemdServicesStdout?React.createElement("div",{className:"app-loading"},"Loading systemd status..."):React.createElement("div",null,React.createElement("p",null,statusSummary),this.state.uptimeStdout&&React.createElement("p",null,this.state.uptimeStdout),React.createElement("pre",{dangerouslySetInnerHTML:{__html:this.state.systemdServicesStdout}})))}clearRecentErrors(){mJsonGet("/recent_errors_clear",()=>{mJsonGet("/recent_errors",data=>{this.setState({recentErrors:data})})})}simulateError(){mJsonGet("/recent_errors_test_new",()=>{mJsonGet("/recent_errors",data=>{this.setState({recentErrors:data})})})}renderRecentErrors(){if(!this.state.recentErrors)return React.createElement("div",null,"Loading errors...");const errors=this.state.recentErrors;if(errors.length===0){return React.createElement("section",{id:"journal_errors",className:"card"},React.createElement("h3",null,"Recent Errors (",errors.length,")"),React.createElement("button",{onClick:()=>this.simulateError()},"Simulate error"),React.createElement("p",null,"No errors detected! All services running cleanly."))}return React.createElement("section",{id:"journal_errors",className:"card"},React.createElement("h3",null,"Recent Errors (",errors.length,")"),React.createElement("button",{onClick:()=>this.clearRecentErrors()},"Clear"),React.createElement("button",{onClick:()=>this.simulateError()},"Simulate error"),React.createElement("table",null,React.createElement("tbody",null,errors.slice().reverse().map((err,idx)=>{const priorityColors={"EMERG":"#ff0000","ALERT":"#ff3300","CRIT":"#ff6600","ERR":"#ff9900","WARNING":"#ffcc00"};const priorityText={"EMERG":"EMRG","ALERT":"ALRT","CRIT":"CRIT","ERR":"ERRR","WARNING":"WARN"};return React.createElement("tr",{key:idx},React.createElement("td",null,_formatDate(err.timestamp)),React.createElement("td",null,err.service),React.createElement("td",{style:{color:priorityColors[err.priority_name]||"#999"}},priorityText[err.priority_name]||err.priority_name),React.createElement("td",{className:"journal-entry"},err.message))}))))}render(){return React.createElement("div",{id:"ServiceMonitorContainer"},this.renderServices(),this.renderMonitoredSystemdServices(),this.renderSystemdStatus(),this.renderRecentErrors())}};
