<!DOCTYPE html>
<html>
<head>
<title>Service logs</title>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/zmw.css">

<style>
  #log_controls {
    margin-bottom: 20px;
  }

  #log_status {
    margin: 10px 0;
    font-size: 0.9em;
    color: var(--color-grey);
  }

  #logs_container {
    max-width: 100%;
    overflow-x: auto;
  }

  .log_entry {
    font-family: var(--font-family-mono);
    font-size: 0.85em;
    padding: 8px;
    border-bottom: 1px solid var(--color-lightGrey);
  }

  .log_metadata {
    display: flex;
    gap: 10px;
    margin-bottom: 4px;
  }

  .log_timestamp {
    color: var(--color-darkGrey);
    white-space: nowrap;
  }

  .log_level {
    font-weight: bold;
    min-width: 60px;
    text-align: center;
  }

  .log_level_0,
  .log_level_1,
  .log_level_2,
  .log_level_3 {
    color: var(--color-error);
  }

  .log_level_4 {
    color: #ff9800;
  }

  .log_level_5,
  .log_level_6 {
    color: var(--color-success);
  }

  .log_level_7 {
    color: var(--color-grey);
  }

  .log_logger {
    color: var(--color-secondary);
  }

  .log_message {
    width: 100%;
    word-break: break-word;
    padding-left: 4px;
  }

  .error_display {
    padding: 20px;
    background-color: var(--bg-secondary-color);
    border: 2px solid var(--color-error);
    border-radius: 10px;
    color: var(--color-error);
  }
</style>
</head>

<body class="dark">
  <h1><img src="/favicon.ico" />Service logs</h1>

  <div class="container">
    <div id="log_controls" class="card">
      <button class="modal-button" onclick="refreshLogs()">Refresh Logs</button>
      <button class="modal-button" onclick="window.location.href='/'">Back to Main</button>
      <div id="log_status">Loading logs...</div>
    </div>

    <div id="error_display" style="display:none;" class="error_display"></div>

    <div id="alerts_container" class="card warn" style="display:none;"></div>

    <h3>Service logs</h3>
    <div id="logs_container" class="card">
      <!-- Logs will be inserted here -->
    </div>
  </div>
</body>

<script src='/zmw.js'></script>
<script>
  function formatTimestamp(microseconds) {
    const date = new Date(parseInt(microseconds) / 1000);
    return date.toLocaleString('en-GB', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  }

  function getPriorityName(priority) {
    const levels = {
      0: 'EMERG',
      1: 'ALERT',
      2: 'CRIT',
      3: 'ERROR',
      4: 'WARN',
      5: 'NOTICE',
      6: 'INFO',
      7: 'DEBUG'
    };
    return levels[priority] || 'UNKNOWN';
  }

  function renderLogs(logs) {
    const container = document.getElementById('logs_container');

    if (!logs || logs.length === 0) {
      container.innerHTML = '<p>No logs found for the last 24 hours.</p>';
      return;
    }

    let html = '';
    logs.forEach(log => {
      const timestamp = formatTimestamp(log.__REALTIME_TIMESTAMP);
      const priority = log.PRIORITY || '6';
      const level = getPriorityName(priority);
      const message = log.MESSAGE || '';
      const logger = log.SYSLOG_IDENTIFIER || 'unknown';

      html += `
        <div class="log_entry">
          <div class="log_metadata">
            <span class="log_timestamp">${timestamp}</span>
            <span class="log_level log_level_${priority}">${level}</span>
            <span class="log_logger">${escapeHtml(logger)}</span>
          </div>
          <div class="log_message">${escapeHtml(message)}</div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatStateTimestamp(timeStr) {
    try {
      const date = new Date(timeStr);
      return date.toLocaleString('en-GB', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    } catch (e) {
      return timeStr;
    }
  }

  function renderStateHistory(stateHistory) {
    const container = document.getElementById('state_history_entries');

    if (!stateHistory || stateHistory.length === 0) {
      container.innerHTML = '<p>No state history available.</p>';
      return;
    }

    let html = `
      <div class="state_header">
        <span class="state_time">Time</span>
        <span class="state_value">New State</span>
        <span class="state_value">Old State</span>
        <span class="state_reason">Reason</span>
      </div>
    `;

    stateHistory.forEach(entry => {
      const timestamp = formatStateTimestamp(entry.time);
      const newState = entry.new_state || 'XX';
      const oldState = entry.old_state || 'XX';
      const reason = entry.reason || '';

      const newStateClass = newState === 'ON' ? 'state_on' : 'state_off';
      const oldStateClass = oldState === 'ON' ? 'state_on' : 'state_off';

      html += `
        <div class="state_entry">
          <span class="state_time">${timestamp}</span>
          <span class="state_value ${newStateClass}">${escapeHtml(newState)}</span>
          <span class="state_value ${oldStateClass}">(was ${escapeHtml(oldState)})</span>
          <span class="state_reason">${escapeHtml(reason)}</span>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function refreshLogs() {
    document.getElementById('log_status').textContent = 'Loading logs...';
    document.getElementById('error_display').style.display = 'none';

    mJsonGet('/svc_logs', function(data) {
      if (data.error) {
        showError('Error loading logs: ' + data.error);
        return;
      }

      const logs = data.logs || [];
      renderLogs(logs);

      document.getElementById('log_status').textContent =
        `Loaded ${logs.length} log entries from the last 24 hours`;
    }, function(error) {
      showError('Failed to fetch logs: ' + (error.statusText || 'Network error'));
    });
  }

  function showError(message) {
    const errorDiv = document.getElementById('error_display');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('log_status').textContent = '';
    document.getElementById('logs_container').innerHTML = '';
  }

  function refreshAlerts() {
    mJsonGet('/svc_alerts', function(alerts) {
      const container = document.getElementById('alerts_container');
      if (!alerts || alerts.length === 0) {
        container.style.display = 'none';
        return;
      }
      container.innerHTML = '<p>This service report errors</p><ul>' +
        alerts.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>';
      container.style.display = 'block';
    });
  }

  // Load alerts and logs on page load
  refreshAlerts();
  refreshLogs();
</script>
</html>

