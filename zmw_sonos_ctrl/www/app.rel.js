"use strict";function getMediaType(speaker){if(speaker.is_playing_line_in)return"Line-In";if(speaker.is_playing_radio)return"Radio";if(speaker.is_playing_tv)return"TV";if(speaker.transport_state==="PLAYING")return"Other";return null}function findSpeakerGroup(speakerName,groups){for(const[coordinator,members]of Object.entries(groups)){if(members.includes(speakerName)){return coordinator}}return null}class SonosSpeaker extends React.Component{onVolumeChange(e){const v=parseInt(e.target.value,10);this.props.onVolumeChange(this.props.speaker.name,v)}renderExtraCfgs(){const speaker=this.props.speaker;const speakerInfo=speaker.speaker_info||{};const mediaType=getMediaType(speaker);return React.createElement("details",{className:"light_details"},React.createElement("summary",null,"\u2699"),React.createElement("div",null,React.createElement("div",null,"Name: ",speakerInfo.player_name||speaker.name),React.createElement("div",null,"Model: ",speakerInfo.model_name),React.createElement("div",null,"Model Number: ",speakerInfo.model_number),React.createElement("div",null,"Zone: ",speakerInfo.zone_name),React.createElement("div",null,"URI: ",speaker.uri||"None"),React.createElement("div",null,"Media Type: ",mediaType||"None")))}render(){const speaker=this.props.speaker;const groups=this.props.groups;const groupCoordinator=findSpeakerGroup(speaker.name,groups);let transport=speaker.transport_state;if(speaker.transport_state==="PLAYING")transport="\u25B6";if(speaker.transport_state==="STOPPED")transport="Stopped";if(groupCoordinator&&groupCoordinator!=speaker.name)transport=`Follows ${groupCoordinator}`;return React.createElement("li",null,React.createElement("p",null,React.createElement("input",{id:`${speaker.name}_control`,type:"checkbox",checked:this.props.controlSelected,onChange:()=>this.props.onControlToggle(speaker.name)}),React.createElement("label",{htmlFor:`${speaker.name}_control`},speaker.name)," [",transport,"]"),"Vol: ",this.props.volume,React.createElement(DebouncedRange,{min:0,max:100,value:this.props.volume,onChange:e=>this.onVolumeChange(e)}),this.renderExtraCfgs())}}class SonosCtrl extends React.Component{static buildProps(api_base_path=""){return{key:"SonosCtrl",api_base_path:api_base_path}}constructor(props){super(props);this.state={speakers:null,groups:null,zones:null,controlSpeakers:{},masterVolume:50,spotifyUri:null,speakerVolumes:{},volumeRatios:{},wsInProgress:false,wsLogs:[],wsComplete:false}}onControlToggle(speakerName){this.setState(prev=>({controlSpeakers:{...prev.controlSpeakers,[speakerName]:!prev.controlSpeakers[speakerName]}}))}startWebSocketAction(endpoint,initialMsg,payload){this.setState({wsInProgress:true,wsLogs:[initialMsg],wsComplete:false});const protocol=window.location.protocol==="https:"?"wss:":"ws:";const wsUrl=`${protocol}//${window.location.host}${this.props.api_base_path}${endpoint}`;const ws=new WebSocket(wsUrl);ws.onopen=()=>{ws.send(JSON.stringify(payload))};ws.onmessage=event=>{this.setState(prev=>({wsLogs:[...prev.wsLogs,event.data]}))};ws.onclose=()=>{this.setState({wsInProgress:false,wsComplete:true})};ws.onerror=error=>{this.setState(prev=>({wsLogs:[...prev.wsLogs,`Error: ${error.message||"Connection error"}`],wsInProgress:false,wsComplete:true}))}}getSelectedSpeakers(){const{controlSpeakers,speakerVolumes}=this.state;const speakers={};const speakerNames=[];for(const[name,selected]of Object.entries(controlSpeakers)){if(selected){speakers[name]={vol:speakerVolumes[name]||0};speakerNames.push(name)}}return{speakers,speakerNames}}onSpotifyHijack(){const{speakers,speakerNames}=this.getSelectedSpeakers();if(Object.keys(speakers).length===0){showGlobalError("You need to select a set of speakers to control");return}this.startWebSocketAction("/spotify_hijack",`Requested Spotify-Hijack to ${speakerNames.join(", ")}`,speakers)}onLineInRequested(){const{speakers,speakerNames}=this.getSelectedSpeakers();if(Object.keys(speakers).length===0){showGlobalError("You need to select a set of speakers to control");return}this.startWebSocketAction("/line_in_requested",`Requested Line-In to ${speakerNames.join(", ")}`,speakers)}onWsLogClose(){this.setState({wsLogs:[],wsComplete:false})}onStopAll(){mJsonPut(`${this.props.api_base_path}/stop_all_playback`)}onSpeakerVolumeChange(speakerName,volume){this.setState(prev=>{const newRatio=volume>0?prev.masterVolume/volume:prev.masterVolume;return{speakerVolumes:{...prev.speakerVolumes,[speakerName]:volume},volumeRatios:{...prev.volumeRatios,[speakerName]:newRatio}}});mJsonPut(`${this.props.api_base_path}/volume`,{[speakerName]:volume})}onMasterVolumeChange(e){const newMaster=parseInt(e.target.value,10);const{volumeRatios,controlSpeakers,speakerVolumes}=this.state;const updatedVolumes={};for(const[name,ratio]of Object.entries(volumeRatios)){if(controlSpeakers[name]){const newVol=Math.round(Math.min(100,Math.max(0,newMaster/ratio)));updatedVolumes[name]=newVol}}if(Object.keys(updatedVolumes).length>0){mJsonPut(`${this.props.api_base_path}/volume`,updatedVolumes)}this.setState({masterVolume:newMaster,speakerVolumes:{...speakerVolumes,...updatedVolumes}})}componentDidMount(){this.fetchState()}on_app_became_visible(){this.fetchState()}fetchState(){mJsonGet(`${this.props.api_base_path}/world_state`,data=>{const speakerVolumes={};const volumeRatios={};const masterVolume=this.state.masterVolume;for(const speaker of data.speakers){speakerVolumes[speaker.name]=speaker.volume;volumeRatios[speaker.name]=speaker.volume>0?masterVolume/speaker.volume:masterVolume}this.setState({speakers:data.speakers,groups:data.groups,zones:data.zones,speakerVolumes:speakerVolumes,volumeRatios:volumeRatios})});mJsonGet(`${this.props.api_base_path}/get_spotify_uri`,data=>{this.setState({spotifyUri:data.spotify_uri})})}render(){if(!this.state.speakers){return React.createElement("div",null,"Loading...")}const hasSpotify=this.state.spotifyUri!=null;return React.createElement("div",{id:"zmw_lights"},React.createElement("div",{id:"master_ctrls",className:"card"},React.createElement("button",{onClick:()=>this.onSpotifyHijack(),disabled:!hasSpotify||this.state.wsInProgress},this.state.wsInProgress?"Working...":hasSpotify?"Spotify Hijack":"Spotify Hijack (Not playing)"),React.createElement("button",{onClick:()=>this.onLineInRequested(),disabled:this.state.wsInProgress},"Line in"),React.createElement("button",{onClick:()=>this.onStopAll()},"Stop all"),React.createElement("div",null,"URI: ",this.state.spotifyUri||"None"),React.createElement("label",null,"Master volume"),React.createElement(DebouncedRange,{min:0,max:100,value:this.state.masterVolume,onChange:e=>this.onMasterVolumeChange(e)})),this.state.wsLogs.length>0&&React.createElement("div",{id:"ws_log"},React.createElement("ul",null,this.state.wsLogs.map((msg,idx)=>React.createElement("li",{key:idx},msg))),this.state.wsComplete&&React.createElement("button",{onClick:()=>this.onWsLogClose()},"Close")),React.createElement("details",{open:true},React.createElement("summary",null,"Speakers"),React.createElement("ul",null,this.state.speakers.map(speaker=>React.createElement(SonosSpeaker,{key:speaker.name,speaker:speaker,groups:this.state.groups,api_base_path:this.props.api_base_path,controlSelected:!!this.state.controlSpeakers[speaker.name],onControlToggle:name=>this.onControlToggle(name),volume:this.state.speakerVolumes[speaker.name]||0,onVolumeChange:(name,vol)=>this.onSpeakerVolumeChange(name,vol)})))))}}
