"use strict";class ContactMonitor extends React.Component{static buildProps(api_base_path=""){return{key:"ContactMonitor",api_base_path:api_base_path}}constructor(props){super(props);this.state={svc_state:null,expandedHistory:{}};this.skipChimeReq=this.skipChimeReq.bind(this);this.enableChimeReq=this.enableChimeReq.bind(this);this.fetchServiceState=this.fetchServiceState.bind(this);this.toggleHistory=this.toggleHistory.bind(this);this.timer=null}async componentDidMount(){this.fetchServiceState()}on_app_became_visible(){this.fetchServiceState()}componentDidUpdate(prevProps,prevState){var _prevState$svc_state,_this$state$svc_state;const prevSkip=(_prevState$svc_state=prevState.svc_state)===null||_prevState$svc_state===void 0?void 0:_prevState$svc_state.skipping_chimes;const currSkip=(_this$state$svc_state=this.state.svc_state)===null||_this$state$svc_state===void 0?void 0:_this$state$svc_state.skipping_chimes;if(!prevSkip&&currSkip){this.startSkipTimer()}}startSkipTimer(){if(this.timer)clearInterval(this.timer);this.timer=setInterval(()=>{this.setState(state=>{const timeout=state.svc_state.skipping_chime_timeout-1;if(timeout<=0){clearInterval(this.timer);this.timer=null;this.fetchServiceState();return{svc_state:{...state.svc_state,skipping_chimes:false,skipping_chime_timeout:0}}}return{svc_state:{...state.svc_state,skipping_chime_timeout:timeout}}})},1000)}componentWillUnmount(){if(this.timer){clearInterval(this.timer)}}fetchServiceState(){mJsonGet(`${this.props.api_base_path}/svc_state`,res=>{this.setState({svc_state:{...res,skipping_chime_timeout:res.skipping_chimes_timeout_secs}})})}skipChimeReq(){mJsonGet(`${this.props.api_base_path}/skip_chimes`,res=>{this.setState(state=>({svc_state:{...state.svc_state,skipping_chimes:true,skipping_chime_timeout:Number(res.timeout)}}))})}enableChimeReq(){mJsonGet(`${this.props.api_base_path}/enable_chimes`,res=>{this.fetchServiceState()})}toggleHistory(sensorName){this.setState(state=>({expandedHistory:{...state.expandedHistory,[sensorName]:!state.expandedHistory[sensorName]}}))}formatTime(seconds){if(seconds<60){return`${Math.round(seconds)}s`}const minutes=Math.floor(seconds/60);if(minutes<60){const secs=Math.round(seconds%60);return`${minutes}m ${secs}s`}const hours=Math.floor(minutes/60);if(hours<24){const mins=minutes%60;return`${hours}h ${mins}m`}const days=Math.floor(hours/24);if(days<7){const hrs=hours%24;return`${days}d ${hrs}h`}const weeks=Math.floor(days/7);const remainingDays=days%7;return`${weeks}w ${remainingDays}d`}render(){if(!this.state.svc_state){return React.createElement("div",{className:"app-loading"},"Loading...")}const hasTimeouts=this.state.svc_state.timeout_sensors&&this.state.svc_state.timeout_sensors.length>0;const hasCurfews=this.state.svc_state.curfew_sensors&&this.state.svc_state.curfew_sensors.length>0;const sensors=this.state.svc_state.sensors||{};const sensorNames=Object.keys(sensors).sort();return React.createElement("div",{id:"ContactMonitorContainer"},this.state.svc_state.skipping_chimes&&React.createElement("div",{className:"bd-error bg-dark text-center"},"Will skip chimes for the next ",Math.round(this.state.svc_state.skipping_chime_timeout)," seconds"),this.state.svc_state.skipping_chimes?React.createElement("button",{type:"button",onClick:this.enableChimeReq},"Enable chimes"):React.createElement("button",{type:"button",onClick:this.skipChimeReq},"Skip next chime"),hasTimeouts&&React.createElement("div",{style:{marginTop:"20px",padding:"10px",backgroundColor:"#fff3cd",border:"1px solid #ffc107",borderRadius:"4px"}},React.createElement("h4",{style:{margin:"0 0 10px 0"}},"\u23F0 Pending Timeouts"),React.createElement("ul",{style:{margin:0}},this.state.svc_state.timeout_sensors.map((timeout,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,timeout.sensor)," - will timeout in ",this.formatTime(timeout.seconds_remaining))))),hasCurfews&&React.createElement("div",{style:{marginTop:"20px",padding:"10px",backgroundColor:"#d1ecf1",border:"1px solid #0c5460",borderRadius:"4px"}},React.createElement("h4",{style:{margin:"0 0 10px 0"}},"\uD83C\uDF19 Scheduled Curfew Alerts"),React.createElement("ul",{style:{margin:0}},this.state.svc_state.curfew_sensors.map((curfew,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,curfew.sensor)," - will trigger in ",this.formatTime(curfew.seconds_until_trigger))))),React.createElement("ul",null,sensorNames.map(sensorName=>this.renderSensor(sensorName,sensors[sensorName]))))}formatDuration(startTime,endTime){const start=new Date(startTime);const end=endTime?new Date(endTime):new Date;const durationSecs=(end-start)/1000;return this.formatTime(durationSecs)}renderHistory(sensorName,history){var _this$state$svc_state2;if(!history||history.length===0){return null}const sortedHistory=[...history].sort((a,b)=>{const timeA=a.changed?new Date(a.changed).getTime():0;const timeB=b.changed?new Date(b.changed).getTime():0;return timeB-timeA});const currentSensor=(_this$state$svc_state2=this.state.svc_state.sensors)===null||_this$state$svc_state2===void 0?void 0:_this$state$svc_state2[sensorName];return React.createElement("div",{style:{marginLeft:"20px",marginTop:"10px",fontSize:"0.85em",padding:"10px",borderRadius:"4px",border:"1px solid #444"}},React.createElement("div",{style:{fontWeight:"bold",marginBottom:"5px"}},"History (last ",sortedHistory.length," events):"),React.createElement("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"0.95em"}},React.createElement("thead",null,React.createElement("tr",{style:{borderBottom:"1px solid #555"}},React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Contact"),React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Action"),React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Changed"),React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Duration"))),React.createElement("tbody",null,sortedHistory.map((event,idx)=>{const contact=event.contact===true?"closed":event.contact===false?"open":"unknown";const action=event.action||"unknown";const changedDate=event.changed?new Date(event.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";const isOpen=event.contact===false;let duration="";const isFirstItem=idx===0;const isCurrentState=currentSensor&&currentSensor.contact===event.contact&&currentSensor.action===event.action;if(isFirstItem&&isCurrentState){duration="current"}else if(changedDate){let endDate;if(isFirstItem){endDate=new Date}else{const newerEvent=sortedHistory[idx-1];endDate=newerEvent&&newerEvent.changed?new Date(newerEvent.changed):new Date}const durationSecs=(endDate-changedDate)/1000;duration=this.formatTime(durationSecs)}return React.createElement("tr",{key:idx,className:isOpen?"text-error":"text-success",style:{borderBottom:"1px solid #333"}},React.createElement("td",{style:{padding:"4px"}},contact),React.createElement("td",{style:{padding:"4px"}},action),React.createElement("td",{style:{padding:"4px"}},changedStr),React.createElement("td",{style:{padding:"4px"}},duration))}))))}renderSensor(sensorName,sensor){var _this$state$svc_state3;let contact="";let displayText="";let isOpen=false;if(sensor.contact===true){contact="closed";const action=sensor.action||"unknown";displayText=`${contact} (${action})`;isOpen=false}else if(sensor.contact===false){contact="open";const action=sensor.action||"unknown";displayText=`${contact} (${action})`;isOpen=true}else{displayText="in unknown state (waiting for sensor report)";isOpen=false}const changedDate=sensor.changed?new Date(sensor.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";let durationStr="";if(changedDate){const now=new Date;const durationSecs=(now-changedDate)/1000;durationStr=this.formatTime(durationSecs)}const isExpanded=this.state.expandedHistory[sensorName];const history=((_this$state$svc_state3=this.state.svc_state.history)===null||_this$state$svc_state3===void 0?void 0:_this$state$svc_state3[sensorName])||[];return React.createElement("li",{key:sensorName},React.createElement("div",{className:isOpen?"bd-error":"",style:isOpen?{padding:"5px",marginBottom:"5px"}:{}},React.createElement("strong",null,sensorName),": ",displayText,changedDate&&React.createElement("span",{style:{fontSize:"0.9em",color:"#666",marginLeft:"10px"}},"- changed at ",changedStr," (",durationStr," ago)"),history.length>0&&React.createElement("span",{onClick:()=>this.toggleHistory(sensorName),style:{marginLeft:"10px",cursor:"pointer",color:"#4a9eff",textDecoration:"underline"}},"(history)")),isExpanded&&this.renderHistory(sensorName,history))}}
