"use strict";function formatTime(seconds){if(seconds<60){return`${Math.round(seconds)}s`}const minutes=Math.floor(seconds/60);if(minutes<60){const secs=Math.round(seconds%60);return`${minutes}m ${secs}s`}const hours=Math.floor(minutes/60);if(hours<24){const mins=minutes%60;return`${hours}h ${mins}m`}const days=Math.floor(hours/24);if(days<7){const hrs=hours%24;return`${days}d ${hrs}h`}const weeks=Math.floor(days/7);const remainingDays=days%7;return`${weeks}w ${remainingDays}d`}class ContactMonitor extends React.Component{static buildProps(api_base_path=""){return{key:"ContactMonitor",api_base_path:api_base_path}}constructor(props){super(props);this.state={svc_state:null};this.skipChimeReq=this.skipChimeReq.bind(this);this.enableChimeReq=this.enableChimeReq.bind(this);this.fetchServiceState=this.fetchServiceState.bind(this);this.timer=null}async componentDidMount(){this.fetchServiceState()}on_app_became_visible(){this.fetchServiceState()}componentDidUpdate(prevProps,prevState){var _prevState$svc_state,_this$state$svc_state;const prevSkip=(_prevState$svc_state=prevState.svc_state)===null||_prevState$svc_state===void 0?void 0:_prevState$svc_state.skipping_chimes;const currSkip=(_this$state$svc_state=this.state.svc_state)===null||_this$state$svc_state===void 0?void 0:_this$state$svc_state.skipping_chimes;if(!prevSkip&&currSkip){this.startSkipTimer()}}startSkipTimer(){if(this.timer)clearInterval(this.timer);this.timer=setInterval(()=>{this.setState(state=>{const timeout=state.svc_state.skipping_chime_timeout-1;if(timeout<=0){clearInterval(this.timer);this.timer=null;this.fetchServiceState();return{svc_state:{...state.svc_state,skipping_chimes:false,skipping_chime_timeout:0}}}return{svc_state:{...state.svc_state,skipping_chime_timeout:timeout}}})},1000)}componentWillUnmount(){if(this.timer){clearInterval(this.timer)}}fetchServiceState(){mJsonGet(`${this.props.api_base_path}/svc_state`,res=>{this.setState({svc_state:{...res,skipping_chime_timeout:res.skipping_chimes_timeout_secs}})})}skipChimeReq(){mJsonGet(`${this.props.api_base_path}/skip_chimes`,res=>{this.setState(state=>({svc_state:{...state.svc_state,skipping_chimes:true,skipping_chime_timeout:Number(res.timeout)}}))})}enableChimeReq(){mJsonGet(`${this.props.api_base_path}/enable_chimes`,res=>{this.fetchServiceState()})}render(){if(!this.state.svc_state){return React.createElement("div",null,"Loading...")}const hasTimeouts=this.state.svc_state.timeout_sensors&&this.state.svc_state.timeout_sensors.length>0;const hasCurfews=this.state.svc_state.curfew_sensors&&this.state.svc_state.curfew_sensors.length>0;const sensors=this.state.svc_state.sensors||{};const sensorNames=Object.keys(sensors).sort();return React.createElement("section",{id:"zmw_contactmon",className:"card"},this.state.svc_state.skipping_chimes?React.createElement("button",{type:"button",onClick:this.enableChimeReq},"Enable chimes"):React.createElement("button",{type:"button",onClick:this.skipChimeReq},"Skip next chime"),this.state.svc_state.skipping_chimes&&React.createElement("div",{className:"card warn"},React.createElement("p",null,"Skipping chimes!"),React.createElement("p",null,"Will skip chimes for the next ",Math.round(this.state.svc_state.skipping_chime_timeout)," seconds")),hasTimeouts&&React.createElement("div",{className:"card info"},React.createElement("p",null,"Pending Timeouts"),React.createElement("ul",null,this.state.svc_state.timeout_sensors.map((timeout,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,timeout.sensor)," - will timeout in ",formatTime(timeout.seconds_remaining))))),hasCurfews&&React.createElement("div",{className:"card info"},React.createElement("p",null,"Curfew Alerts"),React.createElement("ul",null,this.state.svc_state.curfew_sensors.map((curfew,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,curfew.sensor)," - will trigger in ",formatTime(curfew.seconds_until_trigger))))),React.createElement("ul",null,sensorNames.map(sensorName=>this.renderSensor(sensorName,sensors[sensorName]))))}renderSensor(sensorName,sensor){var _this$state$svc_state2;let displayText="";if(sensor.contact===true){displayText="closed"}else if(sensor.contact===false){displayText="open"}else{displayText="in unknown state (waiting for sensor report)"}const changedDate=sensor.changed?new Date(sensor.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";let durationStr="";if(changedDate){const now=new Date;const durationSecs=(now-changedDate)/1000;durationStr=formatTime(durationSecs)}const history=((_this$state$svc_state2=this.state.svc_state.history)===null||_this$state$svc_state2===void 0?void 0:_this$state$svc_state2[sensorName])||[];return React.createElement("li",{key:sensorName},React.createElement("strong",null,sensorName),": ",displayText,changedDate&&React.createElement("span",null," "," @ ",changedStr," (",durationStr," ago)"),this.renderHistory(sensorName,history))}renderHistory(sensorName,history){var _this$state$svc_state3;if(!history||history.length===0){return null}const sortedHistory=[...history].sort((a,b)=>{const timeA=a.changed?new Date(a.changed).getTime():0;const timeB=b.changed?new Date(b.changed).getTime():0;return timeB-timeA});const currentSensor=(_this$state$svc_state3=this.state.svc_state.sensors)===null||_this$state$svc_state3===void 0?void 0:_this$state$svc_state3[sensorName];return React.createElement("details",null,React.createElement("summary",null,"History (last ",sortedHistory.length," events)"),React.createElement("table",null,React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Contact"),React.createElement("th",null,"Action"),React.createElement("th",null,"Changed"),React.createElement("th",null,"Duration"))),React.createElement("tbody",null,sortedHistory.map((evt,idx)=>{const contact=evt.contact===true?"closed":evt.contact===false?"open":"unknown";const action=evt.action||"unknown";const changedDate=evt.changed?new Date(evt.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";const isOpen=evt.contact===false;let duration="";const isFirstItem=idx===0;const isCurrentState=currentSensor&&currentSensor.contact===evt.contact&&currentSensor.action===evt.action;if(isFirstItem&&isCurrentState){duration="current"}else if(changedDate){let endDate;if(isFirstItem){endDate=new Date}else{const newerEvent=sortedHistory[idx-1];endDate=newerEvent&&newerEvent.changed?new Date(newerEvent.changed):new Date}const durationSecs=(endDate-changedDate)/1000;duration=formatTime(durationSecs)}return React.createElement("tr",{key:idx,className:evt.contact?"hint":"warn"},React.createElement("td",null,contact),React.createElement("td",null,action),React.createElement("td",null,changedStr),React.createElement("td",null,duration))}))))}}
