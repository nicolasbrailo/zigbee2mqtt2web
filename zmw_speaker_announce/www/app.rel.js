"use strict";class TTSAnnounce extends React.Component{static buildProps(api_base_path=""){return{key:"tts_announce",api_base_path:api_base_path}}constructor(props){super(props);this.canRecordMic=window.location.protocol==="https:";this.state={ttsPhrase:"",ttsLang:"es-ES",isRecording:false,speakerList:null,announcementHistory:[],historyExpanded:false};this.recorderRef=React.createRef();this.onTTSRequested=this.onTTSRequested.bind(this);this.onMicRecRequested=this.onMicRecRequested.bind(this);this.onMicRecSend=this.onMicRecSend.bind(this);this.onCancel=this.onCancel.bind(this);this.fetchAnnouncementHistory=this.fetchAnnouncementHistory.bind(this)}componentDidMount(){this.on_app_became_visible()}on_app_became_visible(){mJsonGet(`${this.props.api_base_path}/ls_speakers`,data=>this.setState({speakerList:data}));this.fetchAnnouncementHistory()}fetchAnnouncementHistory(){mJsonGet(`${this.props.api_base_path}/announcement_history`,data=>this.setState({announcementHistory:data}))}onTTSRequested(){const phrase=this.state.ttsPhrase.trim()||prompt("What is so important?");if(!phrase)return;this.setState({ttsPhrase:phrase});console.log(`announce {"lang": "${this.state.ttsLang}", "phrase": "${phrase}"}`);const newEntry={timestamp:new Date().toISOString(),phrase:phrase,lang:this.state.ttsLang,volume:"default",uri:`${this.props.api_base_path}/tts/${phrase}_${this.state.ttsLang}.mp3`};this.setState(prev=>({announcementHistory:[...prev.announcementHistory,newEntry].slice(-10)}));console.log("BCAST ");console.log(`${this.props.api_base_path}/announce_tts?lang=${this.state.ttsLang}&phrase=${phrase}`);mAjax({url:`${this.props.api_base_path}/announce_tts?lang=${this.state.ttsLang}&phrase=${phrase}`,type:"get",success:()=>{console.log("Sent TTS request");this.fetchAnnouncementHistory()},error:showGlobalError})}async onMicRecRequested(){if(!this.canRecordMic){showGlobalError("Mic recording only works on https pages");return}if(!navigator.mediaDevices){showGlobalError("Your browser does not support microphone recording");return}try{const stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});const rec=new MediaRecorder(stream);rec.chunks=[];rec.ondataavailable=e=>rec.chunks.push(e.data);this.recorderRef.current=rec;rec.start();this.setState({isRecording:true})}catch(err){showGlobalError("Mic error: "+err)}}onMicRecSend(){const rec=this.recorderRef.current;if(!rec){showGlobalError("No microphone recording in progress");return}rec.onstop=()=>{const blob=new Blob(rec.chunks,{type:"audio/ogg; codecs=opus"});const form=new FormData;form.append("audio_data",blob,"mic_cap.ogg");mAjax({url:`${this.props.api_base_path}/announce_user_recording`,data:form,cache:false,contentType:false,processData:false,method:"POST",success:()=>console.log("Sent user recording"),error:showGlobalError});rec.stream.getTracks().forEach(t=>t.stop());this.recorderRef.current=null;this.setState({isRecording:false})};rec.stop()}onCancel(){const rec=this.recorderRef.current;if(rec){rec.stream.getTracks().forEach(t=>t.stop());this.recorderRef.current=null}this.setState({isRecording:false})}render(){if(this.state.isRecording){return React.createElement("ul",{className:"player-announce-methods"},React.createElement("li",null,React.createElement("button",{className:"player-button",onClick:this.onMicRecSend},"Send")),React.createElement("li",null,React.createElement("button",{className:"player-button",onClick:this.onCancel},"Cancel")))}return React.createElement("div",{className:"announce-container"},React.createElement("div",{className:"announce-input-div"},React.createElement("input",{type:"text",placeholder:"Text to announce",value:this.state.ttsPhrase,onChange:e=>this.setState({ttsPhrase:e.target.value})})),React.createElement("div",{className:"announce-ctrls-div"},React.createElement("button",{onClick:this.onTTSRequested},"Announce!"),React.createElement("select",{value:this.state.ttsLang,onChange:e=>this.setState({ttsLang:e.target.value})},React.createElement("option",{value:"es-ES"},"ES"),React.createElement("option",{value:"es-419"},"es 419"),React.createElement("option",{value:"en-GB"},"EN GB")),this.canRecordMic&&React.createElement("button",{onClick:this.onMicRecRequested},"Record")),this.state.speakerList&&React.createElement("div",{className:"announce-speaker-list"},"Will announce in: ",React.createElement("ul",null,this.state.speakerList.map(x=>React.createElement("li",{key:x},x)))),React.createElement("div",{className:"announce-history-section"},React.createElement("small",{onClick:()=>this.setState({historyExpanded:!this.state.historyExpanded}),style:{cursor:"pointer",userSelect:"none"}},this.state.historyExpanded?"\u25BC":"\u25B6"," Announcement History (",this.state.announcementHistory.length,")"),this.state.historyExpanded&&React.createElement("div",{className:"announce-history-list card"},this.state.announcementHistory.length===0?React.createElement("p",null,"No announcements yet"):React.createElement("ul",null,this.state.announcementHistory.slice().reverse().map((item,idx)=>React.createElement("li",{key:idx},React.createElement("div",{className:"history-item"},React.createElement("span",{className:"history-timestamp"},new Date(item.timestamp).toLocaleString()),React.createElement("span",{className:"history-phrase"},"\"",item.phrase,"\""),React.createElement("span",{className:"history-details"},"(Lang: ",item.lang,", vol: ",item.volume,", ",React.createElement("a",{href:item.uri},"link"),")"))))))))}}
