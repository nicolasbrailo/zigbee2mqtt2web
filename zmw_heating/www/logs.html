<!DOCTYPE html>
<html>
<head>
<title>Heating logs</title>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/rel.css">

<style>
  #log_controls {
    margin-bottom: 20px;
  }

  #log_status {
    margin: 10px 0;
    font-size: 0.9em;
    color: var(--color-grey);
  }

  #logs_container {
    max-width: 100%;
    overflow-x: auto;
  }

  .log_entry {
    font-family: var(--font-family-mono);
    font-size: 0.85em;
    padding: 8px;
    border-bottom: 1px solid var(--color-lightGrey);
  }

  .log_metadata {
    display: flex;
    gap: 10px;
    margin-bottom: 4px;
  }

  .log_timestamp {
    color: var(--color-darkGrey);
    white-space: nowrap;
  }

  .log_level {
    font-weight: bold;
    min-width: 60px;
    text-align: center;
  }

  .log_level_0,
  .log_level_1,
  .log_level_2,
  .log_level_3 {
    color: var(--color-error);
  }

  .log_level_4 {
    color: #ff9800;
  }

  .log_level_5,
  .log_level_6 {
    color: var(--color-success);
  }

  .log_level_7 {
    color: var(--color-grey);
  }

  .log_logger {
    color: var(--color-secondary);
  }

  .log_message {
    width: 100%;
    word-break: break-word;
    padding-left: 4px;
  }

  .error_display {
    padding: 20px;
    background-color: var(--bg-secondary-color);
    border: 2px solid var(--color-error);
    border-radius: 10px;
    color: var(--color-error);
  }

  #state_history_container {
    margin-bottom: 20px;
    max-width: 100%;
    overflow-x: auto;
  }

  .state_entry {
    font-family: var(--font-family-mono);
    font-size: 0.85em;
    padding: 8px;
    border-bottom: 1px solid var(--color-lightGrey);
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .state_header {
    font-family: var(--font-family-mono);
    font-size: 0.85em;
    font-weight: bold;
    padding: 8px;
    border-bottom: 2px solid var(--color-darkGrey);
    display: flex;
    gap: 15px;
    align-items: center;
    color: var(--color-text);
  }

  .state_time {
    color: var(--color-darkGrey);
    white-space: nowrap;
    min-width: 150px;
  }

  .state_value {
    font-weight: bold;
    min-width: 50px;
  }

  .state_on {
    color: var(--color-success);
  }

  .state_off {
    color: var(--color-grey);
  }

  .state_reason {
    color: var(--color-secondary);
    flex: 1;
  }

  #config_rules_container {
    margin-bottom: 20px;
    max-width: 100%;
    overflow-x: auto;
  }

  .rule_entry {
    font-family: var(--font-family-mono);
    font-size: 0.85em;
    padding: 8px;
    border-bottom: 1px solid var(--color-lightGrey);
  }

  .rule_unknown {
    color: var(--color-error);
  }

  .rule_name {
    font-weight: bold;
    color: var(--color-secondary);
  }

  .rule_details {
    margin-left: 20px;
    color: var(--color-text);
  }
</style>
</head>

<body class="dark">
  <h1><img src="/favicon.ico" />Heating manager logs</h1>

  <div class="container">
    <div id="log_controls" class="card">
      <button class="modal-button" onclick="refreshLogs()">Refresh Logs</button>
      <button class="modal-button" onclick="window.location.href='/'">Back to Main</button>
      <div id="log_status">Loading logs...</div>
    </div>

    <div id="error_display" style="display:none;" class="error_display"></div>

    <div id="state_history_container" class="card">
      <h3>Boiler State History</h3>
      <div id="state_history_entries">
        <!-- State history will be inserted here -->
      </div>
    </div>

    <div id="config_rules_container" class="card">
      <h3>Config Rules</h3>
      <div id="config_rules_entries">
        <!-- Config rules will be inserted here -->
      </div>
    </div>

    <h3>Service logs</h3>
    <div id="logs_container" class="card">
      <!-- Logs will be inserted here -->
    </div>
  </div>
</body>

<script src='/extjs/z2m.react.js'></script>
<script>
  function formatTimestamp(microseconds) {
    const date = new Date(parseInt(microseconds) / 1000);
    return date.toLocaleString('en-GB', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  }

  function getPriorityName(priority) {
    const levels = {
      0: 'EMERG',
      1: 'ALERT',
      2: 'CRIT',
      3: 'ERROR',
      4: 'WARN',
      5: 'NOTICE',
      6: 'INFO',
      7: 'DEBUG'
    };
    return levels[priority] || 'UNKNOWN';
  }

  function renderLogs(logs) {
    const container = document.getElementById('logs_container');

    if (!logs || logs.length === 0) {
      container.innerHTML = '<p>No logs found for the last 24 hours.</p>';
      return;
    }

    let html = '';
    logs.forEach(log => {
      const timestamp = formatTimestamp(log.__REALTIME_TIMESTAMP);
      const priority = log.PRIORITY || '6';
      const level = getPriorityName(priority);
      const message = log.MESSAGE || '';
      const logger = log.SYSLOG_IDENTIFIER || 'unknown';

      html += `
        <div class="log_entry">
          <div class="log_metadata">
            <span class="log_timestamp">${timestamp}</span>
            <span class="log_level log_level_${priority}">${level}</span>
            <span class="log_logger">${escapeHtml(logger)}</span>
          </div>
          <div class="log_message">${escapeHtml(message)}</div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatStateTimestamp(timeStr) {
    try {
      const date = new Date(timeStr);
      return date.toLocaleString('en-GB', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    } catch (e) {
      return timeStr;
    }
  }

  function renderStateHistory(stateHistory) {
    const container = document.getElementById('state_history_entries');

    if (!stateHistory || stateHistory.length === 0) {
      container.innerHTML = '<p>No state history available.</p>';
      return;
    }

    let html = `
      <div class="state_header">
        <span class="state_time">Time</span>
        <span class="state_value">New State</span>
        <span class="state_value">Old State</span>
        <span class="state_reason">Reason</span>
      </div>
    `;

    stateHistory.forEach(entry => {
      const timestamp = formatStateTimestamp(entry.time);
      const newState = entry.new_state || 'XX';
      const oldState = entry.old_state || 'XX';
      const reason = entry.reason || '';

      const newStateClass = newState === 'ON' ? 'state_on' : 'state_off';
      const oldStateClass = oldState === 'ON' ? 'state_on' : 'state_off';

      html += `
        <div class="state_entry">
          <span class="state_time">${timestamp}</span>
          <span class="state_value ${newStateClass}">${escapeHtml(newState)}</span>
          <span class="state_value ${oldStateClass}">(was ${escapeHtml(oldState)})</span>
          <span class="state_reason">${escapeHtml(reason)}</span>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function refreshStateHistory() {
    mJsonGet('/svc_state', function(data) {
      if (data.error) {
        console.error('Error loading state history: ' + data.error);
        document.getElementById('state_history_entries').innerHTML =
          '<p>Error loading state history.</p>';
        return;
      }

      const stateHistory = data.boiler_state_history || [];
      renderStateHistory(stateHistory);
    }, function(error) {
      console.error('Failed to fetch state history: ' + (error.statusText || 'Network error'));
      document.getElementById('state_history_entries').innerHTML =
        '<p>Failed to load state history.</p>';
    });
  }

  function renderConfigRules(rules) {
    const container = document.getElementById('config_rules_entries');

    if (!rules || rules.length === 0) {
      container.innerHTML = '<p>No config rules available.</p>';
      return;
    }

    let html = '';
    rules.forEach(rule => {
      const ruleName = rule.name;

      if (ruleName === 'DefaultOff' || ruleName === 'DefaultOn') {
        html += `
          <div class="rule_entry">
            <span class="rule_name">${escapeHtml(ruleName)}</span>
            <div class="rule_details">
              Schedule: Always active
            </div>
          </div>
        `;
      } else if (ruleName === 'CheckTempsWithinRange') {
        const minTemp = rule.min_temp;
        const maxTemp = rule.max_temp;
        const sensors = rule.sensors || [];
        const sensorsList = sensors.join(', ');

        html += `
          <div class="rule_entry">
            <span class="rule_name">${escapeHtml(ruleName)}</span>
            <div class="rule_details">
              Schedule: Always active<br/>
              Min: ${minTemp}째C, Max: ${maxTemp}째C<br/>
              Sensors: ${escapeHtml(sensorsList)}
            </div>
          </div>
        `;
      } else if (ruleName === 'ScheduledMinTargetTemp') {
        const sensors = rule.sensors || [];
        sensors.forEach(sensorData => {
          const sensorName = sensorData.name;
          const schedule = sensorData.schedule || [];

          schedule.forEach(schedEntry => {
            const start = schedEntry.start;
            const end = schedEntry.end;
            const days = schedEntry.days;
            const targetMin = schedEntry.target_min_temp;
            const targetMax = schedEntry.target_max_temp;

            html += `
              <div class="rule_entry">
                <span class="rule_name">${escapeHtml(ruleName)}</span>
                <div class="rule_details">
                  Sensor: ${escapeHtml(sensorName)}<br/>
                  Schedule: ${escapeHtml(start)} - ${escapeHtml(end)} (${escapeHtml(days)})<br/>
                  Target: ${targetMin}째C - ${targetMax}째C
                </div>
              </div>
            `;
          });
        });
      } else {
        html += `
          <div class="rule_entry">
            <span class="rule_unknown">Rule not known</span>
          </div>
        `;
      }
    });

    container.innerHTML = html;
  }

  function refreshConfigRules() {
    mJsonGet('/get_cfg_rules', function(data) {
      if (data.error) {
        console.error('Error loading config rules: ' + data.error);
        document.getElementById('config_rules_entries').innerHTML =
          '<p>Error loading config rules.</p>';
        return;
      }

      // Assuming the response is directly an array
      const rules = Array.isArray(data) ? data : [];
      renderConfigRules(rules);
    }, function(error) {
      console.error('Failed to fetch config rules: ' + (error.statusText || 'Network error'));
      document.getElementById('config_rules_entries').innerHTML =
        '<p>Failed to load config rules.</p>';
    });
  }

  function refreshLogs() {
    document.getElementById('log_status').textContent = 'Loading logs...';
    document.getElementById('error_display').style.display = 'none';

    // Refresh state history, config rules, and logs
    refreshStateHistory();
    refreshConfigRules();

    mJsonGet('/svc_logs', function(data) {
      if (data.error) {
        showError('Error loading logs: ' + data.error);
        return;
      }

      const logs = data.logs || [];
      renderLogs(logs);

      document.getElementById('log_status').textContent =
        `Loaded ${logs.length} log entries from the last 24 hours`;
    }, function(error) {
      showError('Failed to fetch logs: ' + (error.statusText || 'Network error'));
    });
  }

  function showError(message) {
    const errorDiv = document.getElementById('error_display');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('log_status').textContent = '';
    document.getElementById('logs_container').innerHTML = '';
  }

  // Load logs on page load
  refreshLogs();
</script>
</html>
