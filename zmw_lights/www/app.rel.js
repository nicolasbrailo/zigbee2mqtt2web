"use strict";function filterMeta(meta){const filtered={description:meta.description,model:meta.model,name:meta.name,real_name:meta.real_name,thing_type:meta.thing_type,thing_id:meta.thing_id,address:meta.address,actions:{}};const actionNames=["brightness","color_rgb","color_temp","effect","state"];for(const actionName of actionNames){if(meta.actions&&meta.actions[actionName]){filtered.actions[actionName]=meta.actions[actionName]}}return filtered}async function getLightsMeta(api_base_path,lights){const metaPromises=lights.map(light=>{return new Promise(resolve=>{mJsonGet(`${api_base_path}/z2m/meta/${light.thing_name}`,meta=>{resolve({name:light.thing_name,meta:filterMeta(meta)})})})});const metaResults=await Promise.all(metaPromises);const metaByName={};for(const result of metaResults){metaByName[result.name]=result.meta}return metaByName}function getPrefixGroups(lightNames){function getValidPrefixes(name){const prefixes=[];for(let i=1;i<name.length;i++){if(name[i]>="A"&&name[i]<="Z"){const prefix=name.substring(0,i);if(prefix.length>=3){prefixes.push(prefix)}}}if(name.length>=3){prefixes.push(name)}return prefixes}const prefixCounts={};for(const name of lightNames){for(const prefix of getValidPrefixes(name)){prefixCounts[prefix]=(prefixCounts[prefix]||0)+1}}const groups={};const assigned=new Set;for(const name of lightNames){let bestPrefix=null;let bestCount=1;for(const prefix of getValidPrefixes(name)){if(prefixCounts[prefix]>bestCount){bestPrefix=prefix;bestCount=prefixCounts[prefix]}}if(bestPrefix){if(!groups[bestPrefix]){groups[bestPrefix]=[]}groups[bestPrefix].push(name);assigned.add(name)}}const others=lightNames.filter(name=>!assigned.has(name));if(others.length>0){groups["Others"]=others}return groups}function groupLightsByPrefix(lights){const lightNames=lights.map(light=>light.thing_name);const groupsByName=getPrefixGroups(lightNames);const lightsByName={};for(const light of lights){lightsByName[light.thing_name]=light}const groups={};const sortedPrefixes=Object.keys(groupsByName).sort((a,b)=>a.localeCompare(b));for(const prefix of sortedPrefixes){groups[prefix]=groupsByName[prefix].map(name=>lightsByName[name]).sort((a,b)=>a.thing_name.localeCompare(b.thing_name))}return groups}class ZmwLight extends React.Component{constructor(props){super(props);this.state={state:props.light.state,brightness:props.light.brightness,color_temp:props.light.color_temp,color_rgb:props.light.color_rgb||"#ffffff",effect:props.light.effect}}componentDidUpdate(prevProps){if(prevProps.light!==this.props.light){this.setState({state:this.props.light.state,brightness:this.props.light.brightness,color_temp:this.props.light.color_temp,color_rgb:this.props.light.color_rgb||"#ffffff",effect:this.props.light.effect})}}onStateChange(e){const v=e.target.checked;this.setState({state:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{state:v})}onBrightnessChange(e){const v=e.target.value;if(v==0){this.setState({brightness:0,state:false})}else{this.setState({brightness:v,state:true})}mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{brightness:v})}onColorTempChange(e){const v=e.target.value;this.setState({color_temp:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{color_temp:v})}onColorRgbChange(e){const v=e.target.value;this.setState({color_rgb:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{color_rgb:v})}onEffectChange(e){const v=e.target.value;this.setState({effect:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{effect:v})}renderColorTemp(){const meta=this.props.meta;if(!meta.actions.color_temp){return null}const colorTempMeta=meta.actions.color_temp.value.meta;const presets=colorTempMeta.presets||[];return React.createElement("div",null,React.createElement("label",null,"Temperature"),React.createElement(DebouncedRange,{min:colorTempMeta.value_min,max:colorTempMeta.value_max,value:this.state.color_temp,onChange:e=>this.onColorTempChange(e)}),React.createElement("select",{value:this.state.color_temp,onChange:e=>this.onColorTempChange(e)},presets.map(preset=>React.createElement("option",{key:preset.name,value:preset.value},preset.name))))}renderColorRgb(){const meta=this.props.meta;if(!meta.actions.color_rgb){return null}return React.createElement("div",null,React.createElement("label",null,"RGB"),React.createElement("input",{type:"color",value:this.state.color_rgb,onChange:e=>this.onColorRgbChange(e)}))}renderEffect(){const meta=this.props.meta;if(!meta.actions.effect){return null}const effectValues=meta.actions.effect.value.meta.values||[];return React.createElement("div",null,React.createElement("label",null,"Effect"),React.createElement("select",{value:this.state.effect||"",onChange:e=>this.onEffectChange(e)},React.createElement("option",{value:""},"None"),effectValues.map(effect=>React.createElement("option",{key:effect,value:effect},effect))))}renderExtraCfgs(){const meta=this.props.meta;if(!(meta.actions.color_temp||meta.actions.color_rgb||meta.actions.effect)){return null}return React.createElement("details",{className:"light_details"},React.createElement("summary",null,"\u2699"),meta.name," (",meta.description," / ",meta.model,")",this.renderColorTemp(),this.renderColorRgb(),this.renderEffect())}render(){const light=this.props.light;const meta=this.props.meta;const displayName=light.thing_name.startsWith(this.props.prefix)?light.thing_name.slice(this.props.prefix.length):light.thing_name;return React.createElement("li",null,React.createElement("input",{id:`${light.thing_name}_light_is_on`,type:"checkbox",value:"true",checked:this.state.state,onChange:e=>this.onStateChange(e)}),React.createElement("label",{htmlFor:`${light.thing_name}_light_is_on`},displayName),React.createElement(DebouncedRange,{min:0,max:254,value:this.state.brightness,onChange:e=>this.onBrightnessChange(e)}),this.renderExtraCfgs())}}class ZmwButton extends React.Component{onClick(){mJsonPut(this.props.url,{})}render(){let displayName=this.props.name.startsWith(this.props.prefix)?this.props.name.slice(this.props.prefix.length):this.props.name;displayName=displayName.replace(/_/g," ").trim();return React.createElement("button",{onClick:()=>this.onClick()},displayName)}}function groupButtonsByLightPrefixes(buttons,lightPrefixes){const groups={};const prefixList=lightPrefixes.filter(p=>p!=="Others").sort((a,b)=>b.length-a.length);for(const buttonObj of buttons){const buttonName=Object.keys(buttonObj)[0];const buttonUrl=buttonObj[buttonName];let assigned=false;for(const prefix of prefixList){if(buttonName.startsWith(prefix)){if(!groups[prefix]){groups[prefix]=[]}groups[prefix].push({name:buttonName,url:buttonUrl});assigned=true;break}}if(!assigned){if(!groups["Others"]){groups["Others"]=[]}groups["Others"].push({name:buttonName,url:buttonUrl})}}return groups}class MqttLights extends React.Component{static buildProps(api_base_path="",buttons=[]){return{key:"MqttLights",local_storage:new LocalStorageManager,api_base_path:api_base_path,buttons:buttons}}constructor(props){super(props);this.state={lights:null}}async componentDidMount(){this.fetchLights()}componentDidUpdate(prevProps){if(prevProps.buttons!==this.props.buttons&&this.state.groups){const lightPrefixes=Object.keys(this.state.groups);const buttonGroups=groupButtonsByLightPrefixes(this.props.buttons||[],lightPrefixes);this.setState({buttonGroups:buttonGroups})}}on_app_became_visible(){this.fetchLights()}setLightsState(lights,meta){const groups=groupLightsByPrefix(lights);const lightPrefixes=Object.keys(groups);const buttonGroups=groupButtonsByLightPrefixes(this.props.buttons||[],lightPrefixes);this.setState({lights:lights,groups:groups,meta:meta,buttonGroups:buttonGroups})}clearCache(){const storage=this.props.local_storage;storage.remove("zmw_lights_hash");storage.remove("lights_meta");this.fetchLights()}fetchLights(){const storage=this.props.local_storage;const cachedHash=storage.get("zmw_lights_hash",null);mJsonGet(`${this.props.api_base_path}/get_lights`,async lights=>{mJsonGet(`${this.props.api_base_path}/z2m/get_known_things_hash`,async serverHash=>{const cachedMeta=storage.cacheGet("lights_meta");if(cachedHash&&cachedHash===serverHash&&cachedMeta){this.setLightsState(lights,cachedMeta);return}const metaByName=await getLightsMeta(this.props.api_base_path,lights);storage.save("zmw_lights_hash",serverHash);storage.cacheSave("lights_meta",metaByName);this.setLightsState(lights,metaByName)})})}render(){if(!this.state.lights){return React.createElement("div",{className:"app-loading"},"Loading...")}const allPrefixes=new Set([...Object.keys(this.state.groups),...Object.keys(this.state.buttonGroups||{})]);const sortedPrefixes=Array.from(allPrefixes).sort((a,b)=>{if(a==="Others")return 1;if(b==="Others")return-1;return a.localeCompare(b)});return React.createElement("div",{id:"zmw_lights"},sortedPrefixes.map(prefix=>{const lights=this.state.groups[prefix]||[];const buttons=(this.state.buttonGroups||{})[prefix]||[];return React.createElement("details",{key:prefix},React.createElement("summary",null,prefix),buttons.map(button=>React.createElement(ZmwButton,{key:button.name,name:button.name,url:button.url,prefix:prefix})),React.createElement("ul",null,lights.map(light=>React.createElement(ZmwLight,{key:light.thing_name,light:light,meta:this.state.meta[light.thing_name],prefix:prefix,api_base_path:this.props.api_base_path}))))}),this.props.runningStandaloneApp&&React.createElement("button",{onClick:()=>this.clearCache()},"Clear cache"))}}class StandaloneMqttLights extends MqttLights{static buildProps(api_base_path="",buttons=[]){const p=super.buildProps(api_base_path,buttons);p.runningStandaloneApp=true;return p}}
