"use strict";class DebouncedRange extends React.Component{constructor(props){super(props);props.min.this_is_a_required_prop;props.max.this_is_a_required_prop;props.value.this_is_a_required_prop;const val=props.value?props.value:props.min;this.state={changing:false,value:val}}UNSAFE_componentWillReceiveProps(next_props){const val=next_props&&next_props.value?next_props.value:0;this.setState({value:val})}onChange(value){this.setState({value:value})}onMouseUp(_){this.setState({changing:false});this.props.onChange({target:{value:this.state.value}})}onMouseDown(_){this.setState({changing:true})}render(){return React.createElement("input",{type:"range",onChange:evnt=>this.onChange(evnt.target.value),onMouseUp:evnt=>{this.onMouseUp(evnt.target.value)},onMouseDown:evnt=>this.onMouseDown(evnt.target.value),onTouchStart:evnt=>this.onMouseDown(evnt.target.value),onTouchEnd:evnt=>this.onMouseUp(evnt.target.value),className:this.props.className,min:this.props.min,max:this.props.max,value:this.state.value})}}class Light extends React.Component{static buildProps(meta,state,api_base_path=""){var props={name:meta.name,description:meta.description,manufacturer:meta.manufacturer,model:meta.model,supports_brightness:false,brightness_min:0,brightness_max:0,supports_color_temp:false,color_temp_min:0,color_temp_max:0,color_temp_presets:[],supports_rgb:false,user_defined:meta.user_defined,api_base_path:api_base_path,current_state:state.state||false,current_brightness:state.brightness||0,current_color_temp:state.color_temp||0,current_color_rgb:state.color_rgb||""};for(const action_name of Object.keys(meta.actions)){var desc=meta.actions[action_name].value.meta;if(!desc)desc={};if(action_name=="brightness"){props.supports_brightness=true;props.brightness_min=desc.value_min;props.brightness_max=desc.value_max}else if(action_name=="color_temp"){props.supports_color_temp=true;props.color_temp_min=desc.value_min;props.color_temp_max=desc.value_max;props.color_temp_presets=desc.presets}else if(action_name=="color_rgb"){props.supports_rgb=true}}props.has_extra_details=props.supports_color_temp||props.supports_rgb;return props}constructor(props){super(props);this.state={state:props.current_state,brightness:props.current_brightness||props.brightness_min,color_temp:props.current_color_temp||props.color_temp_min,color_rgb:props.current_color_rgb||"",details_shown:false}}componentDidUpdate(prevProps){if(prevProps.current_state!==this.props.current_state||prevProps.current_brightness!==this.props.current_brightness||prevProps.current_color_temp!==this.props.current_color_temp||prevProps.current_color_rgb!==this.props.current_color_rgb){this.setState({state:this.props.current_state,brightness:this.props.current_brightness||this.props.brightness_min,color_temp:this.props.current_color_temp||this.props.color_temp_min,color_rgb:this.props.current_color_rgb||""})}}setLightOn(v){this.setState({state:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`state=${v}`)}changeBrightness(v){if(v==0){this.setState({brightness:0,state:false})}else{this.setState({brightness:v,state:true})}mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`brightness=${v}`)}changeColorTemp(v){this.setState({color_temp:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`color_temp=${v}`)}toggleDetailsPanel(){this.setState({details_shown:!this.state.details_shown})}changeRGB(v){this.setState({color_rgb:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`color_rgb=${v}`)}render(){return React.createElement("div",{className:"thing_div",key:`${this.props.name}_light_div`},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-primary-action"},React.createElement("input",{type:"checkbox",checked:this.state.state,value:this.state.state,onChange:evnt=>this.setLightOn(evnt.target.checked),key:`${this.props.name}_light_is_on`})),React.createElement("div",{className:"col-fixed-fill thing-no-linebreak"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-fixed-fill"},React.createElement("label",{className:"thing_name",htmlFor:`${this.props.name}_light_is_on`},this.props.name)),this.render_details_toggle()),React.createElement("div",{className:"row"},this.render_brightness_select()))),this.render_details_panel())}render_details_toggle(){if(!this.props.has_extra_details)return"";return React.createElement("div",{key:`${this.props.name}_light_details_panel_toggle_div`,className:"toggle-details-panel"},this.render_details_toggle_link())}render_details_toggle_link(){if(!this.state.details_shown){return React.createElement("a",{key:`${this.props.name}_light_details_panel_toggle`,onClick:evnt=>this.toggleDetailsPanel()},"\u25BC")}return React.createElement("a",{key:`${this.props.name}_light_details_panel_toggle`,onClick:evnt=>this.toggleDetailsPanel()},"\u25B2")}render_details_panel(){if(!this.props.has_extra_details)return"";if(!this.state.details_shown)return"";return React.createElement("div",{className:"card modal"},[this.render_rgb_picker(),this.render_color_temp()])}render_brightness_select(){if(!this.props.supports_brightness)return"";return React.createElement(DebouncedRange,{onChange:evnt=>this.changeBrightness(evnt.target.value),key:`${this.props.name}_light_brightness_slider`,min:this.props.brightness_min,max:this.props.brightness_max,value:this.state.brightness})}render_color_temp(){if(!this.props.supports_color_temp)return"";return React.createElement("div",{key:`${this.props.name}_div_color_temp`},React.createElement("label",null,"Temperature"),React.createElement(DebouncedRange,{onChange:evnt=>this.changeColorTemp(evnt.target.value),key:`${this.props.name}_light_color_temp`,min:this.props.color_temp_min,max:this.props.color_temp_max,value:this.state.color_temp}),this.render_color_temp_presets())}render_color_temp_presets(){if(!this.props.color_temp_presets||this.props.color_temp_presets.length==0){return""}var presets=[];for(const p of this.props.color_temp_presets){presets.push(React.createElement("option",{key:`${this.props.name}_option_color_temp_preset_${p.name}`,value:p.value},p.name))}return React.createElement("select",{onChange:evnt=>this.changeColorTemp(evnt.target.value),key:`${this.props.name}_div_color_temp_presets`,value:""},presets)}render_rgb_picker(){if(!this.props.supports_rgb)return"";return React.createElement("div",{key:`${this.props.name}_div_color_picker`},React.createElement("label",null,"Lamp color"),React.createElement("input",{type:"color",onChange:evt=>this.changeRGB(evt.target.value),key:`${this.props.name}_light_rgb`,value:this.state.color_rgb}))}}class ThingsPane extends React.Component{static buildProps(local_storage,things,onResetOrder,onToggleReorder){return{key:"global_thing_list",things:things,local_storage:local_storage,onResetOrder:onResetOrder,onToggleReorder:onToggleReorder}}_getOrderedThings(props){let default_things_order=[];for(const elm of props.things){default_things_order.push(elm.props.name)}let cached_things_order=this.props.local_storage.get("ThingsPane.things_order",default_things_order);const set_existing_things=new Set(default_things_order);const set_cached_things_order=new Set(cached_things_order);let order_changed=false;for(const[idx,elm]of cached_things_order.entries()){if(!set_existing_things.has(elm)){delete cached_things_order[idx];order_changed=true}}cached_things_order=cached_things_order.filter(x=>x!=null);for(const elm of default_things_order){if(!set_cached_things_order.has(elm)){cached_things_order.push(elm);order_changed=true}}if(order_changed){this.props.local_storage.save("ThingsPane.things_order",cached_things_order)}return cached_things_order}static getDerivedStateFromProps(props,state){const things_lookup={};for(const elm of props.things){things_lookup[elm.props.name]=elm}return{things_lookup}}constructor(props){super(props);const things_lookup={};for(const elm of props.things){things_lookup[elm.props.name]=elm}this.state={things_lookup:things_lookup,things_order:this._getOrderedThings(props),reordering:false,showHiddenThings:false,visibleGroup:null}}toggleReordering(){this.setState({reordering:!this.state.reordering})}toggleShowHidden(){this.setState({showHiddenThings:!this.state.showHiddenThings})}reorder(idx,delta){if(idx+delta<0||idx+delta>=this.state.things_order.length){return}let new_order=this.state.things_order;const tmp=new_order[idx];new_order[idx]=new_order[idx+delta];new_order[idx+delta]=tmp;this.props.local_storage.save("ThingsPane.things_order",new_order);this.setState({things_order:new_order})}render(){if(this.state.reordering)return this.render_reordering();return React.createElement("div",{key:"global_thing_list_pane"},this._buildList())}_buildList(){const groupedThingList=new Map;groupedThingList.set(null,[]);let current_group=null;for(const thing_name of this.state.things_order){const thing=this.state.things_lookup[thing_name];let group=null;if(thing.props.user_defined)group=thing.props.user_defined.ui_group;if(group===undefined)group=null;if(group!=current_group){current_group=group;if(!groupedThingList.has(current_group)){groupedThingList.set(current_group,[])}}const ui_hide=thing.props.user_defined&&thing.props.user_defined.ui_hide;const classNames=!this.state.showHiddenThings&&ui_hide?"is-hidden":"";groupedThingList.get(current_group).push(React.createElement("li",{className:classNames,key:`${thing.props.name}_thing_li`},thing))}const groupList=[];const visibleGroup=(()=>{if(this.state.visibleGroup)return this.state.visibleGroup;const groups=Array.from(groupedThingList.entries());if(groups.length==0)return null;return groups[0][0]})();for(const e of groupedThingList.entries()){const group=e[0];if(!group)continue;const thinglist=e[1];const visible=!this.state.showHiddenThings&&group!=null&&group!=visibleGroup?"is-hidden":"";const expandGroupCtrl=React.createElement("div",{onClick:_=>this.setState({visibleGroup:group}),className:"is-full-width text-dark bd-primary is-small is-a-bit-rounded"},React.createElement("b",null,group));groupList.push(React.createElement("div",{className:"light-group-collapsed",key:`${group}_thing_pane_group`},expandGroupCtrl,React.createElement("ul",{className:visible,key:`${group}_thing_pane_group_ul`},thinglist)))}if(groupedThingList.get(null).length>0){groupList.push(React.createElement("div",{className:"light-group-expanded",key:`nullgroup_thing_pane_group`},React.createElement("ul",{key:`nullgroup_thing_pane_group_ul`},groupedThingList.get(null))))}return groupList}render_reordering(){const thing_list=this.state.things_order.map((thing_name,idx)=>{const thing=this.state.things_lookup[thing_name];const reorder_up=()=>{return idx==0?"\u25B2":React.createElement("a",{className:"thing-list-reorder-link",onClick:evnt=>this.reorder(idx,-1)},"\u25B2")};const reorder_down=()=>{return idx==this.state.things_order.length-1?"\u25BC":React.createElement("a",{className:"thing-list-reorder-link",onClick:evnt=>this.reorder(idx,+1)},"\u25BC")};return React.createElement("li",{key:`${thing.props.name}_thing_reorder_li`},React.createElement("div",{className:"thing_div row",key:`${thing.props.name}_reorder_div`},React.createElement("div",{className:"col-primary-action"},reorder_down(),reorder_up()),React.createElement("div",{className:"col-fixed-fill"},React.createElement("h3",null,thing.props.name))))});return React.createElement("div",{key:"global_thing_list_pane"},React.createElement("button",{onClick:()=>this.toggleReordering()},"Done"),React.createElement("ul",{key:"global_thing_list_ul"},thing_list))}}class MqttLights extends React.Component{static buildProps(api_base_path=""){return{key:"MqttLights",local_storage:new LocalStorageManager,api_base_path:api_base_path}}constructor(props){super(props);this.state={lights:null,thingsPaneKey:0,autoGrouping:props.local_storage.get("autoGrouping",true),configExpanded:false};this.thingsPaneRef=React.createRef()}analyzeGroups(lights){console.log("=== Starting group analysis ===");console.log("Light names:",lights.map(l=>l.meta.name));const extractPrefix=name=>{const capsWordMatch=name.match(/^([A-Z]{2,}[A-Z][a-z]+)/);if(capsWordMatch){console.log(`    extractPrefix("${name}") caps+word match: ${capsWordMatch[1]}`);return capsWordMatch[1]}const camelMatch=name.match(/^([A-Z][a-z]+)/);if(camelMatch){console.log(`    extractPrefix("${name}") camelCase match: ${camelMatch[1]}`);return camelMatch[1]}const fallbackMatch=name.match(/^([A-Za-z]+)/);const result=fallbackMatch?fallbackMatch[1]:null;console.log(`    extractPrefix("${name}") fallback: ${result}`);return result};const prefixCounts={};const nameToPrefixes={};for(const light of lights){const name=light.meta.name;const prefix=extractPrefix(name);console.log(`  ${name} -> prefix: ${prefix}`);if(prefix&&prefix.length>=3){prefixCounts[prefix]=(prefixCounts[prefix]||0)+1;nameToPrefixes[name]=prefix}}console.log("Prefix counts:",prefixCounts);const groups={};for(const light of lights){const name=light.meta.name;const prefix=nameToPrefixes[name];if(prefix&&prefixCounts[prefix]>=2){groups[name]=prefix;console.log(`  ${name} assigned to group: ${prefix}`)}else{groups[name]=null;console.log(`  ${name} not grouped (prefix: ${prefix}, count: ${prefixCounts[prefix]||0})`)}}console.log("Final groups:",groups);return groups}applyGrouping(lights,enabled){console.log(`=== applyGrouping called, enabled: ${enabled} ===`);if(!enabled){console.log("Removing all grouping");for(const light of lights){if(!light.meta.user_defined)light.meta.user_defined={};light.meta.user_defined.ui_group=undefined}return lights}const groups=this.analyzeGroups(lights);console.log("Applying grouping to lights...");for(const light of lights){if(!light.meta.user_defined)light.meta.user_defined={};light.meta.user_defined.ui_group=groups[light.meta.name];console.log(`  ${light.meta.name}.ui_group = ${light.meta.user_defined.ui_group}`)}console.log("=== Grouping applied ===");return lights}applyGroupingNow(){const newValue=!this.state.autoGrouping;this.props.local_storage.save("autoGrouping",newValue);this.setState({autoGrouping:newValue});this.props.local_storage.remove("things_meta");this.props.local_storage.remove("things_hash");this.props.local_storage.remove("ThingsPane.things_order");this.fetchLights()}resetOrder(){if(!this.state.lights)return;const sorted_lights=[...this.state.lights].sort((a,b)=>{var _a$meta$user_defined,_b$meta$user_defined;const groupA=((_a$meta$user_defined=a.meta.user_defined)===null||_a$meta$user_defined===void 0?void 0:_a$meta$user_defined.ui_group)||"";const groupB=((_b$meta$user_defined=b.meta.user_defined)===null||_b$meta$user_defined===void 0?void 0:_b$meta$user_defined.ui_group)||"";if(groupA&&groupB){if(groupA!==groupB){return groupA.localeCompare(groupB)}return a.meta.name.localeCompare(b.meta.name)}if(groupA&&!groupB)return-1;if(!groupA&&groupB)return 1;return a.meta.name.localeCompare(b.meta.name)});const sorted_names=sorted_lights.map(light=>light.meta.name);this.props.local_storage.save("ThingsPane.things_order",sorted_names);this.setState({thingsPaneKey:this.state.thingsPaneKey+1})}fetchLights(force_reload=false){mJsonGet(`${this.props.api_base_path}/z2m/get_known_things_hash`,server_hash=>{const cached_hash=this.props.local_storage.cacheGet("things_hash");const cached_meta=this.props.local_storage.cacheGet("things_meta");const hash_changed=cached_hash!==server_hash;mJsonGet(`${this.props.api_base_path}/get_lights`,async lights_list=>{if(hash_changed||!cached_meta){const lights_with_meta=await Promise.all(lights_list.map(light=>new Promise(resolve=>{mJsonGet(`${this.props.api_base_path}/z2m/meta/${light.thing_name}`,meta=>{resolve({state:light,meta:meta})})})));console.log("Applying grouping during fetch, autoGrouping:",this.state.autoGrouping);this.applyGrouping(lights_with_meta,this.state.autoGrouping);const meta_by_name={};for(const light of lights_with_meta){meta_by_name[light.state.thing_name]=light.meta}this.props.local_storage.cacheSave("things_meta",meta_by_name);this.props.local_storage.cacheSave("things_hash",server_hash);this.setState({lights:lights_with_meta})}else{const lights_with_meta=lights_list.map(light=>({state:light,meta:cached_meta[light.thing_name]}));this.setState({lights:lights_with_meta})}})})}async componentDidMount(){this.fetchLights()}on_app_became_visible(){this.fetchLights(true)}componentWillUnmount(){}fetchStats(){mJsonGet(`${this.props.api_base_path}/get_lights`,res=>{this.setState({lights:res})})}render(){if(!this.state.lights){return React.createElement("div",{className:"app-loading"},"Loading...")}console.log("=== MqttLights.render() ===");console.log("autoGrouping state:",this.state.autoGrouping);const sorted_lights=[...this.state.lights].sort((a,b)=>{var _a$meta$user_defined2,_b$meta$user_defined2;const groupA=((_a$meta$user_defined2=a.meta.user_defined)===null||_a$meta$user_defined2===void 0?void 0:_a$meta$user_defined2.ui_group)||"";const groupB=((_b$meta$user_defined2=b.meta.user_defined)===null||_b$meta$user_defined2===void 0?void 0:_b$meta$user_defined2.ui_group)||"";if(groupA&&groupB){if(groupA!==groupB){return groupA.localeCompare(groupB)}return a.meta.name.localeCompare(b.meta.name)}if(groupA&&!groupB)return-1;if(!groupA&&groupB)return 1;return a.meta.name.localeCompare(b.meta.name)});const light_components=sorted_lights.map(light=>{const props=Light.buildProps(light.meta,light.state,this.props.api_base_path);return React.createElement(Light,props)});const thingsPaneProps=ThingsPane.buildProps(this.props.local_storage,light_components,()=>this.resetOrder(),()=>this.thingsPaneRef.current&&this.thingsPaneRef.current.toggleReordering());thingsPaneProps.key=`ThingsPane_${this.state.thingsPaneKey}`;thingsPaneProps.ref=this.thingsPaneRef;const thingsPane=React.createElement(ThingsPane,thingsPaneProps);return React.createElement("div",null,thingsPane,React.createElement("div",{className:"config-section"},React.createElement("div",{className:"config-toggle",onClick:()=>this.setState({configExpanded:!this.state.configExpanded})},"Config ",this.state.configExpanded?"\u25B2":"\u25BC"),this.state.configExpanded&&React.createElement("div",{className:"config-panel"},React.createElement("button",{className:"modal-button",onClick:()=>this.thingsPaneRef.current&&this.thingsPaneRef.current.toggleReordering()},"Reorder"),React.createElement("button",{className:"modal-button",onClick:()=>this.resetOrder()},"Reset order"),React.createElement("button",{className:"modal-button",onClick:()=>this.fetchLights(true)},"Refresh things"),React.createElement("button",{className:"modal-button",onClick:()=>this.applyGroupingNow()},this.state.autoGrouping?"Disable grouping":"Enable grouping"))))}}
