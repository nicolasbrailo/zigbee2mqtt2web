"use strict";class DebouncedRange extends React.Component{constructor(props){super(props);props.min.this_is_a_required_prop;props.max.this_is_a_required_prop;props.value.this_is_a_required_prop;const val=props.value?props.value:props.min;this.state={changing:false,value:val}}UNSAFE_componentWillReceiveProps(next_props){const val=next_props&&next_props.value?next_props.value:0;this.setState({value:val})}onChange(value){this.setState({value:value})}onMouseUp(_){this.setState({changing:false});this.props.onChange({target:{value:this.state.value}})}onMouseDown(_){this.setState({changing:true})}render(){return React.createElement("input",{type:"range",onChange:evnt=>this.onChange(evnt.target.value),onMouseUp:evnt=>{this.onMouseUp(evnt.target.value)},onMouseDown:evnt=>this.onMouseDown(evnt.target.value),onTouchStart:evnt=>this.onMouseDown(evnt.target.value),onTouchEnd:evnt=>this.onMouseUp(evnt.target.value),className:this.props.className,min:this.props.min,max:this.props.max,value:this.state.value})}}
"use strict";class Light extends React.Component{static buildProps(meta,state,api_base_path=""){var props={name:meta.name,description:meta.description,manufacturer:meta.manufacturer,model:meta.model,supports_brightness:false,brightness_min:0,brightness_max:0,supports_color_temp:false,color_temp_min:0,color_temp_max:0,color_temp_presets:[],supports_rgb:false,user_defined:meta.user_defined,api_base_path:api_base_path,current_state:state.state||false,current_brightness:state.brightness||0,current_color_temp:state.color_temp||0,current_color_rgb:state.color_rgb||""};for(const action_name of Object.keys(meta.actions)){var desc=meta.actions[action_name].value.meta;if(!desc)desc={};if(action_name=="brightness"){props.supports_brightness=true;props.brightness_min=desc.value_min;props.brightness_max=desc.value_max}else if(action_name=="color_temp"){props.supports_color_temp=true;props.color_temp_min=desc.value_min;props.color_temp_max=desc.value_max;props.color_temp_presets=desc.presets}else if(action_name=="color_rgb"){props.supports_rgb=true}}props.has_extra_details=props.supports_color_temp||props.supports_rgb;return props}constructor(props){super(props);this.state={state:props.current_state,brightness:props.current_brightness||props.brightness_min,color_temp:props.current_color_temp||props.color_temp_min,color_rgb:props.current_color_rgb||"",details_shown:false}}componentDidUpdate(prevProps){if(prevProps.current_state!==this.props.current_state||prevProps.current_brightness!==this.props.current_brightness||prevProps.current_color_temp!==this.props.current_color_temp||prevProps.current_color_rgb!==this.props.current_color_rgb){this.setState({state:this.props.current_state,brightness:this.props.current_brightness||this.props.brightness_min,color_temp:this.props.current_color_temp||this.props.color_temp_min,color_rgb:this.props.current_color_rgb||""})}}setLightOn(v){this.setState({state:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`state=${v}`)}changeBrightness(v){if(v==0){this.setState({brightness:0,state:false})}else{this.setState({brightness:v,state:true})}mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`brightness=${v}`)}changeColorTemp(v){this.setState({color_temp:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`color_temp=${v}`)}toggleDetailsPanel(){this.setState({details_shown:!this.state.details_shown})}changeRGB(v){this.setState({color_rgb:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.name}`,`color_rgb=${v}`)}render(){return React.createElement("div",{className:"thing_div",key:`${this.props.name}_light_div`},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-primary-action"},React.createElement("input",{type:"checkbox",checked:this.state.state,value:this.state.state,onChange:evnt=>this.setLightOn(evnt.target.checked),key:`${this.props.name}_light_is_on`})),React.createElement("div",{className:"col-fixed-fill thing-no-linebreak"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-fixed-fill"},React.createElement("label",{className:"thing_name",htmlFor:`${this.props.name}_light_is_on`},this.props.name)),this.render_details_toggle()),React.createElement("div",{className:"row"},this.render_brightness_select()))),this.render_details_panel())}render_details_toggle(){if(!this.props.has_extra_details)return"";return React.createElement("div",{key:`${this.props.name}_light_details_panel_toggle_div`,className:"toggle-details-panel"},this.render_details_toggle_link())}render_details_toggle_link(){if(!this.state.details_shown){return React.createElement("a",{key:`${this.props.name}_light_details_panel_toggle`,onClick:evnt=>this.toggleDetailsPanel()},"\u25BC")}return React.createElement("a",{key:`${this.props.name}_light_details_panel_toggle`,onClick:evnt=>this.toggleDetailsPanel()},"\u25B2")}render_details_panel(){if(!this.props.has_extra_details)return"";if(!this.state.details_shown)return"";return React.createElement("div",{className:"card modal"},[this.render_rgb_picker(),this.render_color_temp()])}render_brightness_select(){if(!this.props.supports_brightness)return"";return React.createElement(DebouncedRange,{onChange:evnt=>this.changeBrightness(evnt.target.value),key:`${this.props.name}_light_brightness_slider`,min:this.props.brightness_min,max:this.props.brightness_max,value:this.state.brightness})}render_color_temp(){if(!this.props.supports_color_temp)return"";return React.createElement("div",{key:`${this.props.name}_div_color_temp`},React.createElement("label",null,"Temperature"),React.createElement(DebouncedRange,{onChange:evnt=>this.changeColorTemp(evnt.target.value),key:`${this.props.name}_light_color_temp`,min:this.props.color_temp_min,max:this.props.color_temp_max,value:this.state.color_temp}),this.render_color_temp_presets())}render_color_temp_presets(){if(!this.props.color_temp_presets||this.props.color_temp_presets.length==0){return""}var presets=[];for(const p of this.props.color_temp_presets){presets.push(React.createElement("option",{key:`${this.props.name}_option_color_temp_preset_${p.name}`,value:p.value},p.name))}return React.createElement("select",{onChange:evnt=>this.changeColorTemp(evnt.target.value),key:`${this.props.name}_div_color_temp_presets`,value:""},presets)}render_rgb_picker(){if(!this.props.supports_rgb)return"";return React.createElement("div",{key:`${this.props.name}_div_color_picker`},React.createElement("label",null,"Lamp color"),React.createElement("input",{type:"color",onChange:evt=>this.changeRGB(evt.target.value),key:`${this.props.name}_light_rgb`,value:this.state.color_rgb}))}}
"use strict";class ThingsPane extends React.Component{static buildProps(local_storage,things,onResetOrder,onToggleReorder){return{key:"global_thing_list",things:things,local_storage:local_storage,onResetOrder:onResetOrder,onToggleReorder:onToggleReorder}}_getOrderedThings(props){let default_things_order=[];for(const elm of props.things){default_things_order.push(elm.props.name)}let cached_things_order=this.props.local_storage.get("ThingsPane.things_order",default_things_order);const set_existing_things=new Set(default_things_order);const set_cached_things_order=new Set(cached_things_order);let order_changed=false;for(const[idx,elm]of cached_things_order.entries()){if(!set_existing_things.has(elm)){delete cached_things_order[idx];order_changed=true}}cached_things_order=cached_things_order.filter(x=>x!=null);for(const elm of default_things_order){if(!set_cached_things_order.has(elm)){cached_things_order.push(elm);order_changed=true}}if(order_changed){this.props.local_storage.save("ThingsPane.things_order",cached_things_order)}return cached_things_order}static getDerivedStateFromProps(props,state){const things_lookup={};for(const elm of props.things){things_lookup[elm.props.name]=elm}return{things_lookup}}constructor(props){super(props);const things_lookup={};for(const elm of props.things){things_lookup[elm.props.name]=elm}this.state={things_lookup:things_lookup,things_order:this._getOrderedThings(props),reordering:false,showHiddenThings:false,visibleGroup:null}}toggleReordering(){this.setState({reordering:!this.state.reordering})}toggleShowHidden(){this.setState({showHiddenThings:!this.state.showHiddenThings})}reorder(idx,delta){if(idx+delta<0||idx+delta>=this.state.things_order.length){return}let new_order=this.state.things_order;const tmp=new_order[idx];new_order[idx]=new_order[idx+delta];new_order[idx+delta]=tmp;this.props.local_storage.save("ThingsPane.things_order",new_order);this.setState({things_order:new_order})}render(){if(this.state.reordering)return this.render_reordering();return React.createElement("div",{key:"global_thing_list_pane"},this._buildList())}_buildList(){const groupedThingList=new Map;groupedThingList.set(null,[]);let current_group=null;for(const thing_name of this.state.things_order){const thing=this.state.things_lookup[thing_name];let group=null;if(thing.props.user_defined)group=thing.props.user_defined.ui_group;if(group===undefined)group=null;if(group!=current_group){current_group=group;if(!groupedThingList.has(current_group)){groupedThingList.set(current_group,[])}}const ui_hide=thing.props.user_defined&&thing.props.user_defined.ui_hide;const classNames=!this.state.showHiddenThings&&ui_hide?"is-hidden":"";groupedThingList.get(current_group).push(React.createElement("li",{className:classNames,key:`${thing.props.name}_thing_li`},thing))}const groupList=[];const visibleGroup=(()=>{if(this.state.visibleGroup)return this.state.visibleGroup;const groups=Array.from(groupedThingList.entries());if(groups.length==0)return null;return groups[0][0]})();for(const e of groupedThingList.entries()){const group=e[0];if(!group)continue;const thinglist=e[1];const visible=!this.state.showHiddenThings&&group!=null&&group!=visibleGroup?"is-hidden":"";const expandGroupCtrl=React.createElement("div",{onClick:_=>this.setState({visibleGroup:group}),className:"is-full-width text-dark bd-primary is-small is-a-bit-rounded"},React.createElement("b",null,group));groupList.push(React.createElement("div",{className:"light-group-collapsed",key:`${group}_thing_pane_group`},expandGroupCtrl,React.createElement("ul",{className:visible,key:`${group}_thing_pane_group_ul`},thinglist)))}if(groupedThingList.get(null).length>0){groupList.push(React.createElement("div",{className:"light-group-expanded",key:`nullgroup_thing_pane_group`},React.createElement("ul",{key:`nullgroup_thing_pane_group_ul`},groupedThingList.get(null))))}return groupList}render_reordering(){const thing_list=this.state.things_order.map((thing_name,idx)=>{const thing=this.state.things_lookup[thing_name];const reorder_up=()=>{return idx==0?"\u25B2":React.createElement("a",{className:"thing-list-reorder-link",onClick:evnt=>this.reorder(idx,-1)},"\u25B2")};const reorder_down=()=>{return idx==this.state.things_order.length-1?"\u25BC":React.createElement("a",{className:"thing-list-reorder-link",onClick:evnt=>this.reorder(idx,+1)},"\u25BC")};return React.createElement("li",{key:`${thing.props.name}_thing_reorder_li`},React.createElement("div",{className:"thing_div row",key:`${thing.props.name}_reorder_div`},React.createElement("div",{className:"col-primary-action"},reorder_down(),reorder_up()),React.createElement("div",{className:"col-fixed-fill"},React.createElement("h3",null,thing.props.name))))});return React.createElement("div",{key:"global_thing_list_pane"},React.createElement("button",{onClick:()=>this.toggleReordering()},"Done"),React.createElement("ul",{key:"global_thing_list_ul"},thing_list))}}class MqttLights extends React.Component{static buildProps(api_base_path=""){return{key:"MqttLights",local_storage:new LocalStorageManager,api_base_path:api_base_path}}constructor(props){super(props);this.state={lights:null,thingsPaneKey:0,autoGrouping:props.local_storage.get("autoGrouping",true),configExpanded:false};this.thingsPaneRef=React.createRef()}analyzeGroups(lights){console.log("=== Starting group analysis ===");console.log("Light names:",lights.map(l=>l.meta.name));const extractPrefix=name=>{const capsWordMatch=name.match(/^([A-Z]{2,}[A-Z][a-z]+)/);if(capsWordMatch){console.log(`    extractPrefix("${name}") caps+word match: ${capsWordMatch[1]}`);return capsWordMatch[1]}const camelMatch=name.match(/^([A-Z][a-z]+)/);if(camelMatch){console.log(`    extractPrefix("${name}") camelCase match: ${camelMatch[1]}`);return camelMatch[1]}const fallbackMatch=name.match(/^([A-Za-z]+)/);const result=fallbackMatch?fallbackMatch[1]:null;console.log(`    extractPrefix("${name}") fallback: ${result}`);return result};const prefixCounts={};const nameToPrefixes={};for(const light of lights){const name=light.meta.name;const prefix=extractPrefix(name);console.log(`  ${name} -> prefix: ${prefix}`);if(prefix&&prefix.length>=3){prefixCounts[prefix]=(prefixCounts[prefix]||0)+1;nameToPrefixes[name]=prefix}}console.log("Prefix counts:",prefixCounts);const groups={};for(const light of lights){const name=light.meta.name;const prefix=nameToPrefixes[name];if(prefix&&prefixCounts[prefix]>=2){groups[name]=prefix;console.log(`  ${name} assigned to group: ${prefix}`)}else{groups[name]=null;console.log(`  ${name} not grouped (prefix: ${prefix}, count: ${prefixCounts[prefix]||0})`)}}console.log("Final groups:",groups);return groups}applyGrouping(lights,enabled){console.log(`=== applyGrouping called, enabled: ${enabled} ===`);if(!enabled){console.log("Removing all grouping");for(const light of lights){if(!light.meta.user_defined)light.meta.user_defined={};light.meta.user_defined.ui_group=undefined}return lights}const groups=this.analyzeGroups(lights);console.log("Applying grouping to lights...");for(const light of lights){if(!light.meta.user_defined)light.meta.user_defined={};light.meta.user_defined.ui_group=groups[light.meta.name];console.log(`  ${light.meta.name}.ui_group = ${light.meta.user_defined.ui_group}`)}console.log("=== Grouping applied ===");return lights}applyGroupingNow(){const newValue=!this.state.autoGrouping;this.props.local_storage.save("autoGrouping",newValue);this.setState({autoGrouping:newValue});this.props.local_storage.remove("things_meta");this.props.local_storage.remove("things_hash");this.props.local_storage.remove("ThingsPane.things_order");this.fetchLights()}resetOrder(){if(!this.state.lights)return;const sorted_lights=[...this.state.lights].sort((a,b)=>{var _a$meta$user_defined,_b$meta$user_defined;const groupA=((_a$meta$user_defined=a.meta.user_defined)===null||_a$meta$user_defined===void 0?void 0:_a$meta$user_defined.ui_group)||"";const groupB=((_b$meta$user_defined=b.meta.user_defined)===null||_b$meta$user_defined===void 0?void 0:_b$meta$user_defined.ui_group)||"";if(groupA&&groupB){if(groupA!==groupB){return groupA.localeCompare(groupB)}return a.meta.name.localeCompare(b.meta.name)}if(groupA&&!groupB)return-1;if(!groupA&&groupB)return 1;return a.meta.name.localeCompare(b.meta.name)});const sorted_names=sorted_lights.map(light=>light.meta.name);this.props.local_storage.save("ThingsPane.things_order",sorted_names);this.setState({thingsPaneKey:this.state.thingsPaneKey+1})}fetchLights(force_reload=false){mJsonGet(`${this.props.api_base_path}/z2m/get_known_things_hash`,server_hash=>{const cached_hash=this.props.local_storage.cacheGet("things_hash");const cached_meta=this.props.local_storage.cacheGet("things_meta");const hash_changed=cached_hash!==server_hash;mJsonGet(`${this.props.api_base_path}/get_lights`,async lights_list=>{if(hash_changed||!cached_meta){const lights_with_meta=await Promise.all(lights_list.map(light=>new Promise(resolve=>{mJsonGet(`${this.props.api_base_path}/z2m/meta/${light.thing_name}`,meta=>{resolve({state:light,meta:meta})})})));console.log("Applying grouping during fetch, autoGrouping:",this.state.autoGrouping);this.applyGrouping(lights_with_meta,this.state.autoGrouping);const meta_by_name={};for(const light of lights_with_meta){meta_by_name[light.state.thing_name]=light.meta}this.props.local_storage.cacheSave("things_meta",meta_by_name);this.props.local_storage.cacheSave("things_hash",server_hash);this.setState({lights:lights_with_meta})}else{const lights_with_meta=lights_list.map(light=>({state:light,meta:cached_meta[light.thing_name]}));this.setState({lights:lights_with_meta})}})})}async componentDidMount(){this.fetchLights()}on_app_became_visible(){this.fetchLights(true)}componentWillUnmount(){}fetchStats(){mJsonGet(`${this.props.api_base_path}/get_lights`,res=>{this.setState({lights:res})})}render(){if(!this.state.lights){return React.createElement("div",{className:"app-loading"},"Loading...")}console.log("=== MqttLights.render() ===");console.log("autoGrouping state:",this.state.autoGrouping);const sorted_lights=[...this.state.lights].sort((a,b)=>{var _a$meta$user_defined2,_b$meta$user_defined2;const groupA=((_a$meta$user_defined2=a.meta.user_defined)===null||_a$meta$user_defined2===void 0?void 0:_a$meta$user_defined2.ui_group)||"";const groupB=((_b$meta$user_defined2=b.meta.user_defined)===null||_b$meta$user_defined2===void 0?void 0:_b$meta$user_defined2.ui_group)||"";if(groupA&&groupB){if(groupA!==groupB){return groupA.localeCompare(groupB)}return a.meta.name.localeCompare(b.meta.name)}if(groupA&&!groupB)return-1;if(!groupA&&groupB)return 1;return a.meta.name.localeCompare(b.meta.name)});const light_components=sorted_lights.map(light=>{const props=Light.buildProps(light.meta,light.state,this.props.api_base_path);return React.createElement(Light,props)});const thingsPaneProps=ThingsPane.buildProps(this.props.local_storage,light_components,()=>this.resetOrder(),()=>this.thingsPaneRef.current&&this.thingsPaneRef.current.toggleReordering());thingsPaneProps.key=`ThingsPane_${this.state.thingsPaneKey}`;thingsPaneProps.ref=this.thingsPaneRef;const thingsPane=React.createElement(ThingsPane,thingsPaneProps);return React.createElement("div",null,thingsPane,React.createElement("div",{className:"config-section"},React.createElement("div",{className:"config-toggle",onClick:()=>this.setState({configExpanded:!this.state.configExpanded})},"Config ",this.state.configExpanded?"\u25B2":"\u25BC"),this.state.configExpanded&&React.createElement("div",{className:"config-panel"},React.createElement("button",{className:"modal-button",onClick:()=>this.thingsPaneRef.current&&this.thingsPaneRef.current.toggleReordering()},"Reorder"),React.createElement("button",{className:"modal-button",onClick:()=>this.resetOrder()},"Reset order"),React.createElement("button",{className:"modal-button",onClick:()=>this.fetchLights(true)},"Refresh things"),React.createElement("button",{className:"modal-button",onClick:()=>this.applyGroupingNow()},this.state.autoGrouping?"Disable grouping":"Enable grouping"))))}}
"use strict";class TTSAnnounce extends React.Component{static buildProps(api_base_path=""){return{key:"tts_announce",api_base_path:api_base_path}}constructor(props){super(props);this.canRecordMic=window.location.protocol==="https:";this.state={ttsPhrase:"",ttsLang:"es-ES",isRecording:false,speakerList:null,announcementHistory:[],historyExpanded:false};this.recorderRef=React.createRef();this.onTTSRequested=this.onTTSRequested.bind(this);this.onMicRecRequested=this.onMicRecRequested.bind(this);this.onMicRecSend=this.onMicRecSend.bind(this);this.onCancel=this.onCancel.bind(this);this.fetchAnnouncementHistory=this.fetchAnnouncementHistory.bind(this)}componentDidMount(){this.on_app_became_visible()}on_app_became_visible(){mJsonGet(`${this.props.api_base_path}/ls_speakers`,data=>this.setState({speakerList:data}));this.fetchAnnouncementHistory()}fetchAnnouncementHistory(){mJsonGet(`${this.props.api_base_path}/announcement_history`,data=>this.setState({announcementHistory:data}))}onTTSRequested(){const phrase=this.state.ttsPhrase.trim()||prompt("What is so important?");if(!phrase)return;this.setState({ttsPhrase:phrase});console.log(`announce {"lang": "${this.state.ttsLang}", "phrase": "${phrase}"}`);const newEntry={timestamp:new Date().toISOString(),phrase:phrase,lang:this.state.ttsLang,volume:"default",uri:`${this.props.api_base_path}/tts/${phrase}_${this.state.ttsLang}.mp3`};this.setState(prev=>({announcementHistory:[...prev.announcementHistory,newEntry].slice(-10)}));console.log("BCAST ");console.log(`${this.props.api_base_path}/announce_tts?lang=${this.state.ttsLang}&phrase=${phrase}`);mAjax({url:`${this.props.api_base_path}/announce_tts?lang=${this.state.ttsLang}&phrase=${phrase}`,type:"get",success:()=>{console.log("Sent TTS request");this.fetchAnnouncementHistory()},error:showGlobalError})}async onMicRecRequested(){if(!this.canRecordMic){showGlobalError("Mic recording only works on https pages");return}if(!navigator.mediaDevices){showGlobalError("Your browser does not support microphone recording");return}try{const stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});const rec=new MediaRecorder(stream);rec.chunks=[];rec.ondataavailable=e=>rec.chunks.push(e.data);this.recorderRef.current=rec;rec.start();this.setState({isRecording:true})}catch(err){showGlobalError("Mic error: "+err)}}onMicRecSend(){const rec=this.recorderRef.current;if(!rec){showGlobalError("No microphone recording in progress");return}rec.onstop=()=>{const blob=new Blob(rec.chunks,{type:"audio/ogg; codecs=opus"});const form=new FormData;form.append("audio_data",blob,"mic_cap.ogg");mAjax({url:`${this.props.api_base_path}/announce_user_recording`,data:form,cache:false,contentType:false,processData:false,method:"POST",success:()=>console.log("Sent user recording"),error:showGlobalError});rec.stream.getTracks().forEach(t=>t.stop());this.recorderRef.current=null;this.setState({isRecording:false})};rec.stop()}onCancel(){const rec=this.recorderRef.current;if(rec){rec.stream.getTracks().forEach(t=>t.stop());this.recorderRef.current=null}this.setState({isRecording:false})}render(){if(this.state.isRecording){return React.createElement("ul",{className:"player-announce-methods"},React.createElement("li",null,React.createElement("button",{className:"player-button",onClick:this.onMicRecSend},"Send")),React.createElement("li",null,React.createElement("button",{className:"player-button",onClick:this.onCancel},"Cancel")))}return React.createElement("div",{className:"announce-container"},React.createElement("div",{className:"announce-input-div"},React.createElement("input",{type:"text",placeholder:"Text to announce",value:this.state.ttsPhrase,onChange:e=>this.setState({ttsPhrase:e.target.value})})),React.createElement("div",{className:"announce-ctrls-div"},React.createElement("button",{onClick:this.onTTSRequested},"Announce!"),React.createElement("select",{value:this.state.ttsLang,onChange:e=>this.setState({ttsLang:e.target.value})},React.createElement("option",{value:"es-ES"},"ES"),React.createElement("option",{value:"es-419"},"es 419"),React.createElement("option",{value:"en-GB"},"EN GB")),this.canRecordMic&&React.createElement("button",{onClick:this.onMicRecRequested},"Record")),this.state.speakerList&&React.createElement("div",{className:"announce-speaker-list"},"Will announce in: ",React.createElement("ul",null,this.state.speakerList.map(x=>React.createElement("li",{key:x},x)))),React.createElement("div",{className:"announce-history-section"},React.createElement("small",{onClick:()=>this.setState({historyExpanded:!this.state.historyExpanded}),style:{cursor:"pointer",userSelect:"none"}},this.state.historyExpanded?"\u25BC":"\u25B6"," Announcement History (",this.state.announcementHistory.length,")"),this.state.historyExpanded&&React.createElement("div",{className:"announce-history-list card"},this.state.announcementHistory.length===0?React.createElement("p",null,"No announcements yet"):React.createElement("ul",null,this.state.announcementHistory.slice().reverse().map((item,idx)=>React.createElement("li",{key:idx},React.createElement("div",{className:"history-item"},React.createElement("span",{className:"history-timestamp"},new Date(item.timestamp).toLocaleString()),React.createElement("span",{className:"history-phrase"},"\"",item.phrase,"\""),React.createElement("span",{className:"history-details"},"(Lang: ",item.lang,", vol: ",item.volume,", ",React.createElement("a",{href:item.uri},"link"),")"))))))))}}
"use strict";class ContactMonitor extends React.Component{static buildProps(api_base_path=""){return{key:"ContactMonitor",api_base_path:api_base_path}}constructor(props){super(props);this.state={svc_state:null,expandedHistory:{}};this.skipChimeReq=this.skipChimeReq.bind(this);this.enableChimeReq=this.enableChimeReq.bind(this);this.fetchServiceState=this.fetchServiceState.bind(this);this.toggleHistory=this.toggleHistory.bind(this);this.timer=null}async componentDidMount(){this.fetchServiceState()}on_app_became_visible(){this.fetchServiceState()}componentDidUpdate(prevProps,prevState){var _prevState$svc_state,_this$state$svc_state;const prevSkip=(_prevState$svc_state=prevState.svc_state)===null||_prevState$svc_state===void 0?void 0:_prevState$svc_state.skipping_chimes;const currSkip=(_this$state$svc_state=this.state.svc_state)===null||_this$state$svc_state===void 0?void 0:_this$state$svc_state.skipping_chimes;if(!prevSkip&&currSkip){this.startSkipTimer()}}startSkipTimer(){if(this.timer)clearInterval(this.timer);this.timer=setInterval(()=>{this.setState(state=>{const timeout=state.svc_state.skipping_chime_timeout-1;if(timeout<=0){clearInterval(this.timer);this.timer=null;this.fetchServiceState();return{svc_state:{...state.svc_state,skipping_chimes:false,skipping_chime_timeout:0}}}return{svc_state:{...state.svc_state,skipping_chime_timeout:timeout}}})},1000)}componentWillUnmount(){if(this.timer){clearInterval(this.timer)}}fetchServiceState(){mJsonGet(`${this.props.api_base_path}/svc_state`,res=>{this.setState({svc_state:{...res,skipping_chime_timeout:res.skipping_chimes_timeout_secs}})})}skipChimeReq(){mJsonGet(`${this.props.api_base_path}/skip_chimes`,res=>{this.setState(state=>({svc_state:{...state.svc_state,skipping_chimes:true,skipping_chime_timeout:Number(res.timeout)}}))})}enableChimeReq(){mJsonGet(`${this.props.api_base_path}/enable_chimes`,res=>{this.fetchServiceState()})}toggleHistory(sensorName){this.setState(state=>({expandedHistory:{...state.expandedHistory,[sensorName]:!state.expandedHistory[sensorName]}}))}formatTime(seconds){if(seconds<60){return`${Math.round(seconds)}s`}const minutes=Math.floor(seconds/60);if(minutes<60){const secs=Math.round(seconds%60);return`${minutes}m ${secs}s`}const hours=Math.floor(minutes/60);if(hours<24){const mins=minutes%60;return`${hours}h ${mins}m`}const days=Math.floor(hours/24);if(days<7){const hrs=hours%24;return`${days}d ${hrs}h`}const weeks=Math.floor(days/7);const remainingDays=days%7;return`${weeks}w ${remainingDays}d`}render(){if(!this.state.svc_state){return React.createElement("div",{className:"app-loading"},"Loading...")}const hasTimeouts=this.state.svc_state.timeout_sensors&&this.state.svc_state.timeout_sensors.length>0;const hasCurfews=this.state.svc_state.curfew_sensors&&this.state.svc_state.curfew_sensors.length>0;const sensors=this.state.svc_state.sensors||{};const sensorNames=Object.keys(sensors).sort();return React.createElement("div",{id:"ContactMonitorContainer"},this.state.svc_state.skipping_chimes&&React.createElement("div",{className:"bd-error bg-dark text-center"},"Will skip chimes for the next ",Math.round(this.state.svc_state.skipping_chime_timeout)," seconds"),this.state.svc_state.skipping_chimes?React.createElement("button",{type:"button",onClick:this.enableChimeReq},"Enable chimes"):React.createElement("button",{type:"button",onClick:this.skipChimeReq},"Skip next chime"),hasTimeouts&&React.createElement("div",{style:{marginTop:"20px",padding:"10px",backgroundColor:"#fff3cd",border:"1px solid #ffc107",borderRadius:"4px"}},React.createElement("h4",{style:{margin:"0 0 10px 0"}},"\u23F0 Pending Timeouts"),React.createElement("ul",{style:{margin:0}},this.state.svc_state.timeout_sensors.map((timeout,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,timeout.sensor)," - will timeout in ",this.formatTime(timeout.seconds_remaining))))),hasCurfews&&React.createElement("div",{style:{marginTop:"20px",padding:"10px",backgroundColor:"#d1ecf1",border:"1px solid #0c5460",borderRadius:"4px"}},React.createElement("h4",{style:{margin:"0 0 10px 0"}},"\uD83C\uDF19 Scheduled Curfew Alerts"),React.createElement("ul",{style:{margin:0}},this.state.svc_state.curfew_sensors.map((curfew,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,curfew.sensor)," - will trigger in ",this.formatTime(curfew.seconds_until_trigger))))),React.createElement("ul",null,sensorNames.map(sensorName=>this.renderSensor(sensorName,sensors[sensorName]))))}formatDuration(startTime,endTime){const start=new Date(startTime);const end=endTime?new Date(endTime):new Date;const durationSecs=(end-start)/1000;return this.formatTime(durationSecs)}renderHistory(sensorName,history){var _this$state$svc_state2;if(!history||history.length===0){return null}const sortedHistory=[...history].sort((a,b)=>{const timeA=a.changed?new Date(a.changed).getTime():0;const timeB=b.changed?new Date(b.changed).getTime():0;return timeB-timeA});const currentSensor=(_this$state$svc_state2=this.state.svc_state.sensors)===null||_this$state$svc_state2===void 0?void 0:_this$state$svc_state2[sensorName];return React.createElement("div",{style:{marginLeft:"20px",marginTop:"10px",fontSize:"0.85em",padding:"10px",borderRadius:"4px",border:"1px solid #444"}},React.createElement("div",{style:{fontWeight:"bold",marginBottom:"5px"}},"History (last ",sortedHistory.length," events):"),React.createElement("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"0.95em"}},React.createElement("thead",null,React.createElement("tr",{style:{borderBottom:"1px solid #555"}},React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Contact"),React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Action"),React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Changed"),React.createElement("th",{style:{textAlign:"left",padding:"4px"}},"Duration"))),React.createElement("tbody",null,sortedHistory.map((event,idx)=>{const contact=event.contact===true?"closed":event.contact===false?"open":"unknown";const action=event.action||"unknown";const changedDate=event.changed?new Date(event.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";const isOpen=event.contact===false;let duration="";const isFirstItem=idx===0;const isCurrentState=currentSensor&&currentSensor.contact===event.contact&&currentSensor.action===event.action;if(isFirstItem&&isCurrentState){duration="current"}else if(changedDate){let endDate;if(isFirstItem){endDate=new Date}else{const newerEvent=sortedHistory[idx-1];endDate=newerEvent&&newerEvent.changed?new Date(newerEvent.changed):new Date}const durationSecs=(endDate-changedDate)/1000;duration=this.formatTime(durationSecs)}return React.createElement("tr",{key:idx,className:isOpen?"text-error":"text-success",style:{borderBottom:"1px solid #333"}},React.createElement("td",{style:{padding:"4px"}},contact),React.createElement("td",{style:{padding:"4px"}},action),React.createElement("td",{style:{padding:"4px"}},changedStr),React.createElement("td",{style:{padding:"4px"}},duration))}))))}renderSensor(sensorName,sensor){var _this$state$svc_state3;let contact="";let displayText="";let isOpen=false;if(sensor.contact===true){contact="closed";const action=sensor.action||"unknown";displayText=`${contact} (${action})`;isOpen=false}else if(sensor.contact===false){contact="open";const action=sensor.action||"unknown";displayText=`${contact} (${action})`;isOpen=true}else{displayText="in unknown state (waiting for sensor report)";isOpen=false}const changedDate=sensor.changed?new Date(sensor.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";let durationStr="";if(changedDate){const now=new Date;const durationSecs=(now-changedDate)/1000;durationStr=this.formatTime(durationSecs)}const isExpanded=this.state.expandedHistory[sensorName];const history=((_this$state$svc_state3=this.state.svc_state.history)===null||_this$state$svc_state3===void 0?void 0:_this$state$svc_state3[sensorName])||[];return React.createElement("li",{key:sensorName},React.createElement("div",{className:isOpen?"bd-error":"",style:isOpen?{padding:"5px",marginBottom:"5px"}:{}},React.createElement("strong",null,sensorName),": ",displayText,changedDate&&React.createElement("span",{style:{fontSize:"0.9em",color:"#666",marginLeft:"10px"}},"- changed at ",changedStr," (",durationStr," ago)"),history.length>0&&React.createElement("span",{onClick:()=>this.toggleHistory(sensorName),style:{marginLeft:"10px",cursor:"pointer",color:"#4a9eff",textDecoration:"underline"}},"(history)")),isExpanded&&this.renderHistory(sensorName,history))}}
"use strict";class CamViewer extends React.Component{static buildProps(api_base_path="",svc_full_url=""){return{key:"cam_viewer",api_base_path,svc_full_url}}constructor(props){super(props);this.state={imageTimestamp:Date.now(),isLoading:false,isRecording:false};this.onSnapRequested=this.onSnapRequested.bind(this);this.onRecordRequested=this.onRecordRequested.bind(this)}on_app_became_visible(){}onSnapRequested(){this.setState({isLoading:true});mAjax({url:`${this.props.api_base_path}/snap`,type:"get",success:()=>{console.log("Snapshot captured");setTimeout(()=>{this.setState({imageTimestamp:Date.now(),isLoading:false})},500)},error:err=>{showGlobalError("Failed to capture snapshot: "+err);this.setState({isLoading:false})}})}onRecordRequested(){this.setState({isRecording:true});mAjax({url:`${this.props.api_base_path}/record?secs=20`,type:"get",success:response=>{console.log("Recording started for 20 seconds");setTimeout(()=>{this.setState({isRecording:false})},20000)},error:err=>{showGlobalError("Failed to start recording: "+err.response);this.setState({isRecording:false})}})}render(){return React.createElement("div",{className:"cam-container"},React.createElement("div",{className:"cam-controls"},React.createElement("button",{onClick:this.onSnapRequested,disabled:this.state.isLoading||this.state.isRecording,className:"snap-button"},this.state.isLoading?"Capturing...":"Take New Snapshot"),React.createElement("button",{onClick:this.onRecordRequested,disabled:this.state.isRecording||this.state.isLoading,className:"record-button"},this.state.isRecording?"Recording (20s)...":"Record Video (20s)"),React.createElement("a",{href:`${this.props.svc_full_url}/nvr`,className:"nvr-link"},"View Recordings")),React.createElement("div",{className:"cam-image-container"},React.createElement("img",{src:`${this.props.api_base_path}/lastsnap?t=${this.state.imageTimestamp}`,alt:"Last doorbell snap",className:"cam-image"})))}}
"use strict";function millisecToNextSlotChg(){const now=new Date;const qr=Math.floor(now.getMinutes()/15);const nxt_slot_chg_min=15*(qr+1)%60;const slot_chg=new Date;slot_chg.setMinutes(nxt_slot_chg_min);slot_chg.setSeconds(0);const ms_to_chg=slot_chg-now;if(nxt_slot_chg_min==0){return ms_to_chg+60*60*1000}return ms_to_chg}function renderScheduleTable(sched,slotGenerator){const qr_groupped_sched={};for(let hr=0;hr<24;++hr){qr_groupped_sched[hr]=sched.slice(hr*4,(hr+1)*4)}return React.createElement("table",{className:"heating_sched"},React.createElement("tbody",null,Object.keys(qr_groupped_sched).map(hour=>{return React.createElement("tr",{key:`table_schedule_${hour}`},qr_groupped_sched[hour].map(slot=>{const slot_t=`${("0"+slot.hour).slice(-2)}:${("0"+slot.minute).slice(-2)}`;const sched_slot_class=slot.request_on?"heating_sched_slotBoilerOn":"heating_sched_slotBoilerOff";return React.createElement("td",{key:`table_schedule_${slot.hour}_${slot.minute}`,className:sched_slot_class},slotGenerator(slot))}))})))}class HeatingControls extends React.Component{static buildProps(api_base_path="",state={}){const props={api_base_path:api_base_path};if(state.allow_on!==undefined)props.allow_on=state.allow_on;if(state.mqtt_thing_reports_on!==undefined)props.mqtt_thing_reports_on=state.mqtt_thing_reports_on;if(state.monitoring_sensors!==undefined)props.monitoring_sensors=state.monitoring_sensors;if(state.onRefresh!==undefined)props.onRefresh=state.onRefresh;return props}constructor(props){super(props);this._offNow=this._offNow.bind(this);this._refresh=this._refresh.bind(this);this.state={allow_on:props.allow_on||null,mqtt_thing_reports_on:props.mqtt_thing_reports_on||null,monitoring_sensors:props.monitoring_sensors||null}}componentDidMount(){if(!this.props.allow_on&&this.props.api_base_path){this._refresh()}}componentDidUpdate(prevProps){if(prevProps.allow_on!==this.props.allow_on||prevProps.mqtt_thing_reports_on!==this.props.mqtt_thing_reports_on||prevProps.monitoring_sensors!==this.props.monitoring_sensors){this.setState({allow_on:this.props.allow_on,mqtt_thing_reports_on:this.props.mqtt_thing_reports_on,monitoring_sensors:this.props.monitoring_sensors})}}_refresh(){if(this.props.api_base_path){mJsonGet(`${this.props.api_base_path}/svc_state`,state=>{this.setState({allow_on:state.allow_on,mqtt_thing_reports_on:state.mqtt_thing_reports_on,monitoring_sensors:state.monitoring_sensors});if(this.props.onRefresh){this.props.onRefresh()}})}}_mkBoost(hours){return()=>{mJsonGet(`${this.props.api_base_path}/boost=${hours}`,this._refresh)}}_offNow(){mJsonGet(`${this.props.api_base_path}/off_now`,this._refresh)}renderHeatingOverrides(){let policy_state="Boiler manager unknown state";if(this.state.allow_on=="Never"){policy_state="Boiler should be off"}else if(this.state.allow_on=="Always"){policy_state="Boiler should be on"}else if(this.state.allow_on=="Rule"){policy_state="Rule controls boiler state"}return React.createElement("div",{className:"card heating_cfg_ctrls"},React.createElement("div",null,"Current status: ",policy_state,", boiler reports ",this.state.mqtt_thing_reports_on),React.createElement("button",{className:"modal-button",onClick:this._mkBoost(1)},"Boost 1 hour"),React.createElement("button",{className:"modal-button",onClick:this._mkBoost(2)},"Boost 2 hours"),React.createElement("button",{className:"modal-button",onClick:this._offNow},"Off now"))}renderMonitoringSensors(){if(!this.state.monitoring_sensors){return null}return React.createElement("div",{className:"card heating_cfg_ctrls"},Object.entries(this.state.monitoring_sensors).map(([name,value])=>React.createElement("span",{key:name,className:"bd-dark modal-button"},name,": ",value||"?")))}render(){return React.createElement(React.Fragment,null,this.renderHeatingOverrides(),this.renderMonitoringSensors())}}class HeatingScheduleConfig extends React.Component{static buildProps(api_base_path="",onRefresh=null,onToggleConfig=null,state={},renderFunctions={}){return{api_base_path:api_base_path,onRefresh:onRefresh,onToggleConfig:onToggleConfig,configuring:state.configuring||false,active_schedule:state.active_schedule||null,schedule_template:state.schedule_template||null,renderSlot:renderFunctions.renderSlot||null,renderTemplateSlot:renderFunctions.renderTemplateSlot||null}}constructor(props){super(props);this._applyTemplate=this._applyTemplate.bind(this);this._resetTemplateAlwaysOff=this._resetTemplateAlwaysOff.bind(this);this._resetTemplateAlwaysRule=this._resetTemplateAlwaysRule.bind(this);this._showLogs=this._showLogs.bind(this)}_applyTemplate(){mJsonGet(`${this.props.api_base_path}/template_apply`,this.props.onRefresh)}_resetTemplateAlwaysOff(){mJsonGet(`${this.props.api_base_path}/template_reset=Never`,this.props.onRefresh)}_resetTemplateAlwaysRule(){mJsonGet(`${this.props.api_base_path}/template_reset=Rule`,this.props.onRefresh)}_showLogs(){window.open("/logs.html","_self")}renderConfig(){if(!this.props.schedule_template){return null}return React.createElement("div",null,this.renderTemplateControls(),renderScheduleTable(this.props.schedule_template,this.props.renderTemplateSlot))}renderState(){if(!this.props.active_schedule){return null}return React.createElement("div",null,renderScheduleTable(this.props.active_schedule,this.props.renderSlot),this.renderConfigControls())}renderConfigControls(){return React.createElement("div",{className:"card heating_cfg_ctrls"},React.createElement("button",{className:"modal-button",onClick:this.props.onToggleConfig},"Config"),React.createElement("button",{className:"modal-button",onClick:this._applyTemplate},"Reset today schedule"),React.createElement("button",{className:"modal-button",onClick:this._showLogs},"Logs"))}renderTemplateControls(){return React.createElement("div",{className:"card heating_cfg_ctrls"},React.createElement("button",{className:"modal-button",onClick:this.props.onToggleConfig},"Finish Config"),React.createElement("button",{className:"modal-button",onClick:this._applyTemplate},"Apply template / reset today schedule"),React.createElement("button",{className:"modal-button",onClick:this._resetTemplateAlwaysOff},"Reset template: Always off"),React.createElement("button",{className:"modal-button",onClick:this._resetTemplateAlwaysRule},"Reset template: Always rule-based"))}render(){return this.props.configuring?this.renderConfig():this.renderState()}}class MqttHeating extends React.Component{static buildProps(api_base_path=""){return{key:"HeatingPane",api_base_path:api_base_path}}constructor(props){super(props);this.refresh=this.refresh.bind(this);this._toggleConfig=this._toggleConfig.bind(this);this._renderSlot=this._renderSlot.bind(this);this._renderTemplateSlot=this._renderTemplateSlot.bind(this);const app_visibility=new VisibilityCallback;app_visibility.app_became_visible=this.refresh;this.state={configuring:false,active_schedule:null,schedule_template:null,allow_on:null,mqtt_thing_reports_on:null,monitoring_sensors:null,refreshId:null,app_visibility}}refresh(){if(this.state.refreshId){clearTimeout(this.state.refreshId)}if(this.state.configuring){console.log("Configuring: will refresh schedule");mJsonGet(`${this.props.api_base_path}/template_schedule`,tmpl_state=>{this.setState({schedule_template:tmpl_state.template})});return}console.log("Refreshing boiler state...");mJsonGet(`${this.props.api_base_path}/svc_state`,state=>{this.setState({active_schedule:state.active_schedule,allow_on:state.allow_on,mqtt_thing_reports_on:state.mqtt_thing_reports_on,monitoring_sensors:state.monitoring_sensors,refreshId:setInterval(this.refresh,millisecToNextSlotChg())})})}_toggleConfig(){this.setState({configuring:!this.state.configuring})}render(){return this.state.configuring?this.renderConfig():this.renderState()}renderConfig(){if(!this.state.schedule_template){this.refresh();return"Loading configuration..."}return React.createElement("div",null,React.createElement(HeatingScheduleConfig,{configuring:true,schedule_template:this.state.schedule_template,renderTemplateSlot:this._renderTemplateSlot,api_base_path:this.props.api_base_path,onRefresh:this.refresh,onToggleConfig:this._toggleConfig}))}renderState(){if(!this.state.active_schedule){this.refresh();return"Loading..."}return React.createElement("div",null,React.createElement(HeatingControls,{allow_on:this.state.allow_on,mqtt_thing_reports_on:this.state.mqtt_thing_reports_on,monitoring_sensors:this.state.monitoring_sensors,api_base_path:this.props.api_base_path,onRefresh:this.refresh}),React.createElement(HeatingScheduleConfig,{configuring:false,active_schedule:this.state.active_schedule,renderSlot:this._renderSlot,api_base_path:this.props.api_base_path,onRefresh:this.refresh,onToggleConfig:this._toggleConfig}))}_renderSlot(slot){const slot_name=`${("0"+slot.hour).slice(-2)}:${("0"+slot.minute).slice(-2)}`;const cb=()=>{console.log("User toggling slot",slot_name);mJsonGet(`${this.props.api_base_path}/slot_toggle=${slot_name}`,this.refresh)};let descr="Error";if(slot.allow_on=="Never"){descr=`Off: ${slot.reason}`}else if(slot.allow_on=="Always"){descr=`On: ${slot.reason}`}else if(slot.allow_on=="Rule"&&slot.request_on){descr=`On: Rule ${slot.reason}`}else if(slot.allow_on=="Rule"&&!slot.request_on){descr=`Off: Rule ${slot.reason}`}return React.createElement("button",{className:"modal-button",onClick:cb},slot_name,React.createElement("wbr",null)," ",descr)}_renderTemplateSlot(slot){const slot_name=`${("0"+slot.hour).slice(-2)}:${("0"+slot.minute).slice(-2)}`;const cb=evt=>{const selected=evt.nativeEvent.target.value;console.log("Uset setting template",slot_name,selected);mJsonGet(`${this.props.api_base_path}/template_slot_set=${slot.hour},${slot.minute},${selected}`,this.refresh)};return React.createElement("div",null,slot_name,React.createElement("wbr",null)," ",slot.reason,React.createElement("select",{key:"`table_schedule_${slot.hour}_${slot.minute}_opt`",defaultValue:slot.allow_on,onChange:cb},React.createElement("option",{value:"Always"},"Always on"),React.createElement("option",{value:"Never"},"Always off"),React.createElement("option",{value:"Rule"},"Follow rule")))}}
"use strict";const INTERESTING_PLOT_METRICS=["temperature","humidity","pm25","voc_index"];function simple_dygraph_plot(html_elm_id,url){let dygraph_opts={fillGraph:false,connectSeparatedPoints:true,highlightCircleSize:2,strokeWidth:1,width:window.innerWidth*.9,rollPeriod:5,legend:"always",highlightSeriesOpts:{strokeWidth:3,strokeBorderWidth:1,highlightCircleSize:5}};mAjax({url:url,cache:false,type:"get",dataType:"text",success:function(t_csv){const label_elm=document.getElementById(html_elm_id+"_label");if(label_elm){dygraph_opts["labelsDiv"]=label_elm}new Dygraph(document.getElementById(html_elm_id),t_csv,dygraph_opts)}})}class SensorsHistoryPane extends React.Component{static buildProps(){const urlParams=new URLSearchParams(window.location.search);const urlQueryMetric=urlParams.get("metric");const metric=urlQueryMetric?[urlQueryMetric]:INTERESTING_PLOT_METRICS;const urlQueryPeriod=urlParams.get("period");const period=urlQueryPeriod?[urlQueryPeriod]:"day_2";const plotSingleMetric=!!urlQueryMetric;return{plotSingleMetric,metrics_to_plot:metric,period,key:"SensorsHistoryPane"}}constructor(props){super(props);this.loadPlotsForSensorMeasuring=this.loadPlotsForSensorMeasuring.bind(this);this.updateConfigPeriod=this.updateConfigPeriod.bind(this);this.updateConfigMetric=this.updateConfigMetric.bind(this);this.sensorsListRef=React.createRef();this.state={sensors:null,period:this.props.period,allMetrics:[],selectedMetrics:this.props.metrics_to_plot}}componentDidMount(){this.on_app_became_visible()}on_app_became_visible(){mJsonGet("/sensors/metrics",metrics=>{this.setState({allMetrics:metrics,sensors:null})});if(this.sensorsListRef.current){this.sensorsListRef.current.refresh()}}updateConfigPeriod(){const period=document.getElementById("SensorsHistoryConfig_period").value;window.history.replaceState(null,"Sensors",`?metric=${this.state.selectedMetrics.join(",")}&period=${period}`);this.setState({period})}updateConfigMetric(){const select=document.getElementById("SensorsHistoryConfig_metric");const selected=Array.from(select.selectedOptions).map(o=>o.value);window.history.replaceState(null,"Sensors",`?metric=${selected.join(",")}&period=${this.state.period}`);this.setState({selectedMetrics:selected,sensors:null})}render(){return React.createElement("div",{id:"SensorsHistoryPane"},React.createElement("div",{class:"SensorsHistoryConfig"},React.createElement("h1",null,React.createElement("img",{src:"/favicon.ico",alt:"Sensor history"}),"Sensor history"),React.createElement("label",{htmlFor:"SensorsHistoryConfig_period"},"Period:"),React.createElement("select",{value:this.state.period,name:"SensorsHistoryConfig_period",id:"SensorsHistoryConfig_period",onChange:this.updateConfigPeriod},React.createElement("option",{value:"hour_1"},"Last hour"),React.createElement("option",{value:"hour_6"},"Last 6 hours"),React.createElement("option",{value:"hour_12"},"Last 12 hours"),React.createElement("option",{value:"day_1"},"Last day"),React.createElement("option",{value:"day_2"},"Last 2 days"),React.createElement("option",{value:"all"},"All")),React.createElement("label",{htmlFor:"SensorsHistoryConfig_metric",style:{marginLeft:"10px"}},"Metrics:"),React.createElement("select",{id:"SensorsHistoryConfig_metric",multiple:true,value:this.state.selectedMetrics,onChange:this.updateConfigMetric},this.state.allMetrics.map(m=>React.createElement("option",{value:m,key:m},m)))),React.createElement(SensorsList,{ref:this.sensorsListRef,metrics:this.state.selectedMetrics,api_base_path:this.props.api_base_path}),this.render_plots())}render_plots(){const metrics=this.state.selectedMetrics;if(metrics.length===1&&!this.state.sensors){this.loadPlotsForSensorMeasuring(metrics[0]);return"Loading sensors..."}else if(metrics.length===1){return this.renderSingleMetric(metrics[0],this.state.sensors)}else{return this.renderMetricInAllSensors(metrics)}}renderMetricInAllSensors(metrics){function buildUrlForPeriod(period){if(!period||period=="all")return"";let unit="days";let time=1;if(period=="hour_1"){unit="hours";time=1}if(period=="hour_6"){unit="hours";time=6}if(period=="hour_12"){unit="hours";time=12}if(period=="day_1"){unit="days";time=1}if(period=="day_2"){unit="days";time=2}return`/${unit}/${time}`}let local_plots=[];for(const metric of metrics){const plotId=`local_plot_${metric}`;const url=`/sensors/get_single_metric_in_all_sensors_csv/${metric}${buildUrlForPeriod(this.state.period)}`;setTimeout(()=>{const plotDiv=document.getElementById(plotId);if(plotDiv){plotDiv.innerHTML=""}simple_dygraph_plot(plotId,url)},0);local_plots.push(React.createElement("div",{className:"card",key:`${metric}_${this.state.period}_div`},React.createElement("h3",null,React.createElement("a",{href:`?metric=${metric}`},metric)),React.createElement("div",{id:plotId}),React.createElement("div",{id:`${plotId}_label`})))}return local_plots}loadPlotsForSensorMeasuring(metric){mAjax({url:`/sensors/measuring/${metric}`,cache:false,type:"get",dataType:"text",success:sensorLst=>{this.setState({sensors:JSON.parse(sensorLst)})},error:err=>{console.log(err);showGlobalError(err)}})}renderSingleMetric(metric,sensors){function buildUrlForPeriod(period){if(!period||period=="all")return"";let unit="days";let time=1;if(period=="hour_1"){unit="hours";time=1}if(period=="hour_6"){unit="hours";time=6}if(period=="hour_12"){unit="hours";time=12}if(period=="day_1"){unit="days";time=1}if(period=="day_2"){unit="days";time=2}return`/history/${unit}/${time}`}let local_plots=[];for(const sensor of sensors){const plotId=`local_plot_${sensor}`;const url=`/sensors/get_metric_in_sensor_csv/${sensor}/${metric}${buildUrlForPeriod(this.state.period)}`;setTimeout(()=>{const plotDiv=document.getElementById(plotId);if(plotDiv){plotDiv.innerHTML=""}simple_dygraph_plot(plotId,url)},50);local_plots.push(React.createElement("div",{className:"card",key:`${sensor}_${this.state.period}_div`},React.createElement("h3",null,metric," for ",sensor),React.createElement("div",{id:plotId}),React.createElement("div",{id:`${plotId}_label`})))}return local_plots}};class SensorsList extends React.Component{constructor(props){super(props);this.state={sensors:null,sensorData:{}}}componentDidMount(){this.loadSensors()}componentDidUpdate(prevProps){if(prevProps.metrics!==this.props.metrics){this.loadSensors()}}refresh(){this.loadSensors()}loadSensors(){const metrics=this.props.metrics;if(!metrics||metrics.length===0){this.setState({sensors:[],sensorData:{}});return}const basePath=this.props.api_base_path||"";if(metrics.length===1){mJsonGet(`${basePath}/sensors/measuring/${metrics[0]}`,sensors=>{this.setState({sensors,sensorData:{}});this.loadSensorData(sensors)})}else{const allSensors=new Set;let pending=metrics.length;metrics.forEach(metric=>{mJsonGet(`${basePath}/sensors/measuring/${metric}`,sensorLst=>{sensorLst.forEach(s=>allSensors.add(s));pending--;if(pending===0){const sensors=Array.from(allSensors).sort();this.setState({sensors,sensorData:{}});this.loadSensorData(sensors)}})})}}loadSensorData(sensors){const basePath=this.props.api_base_path||"";sensors.forEach(sensor=>{mJsonGet(`${basePath}/z2m/get/${sensor}`,data=>{this.setState(prevState=>({sensorData:{...prevState.sensorData,[sensor]:data}}))})})}getUnit(metric){const units={temperature:"\xB0C",device_temperature:"\xB0C",humidity:"%",voltage:"V",battery:"%",pm25:"\xB5g/m\xB3"};return units[metric]||""}formatValue(value,metric){if(typeof value!=="number"){return"?"}const unit=this.getUnit(metric);return unit?`${value}${unit}`:value}renderSensorValues(sensor){const data=this.state.sensorData[sensor];const metrics=this.props.metrics;if(data===undefined){return"..."}if(data===null){return"?"}const hasAnyValue=metrics.some(m=>typeof data[m]==="number");if(!hasAnyValue){return"No data yet"}if(metrics.length===1){return this.formatValue(data[metrics[0]],metrics[0])}else{return metrics.map(m=>`${m}=${this.formatValue(data[m],m)}`).join(", ")}}render(){if(this.state.sensors===null){return React.createElement("div",{className:"sensors-list"},"Loading sensors...")}return React.createElement("ul",{className:"sensors-list keyval-list"},this.state.sensors.map(sensor=>React.createElement("li",{key:sensor,className:"bd-dark modal-button"},React.createElement("strong",null,sensor,":")," ",this.renderSensorValues(sensor))))}}
"use strict";class ScenesList extends React.Component{constructor(props){super(props);this.state={scenes:[],sceneStatus:null};this.fetchScenes=this.fetchScenes.bind(this);this.applyScene=this.applyScene.bind(this)}componentDidMount(){this.fetchScenes()}fetchScenes(){mJsonGet(this.props.api_base_path+"/ls_scenes",res=>{this.setState({scenes:res||[]})})}applyScene(scene){mJsonGet(this.props.api_base_path+"/apply_scene?scene="+encodeURIComponent(scene),res=>{if(res&&res.success){this.setState({sceneStatus:"Scene applied"});setTimeout(()=>{this.setState({sceneStatus:null})},3000)}})}render(){if(this.state.scenes.length===0){return null}return React.createElement("div",null,React.createElement("ul",{className:"keyval-list"},this.state.scenes.map((scene,idx)=>React.createElement("li",{key:idx,className:"modal-button primary"},React.createElement("a",{href:"#",onClick:e=>{e.preventDefault();this.applyScene(scene)}},scene.replace(/_/g," "))))),this.state.sceneStatus&&React.createElement("p",null,this.state.sceneStatus))}}class BaticasaButtonsMonitor extends React.Component{static buildProps(){return{key:"BaticasaButtonsMonitor",api_base_path:""}}constructor(props){super(props);this.state={boundButtons:null,unboundButtons:null,discoveredActions:{},actionInputs:{},triggerStatus:{},showCustomInput:{}};this.fetchButtonsState=this.fetchButtonsState.bind(this);this.handleActionInputChange=this.handleActionInputChange.bind(this);this.handleDropdownChange=this.handleDropdownChange.bind(this);this.triggerAction=this.triggerAction.bind(this)}async componentDidMount(){this.fetchButtonsState()}on_app_became_visible(){this.fetchButtonsState()}fetchButtonsState(){mJsonGet(this.props.api_base_path+"/buttons_state",res=>{this.setState({boundButtons:res.bound_actions,unboundButtons:res.unbound_actions,discoveredActions:res.discovered_actions||{}})})}handleActionInputChange(buttonName,value){this.setState(state=>({actionInputs:{...state.actionInputs,[buttonName]:value}}))}handleDropdownChange(buttonName,value){if(value==="__other__"){this.setState(state=>({showCustomInput:{...state.showCustomInput,[buttonName]:true},actionInputs:{...state.actionInputs,[buttonName]:""}}))}else{this.setState(state=>({showCustomInput:{...state.showCustomInput,[buttonName]:false},actionInputs:{...state.actionInputs,[buttonName]:value}}))}}async triggerAction(buttonName){const actionValue=this.state.actionInputs[buttonName]||"";if(!actionValue){this.setState(state=>({triggerStatus:{...state.triggerStatus,[buttonName]:{success:false,message:"Please enter an action value"}}}));return}try{const response=await fetch(this.props.api_base_path+"/trigger_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({button_name:buttonName,action_value:actionValue})});const data=await response.json();if(response.ok){this.setState(state=>({triggerStatus:{...state.triggerStatus,[buttonName]:{success:true,message:data.message}}}))}else{this.setState(state=>({triggerStatus:{...state.triggerStatus,[buttonName]:{success:false,message:data.error}}}))}setTimeout(()=>{this.setState(state=>({triggerStatus:{...state.triggerStatus,[buttonName]:null}}))},5000)}catch(error){this.setState(state=>({triggerStatus:{...state.triggerStatus,[buttonName]:{success:false,message:"Failed to trigger action"}}}))}}render(){if(!this.state.boundButtons||!this.state.unboundButtons){return React.createElement("div",{className:"app-loading"},"Loading...")}const boundButtons=this.state.boundButtons;const unboundButtons=this.state.unboundButtons;return React.createElement("div",{id:"BaticasaButtonsContainer"},React.createElement("h3",null,React.createElement("img",{src:"/favicon.ico",alt:"Baticasa buttons"}),"Baticasa Buttons"),unboundButtons.length>0&&React.createElement("div",{className:"bd-error card text-error"},React.createElement("h4",null,"\u26A0 Error: Unbound Actions (",unboundButtons.length,")"),React.createElement("p",null,"The following callbacks could not be bound to Z2M things. Check if devices are missing or callback names are incorrect:"),React.createElement("ul",null,unboundButtons.map((buttonName,idx)=>React.createElement("li",{key:idx},React.createElement("code",null,buttonName))))),boundButtons.length>0&&React.createElement("div",null,React.createElement("h4",null,"\u2713 Buttons bound to actions: (",boundButtons.length,")"),React.createElement("ul",null,boundButtons.map((buttonName,idx)=>this.renderButton(buttonName,idx))),"Use this panel to trigger actions in the service. You'll need to provide the name of the MQTT action that would be sent by zigbee2mqtt."),boundButtons.length===0&&unboundButtons.length===0&&React.createElement("div",null,"No button callbacks found"),React.createElement("h4",null,"Scenes"),React.createElement(ScenesList,{api_base_path:this.props.api_base_path}))}renderButton(buttonName,idx){const status=this.state.triggerStatus[buttonName];const actionInput=this.state.actionInputs[buttonName]||"";const discoveredActions=this.state.discoveredActions[buttonName]||[];const showCustomInput=this.state.showCustomInput[buttonName]||false;const hasDiscoveredActions=discoveredActions.length>0;return React.createElement("li",{key:idx},React.createElement("strong",{style:{display:"inline-block",width:"250px",marginRight:"10px"}},buttonName),hasDiscoveredActions&&!showCustomInput?React.createElement("select",{value:actionInput,onChange:e=>this.handleDropdownChange(buttonName,e.target.value),style:{marginRight:"10px",padding:"5px",width:"300px",backgroundColor:"#2a2a2a",color:"#fff",border:"1px solid #444",display:"inline-block"}},React.createElement("option",{value:""},"-- Select an action --"),discoveredActions.map((action,actionIdx)=>React.createElement("option",{key:actionIdx,value:action},action)),React.createElement("option",{value:"__other__"},"Other")):React.createElement("input",{type:"text",placeholder:"MQTT Action (eg: on, toggle...)",value:actionInput,onChange:e=>this.handleActionInputChange(buttonName,e.target.value),style:{marginRight:"10px",padding:"5px",width:"300px",backgroundColor:"#2a2a2a",color:"#fff",border:"1px solid #444",display:"inline-block"}}),React.createElement("button",{type:"button",onClick:()=>this.triggerAction(buttonName),style:{padding:"5px 15px"}},"Trigger"),status&&React.createElement("span",{className:status.success?"bg-success":"bg-error"},status.message))}}
"use strict";const ProxiedServices={CACHE_KEY:"proxied_services",_services:null,_storage:new LocalStorageManager,_fetchServices(callback){mJsonGet("/get_proxied_services",services=>{this._services=services;this._storage.cacheSave(this.CACHE_KEY,services);if(callback)callback(services)})},get(serviceName){return this._services?this._services[serviceName]:null},init(callback){const fresh=this._storage.cacheGet(this.CACHE_KEY);const cached=fresh||this._storage.cacheGet_ignoreExpire(this.CACHE_KEY);if(cached){this._services=cached;if(!fresh)this._fetchServices();callback()}else{this._fetchServices(callback)}}};function LightsSection(props){return React.createElement("div",{className:"dashboard-section",id:"lights-section"},React.createElement(MqttLights,MqttLights.buildProps("/mqtt_lights")),React.createElement("a",{href:ProxiedServices.get("mqtt_lights")},React.createElement("img",{src:"/mqtt_lights/favicon.ico"})))}function SpeakersSection(props){return React.createElement("div",{className:"dashboard-section",id:"speakers-section"},React.createElement("a",{href:ProxiedServices.get("mqtt_speaker_announce")},React.createElement("img",{src:"/mqtt_speaker_announce/favicon.ico"})),React.createElement(TTSAnnounce,TTSAnnounce.buildProps("/mqtt_speaker_announce")))}function ContactMonSection(props){return React.createElement("div",{className:"dashboard-section",id:"contactmon-section"},React.createElement("a",{href:ProxiedServices.get("mqtt_contact_mon")},React.createElement("img",{src:"/mqtt_contact_mon/favicon.ico"})),React.createElement(ContactMonitor,ContactMonitor.buildProps("/mqtt_contact_mon")))}function MqttHeatingSection(props){return React.createElement("div",{className:"dashboard-section",id:"heating-section"},React.createElement("h2",null,React.createElement("a",{href:ProxiedServices.get("mqtt_heating")},React.createElement("img",{src:"/mqtt_heating/favicon.ico"})),"Heating"),React.createElement(HeatingControls,HeatingControls.buildProps("/mqtt_heating")))}function DoorbellCamSection(props){return React.createElement("div",{className:"dashboard-section",id:"doorbell-cam-section"},React.createElement("a",{href:ProxiedServices.get("mqtt_doorbell_cam")},React.createElement("img",{src:"/mqtt_doorbell_cam/favicon.ico"})),React.createElement(CamViewer,CamViewer.buildProps("/mqtt_doorbell_cam",ProxiedServices.get("mqtt_doorbell_cam"))))}function SensorsListSection(props){return React.createElement("div",{className:"dashboard-section",id:"sensors-list-section",style:{display:"flex",alignItems:"center",gap:"10px"}},React.createElement("a",{href:ProxiedServices.get("mqtt_sensor_mon")},React.createElement("img",{src:"/mqtt_sensor_mon/favicon.ico"})),React.createElement(SensorsList,{metrics:["temperature"],api_base_path:"/mqtt_sensor_mon"}))}function SceneListSection(props){return React.createElement("div",{className:"dashboard-section",id:"scene-list-section",style:{display:"flex",alignItems:"center",gap:"10px"}},React.createElement("a",{href:ProxiedServices.get("baticasa_buttons")},React.createElement("img",{src:"/baticasa_buttons/favicon.ico"})),React.createElement(ScenesList,{api_base_path:"/baticasa_buttons"}))}function Dashboard(props){const[expandedSection,setExpandedSection]=React.useState(null);const contentRef=React.useRef(null);const toggleSection=section=>{const newSection=expandedSection===section?null:section;setExpandedSection(newSection);if(newSection!==null){setTimeout(()=>{if(contentRef.current){contentRef.current.scrollIntoView({behavior:"smooth",block:"start"})}},50)}};const renderBtn=(btnLbl,btnUrl,btnIco)=>{return React.createElement("button",{className:"modal-button primary",onClick:()=>window.open(btnUrl,"_blank"),style:{display:"flex",alignItems:"center",gap:"8px"}},React.createElement("img",{src:btnIco,alt:"",style:{width:"20px",height:"20px"}}),btnLbl)};const renderSvcBtn=(sectionName,serviceName)=>{return React.createElement("button",{className:expandedSection===sectionName?"modal-button primary bg-dark":"modal-button",onClick:()=>toggleSection(sectionName),style:{display:"flex",alignItems:"center",gap:"8px"}},React.createElement("img",{src:`/${serviceName}/favicon.ico`,alt:"",style:{width:"20px",height:"20px"}}),sectionName)};return React.createElement("div",null,React.createElement("div",{className:"dashboard-sections"},React.createElement(LightsSection,null),React.createElement(SceneListSection,null),React.createElement(SensorsListSection,null),React.createElement("div",{style:{display:"flex",gap:"10px",marginBottom:"20px",flexWrap:"wrap"}},renderSvcBtn("Announce","mqtt_speaker_announce"),renderSvcBtn("Contact","mqtt_contact_mon"),renderSvcBtn("Heating","mqtt_heating"),renderSvcBtn("Door","mqtt_doorbell_cam"),renderBtn("Baticasa Services","http://10.0.0.10:4200/index.html","http://10.0.0.10:4200/favicon.ico"),renderBtn("Z2M","http://10.0.0.10:4100","/z2m.ico"),renderBtn("","http://bati.casa:5000/client_ls_txt","/wwwslider.ico"),renderBtn("","http://bati.casa:2222/photos","/immich.ico"),renderBtn("","https://bati.casa:8443/","/unifi.png"),renderBtn("","http://bati.casa:8444/admin/login.php","/pihole.svg")),React.createElement("div",{ref:contentRef},expandedSection==="Announce"&&React.createElement(SpeakersSection,null),expandedSection==="Contact"&&React.createElement(ContactMonSection,null),expandedSection==="Heating"&&React.createElement(MqttHeatingSection,null),expandedSection==="Door"&&React.createElement(DoorbellCamSection,null))))}Dashboard.buildProps=()=>({key:"dashboard"});ProxiedServices.init(()=>{z2mStartReactApp("#app_root",Dashboard)});
