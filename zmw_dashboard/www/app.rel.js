"use strict";function formatTime(seconds){if(seconds<60){return`${Math.round(seconds)}s`}const minutes=Math.floor(seconds/60);if(minutes<60){const secs=Math.round(seconds%60);return`${minutes}m ${secs}s`}const hours=Math.floor(minutes/60);if(hours<24){const mins=minutes%60;return`${hours}h ${mins}m`}const days=Math.floor(hours/24);if(days<7){const hrs=hours%24;return`${days}d ${hrs}h`}const weeks=Math.floor(days/7);const remainingDays=days%7;return`${weeks}w ${remainingDays}d`}class ContactMonitor extends React.Component{static buildProps(api_base_path=""){return{key:"ContactMonitor",api_base_path:api_base_path}}constructor(props){super(props);this.state={svc_state:null};this.skipChimeReq=this.skipChimeReq.bind(this);this.enableChimeReq=this.enableChimeReq.bind(this);this.fetchServiceState=this.fetchServiceState.bind(this);this.timer=null}async componentDidMount(){this.fetchServiceState()}on_app_became_visible(){this.fetchServiceState()}componentDidUpdate(prevProps,prevState){var _prevState$svc_state,_this$state$svc_state;const prevSkip=(_prevState$svc_state=prevState.svc_state)===null||_prevState$svc_state===void 0?void 0:_prevState$svc_state.skipping_chimes;const currSkip=(_this$state$svc_state=this.state.svc_state)===null||_this$state$svc_state===void 0?void 0:_this$state$svc_state.skipping_chimes;if(!prevSkip&&currSkip){this.startSkipTimer()}}startSkipTimer(){if(this.timer)clearInterval(this.timer);this.timer=setInterval(()=>{this.setState(state=>{const timeout=state.svc_state.skipping_chime_timeout-1;if(timeout<=0){clearInterval(this.timer);this.timer=null;this.fetchServiceState();return{svc_state:{...state.svc_state,skipping_chimes:false,skipping_chime_timeout:0}}}return{svc_state:{...state.svc_state,skipping_chime_timeout:timeout}}})},1000)}componentWillUnmount(){if(this.timer){clearInterval(this.timer)}}fetchServiceState(){mJsonGet(`${this.props.api_base_path}/svc_state`,res=>{this.setState({svc_state:{...res,skipping_chime_timeout:res.skipping_chimes_timeout_secs}})})}skipChimeReq(){mJsonGet(`${this.props.api_base_path}/skip_chimes`,res=>{this.setState(state=>({svc_state:{...state.svc_state,skipping_chimes:true,skipping_chime_timeout:Number(res.timeout)}}))})}enableChimeReq(){mJsonGet(`${this.props.api_base_path}/enable_chimes`,res=>{this.fetchServiceState()})}render(){if(!this.state.svc_state){return React.createElement("div",null,"Loading...")}const hasTimeouts=this.state.svc_state.timeout_sensors&&this.state.svc_state.timeout_sensors.length>0;const hasCurfews=this.state.svc_state.curfew_sensors&&this.state.svc_state.curfew_sensors.length>0;const sensors=this.state.svc_state.sensors||{};const sensorNames=Object.keys(sensors).sort();return React.createElement("section",{id:"zmw_contactmon",className:"card"},this.state.svc_state.skipping_chimes?React.createElement("button",{type:"button",onClick:this.enableChimeReq},"Enable chimes"):React.createElement("button",{type:"button",onClick:this.skipChimeReq},"Skip next chime"),this.state.svc_state.skipping_chimes&&React.createElement("div",{className:"card warn"},React.createElement("p",null,"Skipping chimes!"),React.createElement("p",null,"Will skip chimes for the next ",Math.round(this.state.svc_state.skipping_chime_timeout)," seconds")),hasTimeouts&&React.createElement("div",{className:"card info"},React.createElement("p",null,"Pending Timeouts"),React.createElement("ul",null,this.state.svc_state.timeout_sensors.map((timeout,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,timeout.sensor)," - will timeout in ",formatTime(timeout.seconds_remaining))))),hasCurfews&&React.createElement("div",{className:"card info"},React.createElement("p",null,"Curfew Alerts"),React.createElement("ul",null,this.state.svc_state.curfew_sensors.map((curfew,idx)=>React.createElement("li",{key:idx},React.createElement("strong",null,curfew.sensor)," - will trigger in ",formatTime(curfew.seconds_until_trigger))))),React.createElement("ul",null,sensorNames.map(sensorName=>this.renderSensor(sensorName,sensors[sensorName]))))}renderSensor(sensorName,sensor){var _this$state$svc_state2;let displayText="";if(sensor.contact===true){displayText="closed"}else if(sensor.contact===false){displayText="open"}else{displayText="in unknown state (waiting for sensor report)"}const changedDate=sensor.changed?new Date(sensor.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";let durationStr="";if(changedDate){const now=new Date;const durationSecs=(now-changedDate)/1000;durationStr=formatTime(durationSecs)}const history=((_this$state$svc_state2=this.state.svc_state.history)===null||_this$state$svc_state2===void 0?void 0:_this$state$svc_state2[sensorName])||[];return React.createElement("li",{key:sensorName},React.createElement("strong",null,sensorName),": ",displayText,changedDate&&React.createElement("span",null," "," @ ",changedStr," (",durationStr," ago)"),this.renderHistory(sensorName,history))}renderHistory(sensorName,history){var _this$state$svc_state3;if(!history||history.length===0){return null}const sortedHistory=[...history].sort((a,b)=>{const timeA=a.changed?new Date(a.changed).getTime():0;const timeB=b.changed?new Date(b.changed).getTime():0;return timeB-timeA});const currentSensor=(_this$state$svc_state3=this.state.svc_state.sensors)===null||_this$state$svc_state3===void 0?void 0:_this$state$svc_state3[sensorName];return React.createElement("details",null,React.createElement("summary",null,"History (last ",sortedHistory.length," events)"),React.createElement("table",null,React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Contact"),React.createElement("th",null,"Action"),React.createElement("th",null,"Changed"),React.createElement("th",null,"Duration"))),React.createElement("tbody",null,sortedHistory.map((evt,idx)=>{const contact=evt.contact===true?"closed":evt.contact===false?"open":"unknown";const action=evt.action||"unknown";const changedDate=evt.changed?new Date(evt.changed):null;const changedStr=changedDate?changedDate.toLocaleString():"unknown";const isOpen=evt.contact===false;let duration="";const isFirstItem=idx===0;const isCurrentState=currentSensor&&currentSensor.contact===evt.contact&&currentSensor.action===evt.action;if(isFirstItem&&isCurrentState){duration="current"}else if(changedDate){let endDate;if(isFirstItem){endDate=new Date}else{const newerEvent=sortedHistory[idx-1];endDate=newerEvent&&newerEvent.changed?new Date(newerEvent.changed):new Date}const durationSecs=(endDate-changedDate)/1000;duration=formatTime(durationSecs)}return React.createElement("tr",{key:idx,className:evt.contact?"hint":"warn"},React.createElement("td",null,contact),React.createElement("td",null,action),React.createElement("td",null,changedStr),React.createElement("td",null,duration))}))))}}function millisecToNextSlotChg(){const now=new Date;const qr=Math.floor(now.getMinutes()/15);const nxt_slot_chg_min=15*(qr+1)%60;const slot_chg=new Date;slot_chg.setMinutes(nxt_slot_chg_min);slot_chg.setSeconds(0);const ms_to_chg=slot_chg-now;if(nxt_slot_chg_min==0){return ms_to_chg+60*60*1000}return ms_to_chg}function renderScheduleTable(sched,slotGenerator){const qr_groupped_sched={};for(let hr=0;hr<24;++hr){qr_groupped_sched[hr]=sched.slice(hr*4,(hr+1)*4)}return React.createElement("table",null,React.createElement("tbody",null,Object.keys(qr_groupped_sched).map(hour=>{return React.createElement("tr",{key:`table_schedule_${hour}`},qr_groupped_sched[hour].map(slot=>{return React.createElement("td",{key:`table_schedule_${slot.hour}_${slot.minute}`,"data-state":slot.request_on?"on":"off"},slotGenerator(slot))}))})))}class HeatingControls extends React.Component{static buildProps(api_base_path="",state={}){const props={api_base_path:api_base_path};if(state.allow_on!==undefined)props.allow_on=state.allow_on;if(state.mqtt_thing_reports_on!==undefined)props.mqtt_thing_reports_on=state.mqtt_thing_reports_on;if(state.monitoring_sensors!==undefined)props.monitoring_sensors=state.monitoring_sensors;if(state.onRefresh!==undefined)props.onRefresh=state.onRefresh;return props}constructor(props){super(props);this._offNow=this._offNow.bind(this);this._refresh=this._refresh.bind(this);this.state={allow_on:props.allow_on||null,mqtt_thing_reports_on:props.mqtt_thing_reports_on||null,monitoring_sensors:props.monitoring_sensors||null}}componentDidMount(){if(!this.props.allow_on&&this.props.api_base_path){this._refresh()}}componentDidUpdate(prevProps){if(prevProps.allow_on!==this.props.allow_on||prevProps.mqtt_thing_reports_on!==this.props.mqtt_thing_reports_on||prevProps.monitoring_sensors!==this.props.monitoring_sensors){this.setState({allow_on:this.props.allow_on,mqtt_thing_reports_on:this.props.mqtt_thing_reports_on,monitoring_sensors:this.props.monitoring_sensors})}}_refresh(){if(this.props.api_base_path){mJsonGet(`${this.props.api_base_path}/svc_state`,state=>{this.setState({allow_on:state.allow_on,mqtt_thing_reports_on:state.mqtt_thing_reports_on,monitoring_sensors:state.monitoring_sensors});if(this.props.onRefresh){this.props.onRefresh()}})}}_mkBoost(hours){return()=>{mJsonGet(`${this.props.api_base_path}/boost=${hours}`,this._refresh)}}_offNow(){mJsonGet(`${this.props.api_base_path}/off_now`,this._refresh)}renderHeatingOverrides(){let policy_state="Boiler manager unknown state";if(this.state.allow_on=="Never"){policy_state="Boiler should be off"}else if(this.state.allow_on=="Always"){policy_state="Boiler should be on"}else if(this.state.allow_on=="Rule"){policy_state="Rule controls boiler state"}return React.createElement("div",{className:"card hint"},React.createElement("p",null,React.createElement("b",null,"Current status: ",policy_state,", boiler reports ",this.state.mqtt_thing_reports_on)),React.createElement("button",{onClick:this._mkBoost(1)},"Boost 1 hour"),React.createElement("button",{onClick:this._mkBoost(2)},"Boost 2 hours"),React.createElement("button",{onClick:this._offNow},"Off now"))}renderMonitoringSensors(){if(!this.state.monitoring_sensors){return React.createElement("div",{className:"card hint"},React.createElement("p",null,"Loading sensors!"),React.createElement("p",null,"Please wait..."))}return React.createElement("ul",{className:"not-a-list"},Object.entries(this.state.monitoring_sensors).map(([name,value])=>React.createElement("li",{key:name,className:"infobadge"},name,": ",`${value}Â°C`||"? \xB0C")))}render(){return React.createElement(React.Fragment,null,this.renderHeatingOverrides(),this.renderMonitoringSensors())}}class HeatingScheduleConfig extends React.Component{static buildProps(api_base_path="",onRefresh=null,onToggleConfig=null,state={},renderFunctions={}){return{api_base_path:api_base_path,onRefresh:onRefresh,onToggleConfig:onToggleConfig,configuring:state.configuring||false,active_schedule:state.active_schedule||null,schedule_template:state.schedule_template||null,renderSlot:renderFunctions.renderSlot||null,renderTemplateSlot:renderFunctions.renderTemplateSlot||null}}constructor(props){super(props);this._applyTemplate=this._applyTemplate.bind(this);this._resetTemplateAlwaysOff=this._resetTemplateAlwaysOff.bind(this);this._resetTemplateAlwaysRule=this._resetTemplateAlwaysRule.bind(this);this._showLogs=this._showLogs.bind(this)}_applyTemplate(){mJsonGet(`${this.props.api_base_path}/template_apply`,this.props.onRefresh)}_resetTemplateAlwaysOff(){mJsonGet(`${this.props.api_base_path}/template_reset=Never`,this.props.onRefresh)}_resetTemplateAlwaysRule(){mJsonGet(`${this.props.api_base_path}/template_reset=Rule`,this.props.onRefresh)}_showLogs(){window.open("/logs.html","_self")}renderConfig(){if(!this.props.schedule_template){return null}return React.createElement("div",null,this.renderTemplateControls(),renderScheduleTable(this.props.schedule_template,this.props.renderTemplateSlot))}renderState(){if(!this.props.active_schedule){return null}return React.createElement("div",null,renderScheduleTable(this.props.active_schedule,this.props.renderSlot),this.renderConfigControls())}renderConfigControls(){return React.createElement("div",{className:"card"},React.createElement("button",{onClick:this.props.onToggleConfig},"Config"),React.createElement("button",{onClick:this._applyTemplate},"Reset today schedule"),React.createElement("button",{onClick:this._showLogs},"Logs"))}renderTemplateControls(){return React.createElement("div",{className:"card"},React.createElement("button",{onClick:this.props.onToggleConfig},"Finish Config"),React.createElement("button",{onClick:this._applyTemplate},"Apply template / reset today schedule"),React.createElement("button",{onClick:this._resetTemplateAlwaysOff},"Reset template: Always off"),React.createElement("button",{onClick:this._resetTemplateAlwaysRule},"Reset template: Always rule-based"))}render(){return this.props.configuring?this.renderConfig():this.renderState()}}class MqttHeating extends React.Component{static buildProps(api_base_path=""){return{key:"HeatingPane",api_base_path:api_base_path}}constructor(props){super(props);this.refresh=this.refresh.bind(this);this._toggleConfig=this._toggleConfig.bind(this);this._renderSlot=this._renderSlot.bind(this);this._renderTemplateSlot=this._renderTemplateSlot.bind(this);const app_visibility=new VisibilityCallback;app_visibility.app_became_visible=this.refresh;this.state={configuring:false,active_schedule:null,schedule_template:null,allow_on:null,mqtt_thing_reports_on:null,monitoring_sensors:null,refreshId:null,app_visibility}}refresh(){if(this.state.refreshId){clearTimeout(this.state.refreshId)}if(this.state.configuring){console.log("Configuring: will refresh schedule");mJsonGet(`${this.props.api_base_path}/template_schedule`,tmpl_state=>{this.setState({schedule_template:tmpl_state.template})});return}console.log("Refreshing boiler state...");mJsonGet(`${this.props.api_base_path}/svc_state`,state=>{this.setState({active_schedule:state.active_schedule,allow_on:state.allow_on,mqtt_thing_reports_on:state.mqtt_thing_reports_on,monitoring_sensors:state.monitoring_sensors,refreshId:setInterval(this.refresh,millisecToNextSlotChg())})})}_toggleConfig(){this.setState({configuring:!this.state.configuring})}render(){return this.state.configuring?this.renderConfig():this.renderState()}renderConfig(){if(!this.state.schedule_template){this.refresh();return"Loading configuration..."}return React.createElement("div",null,React.createElement(HeatingScheduleConfig,{configuring:true,schedule_template:this.state.schedule_template,renderTemplateSlot:this._renderTemplateSlot,api_base_path:this.props.api_base_path,onRefresh:this.refresh,onToggleConfig:this._toggleConfig}))}renderState(){if(!this.state.active_schedule){this.refresh();return"Loading..."}return React.createElement("div",null,React.createElement(HeatingControls,{allow_on:this.state.allow_on,mqtt_thing_reports_on:this.state.mqtt_thing_reports_on,monitoring_sensors:this.state.monitoring_sensors,api_base_path:this.props.api_base_path,onRefresh:this.refresh}),React.createElement(HeatingScheduleConfig,{configuring:false,active_schedule:this.state.active_schedule,renderSlot:this._renderSlot,api_base_path:this.props.api_base_path,onRefresh:this.refresh,onToggleConfig:this._toggleConfig}))}_renderSlot(slot){const slot_name=`${("0"+slot.hour).slice(-2)}:${("0"+slot.minute).slice(-2)}`;const cb=()=>{console.log("User toggling slot",slot_name);mJsonGet(`${this.props.api_base_path}/slot_toggle=${slot_name}`,this.refresh)};let descr="Error";if(slot.allow_on=="Never"){descr=`Off: ${slot.reason}`}else if(slot.allow_on=="Always"){descr=`On: ${slot.reason}`}else if(slot.allow_on=="Rule"&&slot.request_on){descr=`On: Rule ${slot.reason}`}else if(slot.allow_on=="Rule"&&!slot.request_on){descr=`Off: Rule ${slot.reason}`}return React.createElement("button",{onClick:cb},slot_name,React.createElement("wbr",null)," ",descr)}_renderTemplateSlot(slot){const slot_name=`${("0"+slot.hour).slice(-2)}:${("0"+slot.minute).slice(-2)}`;const cb=evt=>{const selected=evt.nativeEvent.target.value;console.log("Uset setting template",slot_name,selected);mJsonGet(`${this.props.api_base_path}/template_slot_set=${slot.hour},${slot.minute},${selected}`,this.refresh)};return React.createElement("div",null,slot_name,React.createElement("wbr",null)," ",slot.reason,React.createElement("select",{key:"`table_schedule_${slot.hour}_${slot.minute}_opt`",defaultValue:slot.allow_on,onChange:cb},React.createElement("option",{value:"Always"},"Always on"),React.createElement("option",{value:"Never"},"Always off"),React.createElement("option",{value:"Rule"},"Follow rule")))}}function filterMeta(meta){const filtered={description:meta.description,model:meta.model,name:meta.name,real_name:meta.real_name,thing_type:meta.thing_type,thing_id:meta.thing_id,address:meta.address,actions:{}};const actionNames=["brightness","color_rgb","color_temp","effect","state"];for(const actionName of actionNames){if(meta.actions&&meta.actions[actionName]){filtered.actions[actionName]=meta.actions[actionName]}}return filtered}async function getLightsMeta(api_base_path,lights){const metaPromises=lights.map(light=>{return new Promise(resolve=>{mJsonGet(`${api_base_path}/z2m/meta/${light.thing_name}`,meta=>{resolve({name:light.thing_name,meta:filterMeta(meta)})})})});const metaResults=await Promise.all(metaPromises);const metaByName={};for(const result of metaResults){metaByName[result.name]=result.meta}return metaByName}function getPrefixGroups(lightNames){function getValidPrefixes(name){const prefixes=[];for(let i=1;i<name.length;i++){if(name[i]>="A"&&name[i]<="Z"){const prefix=name.substring(0,i);if(prefix.length>=3){prefixes.push(prefix)}}}if(name.length>=3){prefixes.push(name)}return prefixes}const prefixCounts={};for(const name of lightNames){for(const prefix of getValidPrefixes(name)){prefixCounts[prefix]=(prefixCounts[prefix]||0)+1}}const groups={};const assigned=new Set;for(const name of lightNames){let bestPrefix=null;let bestCount=1;for(const prefix of getValidPrefixes(name)){if(prefixCounts[prefix]>bestCount){bestPrefix=prefix;bestCount=prefixCounts[prefix]}}if(bestPrefix){if(!groups[bestPrefix]){groups[bestPrefix]=[]}groups[bestPrefix].push(name);assigned.add(name)}}const others=lightNames.filter(name=>!assigned.has(name));if(others.length>0){groups["Others"]=others}return groups}function groupLightsByPrefix(lights){const lightNames=lights.map(light=>light.thing_name);const groupsByName=getPrefixGroups(lightNames);const lightsByName={};for(const light of lights){lightsByName[light.thing_name]=light}const groups={};const sortedPrefixes=Object.keys(groupsByName).sort((a,b)=>a.localeCompare(b));for(const prefix of sortedPrefixes){groups[prefix]=groupsByName[prefix].map(name=>lightsByName[name]).sort((a,b)=>a.thing_name.localeCompare(b.thing_name))}return groups}class ZmwLight extends React.Component{constructor(props){super(props);this.state={state:props.light.state,brightness:props.light.brightness,color_temp:props.light.color_temp,color_rgb:props.light.color_rgb||"#ffffff",effect:props.light.effect}}componentDidUpdate(prevProps){if(prevProps.light!==this.props.light){this.setState({state:this.props.light.state,brightness:this.props.light.brightness,color_temp:this.props.light.color_temp,color_rgb:this.props.light.color_rgb||"#ffffff",effect:this.props.light.effect})}}onStateChange(e){const v=e.target.checked;this.setState({state:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{state:v})}onBrightnessChange(e){const v=e.target.value;if(v==0){this.setState({brightness:0,state:false})}else{this.setState({brightness:v,state:true})}mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{brightness:v})}onColorTempChange(e){const v=e.target.value;this.setState({color_temp:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{color_temp:v})}onColorRgbChange(e){const v=e.target.value;this.setState({color_rgb:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{color_rgb:v})}onEffectChange(e){const v=e.target.value;this.setState({effect:v});mJsonPut(`${this.props.api_base_path}/z2m/set/${this.props.light.thing_name}`,{effect:v})}renderColorTemp(){const meta=this.props.meta;if(!meta.actions.color_temp){return null}const colorTempMeta=meta.actions.color_temp.value.meta;const presets=colorTempMeta.presets||[];return React.createElement("div",null,React.createElement("label",null,"Temperature"),React.createElement(DebouncedRange,{min:colorTempMeta.value_min,max:colorTempMeta.value_max,value:this.state.color_temp,onChange:e=>this.onColorTempChange(e)}),React.createElement("select",{value:this.state.color_temp,onChange:e=>this.onColorTempChange(e)},presets.map(preset=>React.createElement("option",{key:preset.name,value:preset.value},preset.name))))}renderColorRgb(){const meta=this.props.meta;if(!meta.actions.color_rgb){return null}return React.createElement("div",null,React.createElement("label",null,"RGB"),React.createElement("input",{type:"color",value:this.state.color_rgb,onChange:e=>this.onColorRgbChange(e)}))}renderEffect(){const meta=this.props.meta;if(!meta.actions.effect){return null}const effectValues=meta.actions.effect.value.meta.values||[];return React.createElement("div",null,React.createElement("label",null,"Effect"),React.createElement("select",{value:this.state.effect||"",onChange:e=>this.onEffectChange(e)},React.createElement("option",{value:""},"None"),effectValues.map(effect=>React.createElement("option",{key:effect,value:effect},effect))))}renderExtraCfgs(){const meta=this.props.meta;if(!(meta.actions.color_temp||meta.actions.color_rgb||meta.actions.effect)){return null}return React.createElement("details",{className:"light_details"},React.createElement("summary",null,"\u2699"),meta.name," (",meta.description," / ",meta.model,")",this.renderColorTemp(),this.renderColorRgb(),this.renderEffect())}render(){const light=this.props.light;const meta=this.props.meta;const displayName=light.thing_name.startsWith(this.props.prefix)?light.thing_name.slice(this.props.prefix.length):light.thing_name;return React.createElement("li",null,React.createElement("input",{id:`${light.thing_name}_light_is_on`,type:"checkbox",value:"true",checked:this.state.state,onChange:e=>this.onStateChange(e)}),React.createElement("label",{htmlFor:`${light.thing_name}_light_is_on`},displayName),React.createElement(DebouncedRange,{min:0,max:254,value:this.state.brightness,onChange:e=>this.onBrightnessChange(e)}),this.renderExtraCfgs())}}class ZmwButton extends React.Component{onClick(){mJsonPut(this.props.url,{})}render(){let displayName=this.props.name.startsWith(this.props.prefix)?this.props.name.slice(this.props.prefix.length):this.props.name;displayName=displayName.replace(/_/g," ").trim();return React.createElement("button",{onClick:()=>this.onClick()},displayName)}}function groupButtonsByLightPrefixes(buttons,lightPrefixes){const groups={};const prefixList=lightPrefixes.filter(p=>p!=="Others").sort((a,b)=>b.length-a.length);for(const buttonObj of buttons){const buttonName=Object.keys(buttonObj)[0];const buttonUrl=buttonObj[buttonName];let assigned=false;for(const prefix of prefixList){if(buttonName.startsWith(prefix)){if(!groups[prefix]){groups[prefix]=[]}groups[prefix].push({name:buttonName,url:buttonUrl});assigned=true;break}}if(!assigned){if(!groups["Others"]){groups["Others"]=[]}groups["Others"].push({name:buttonName,url:buttonUrl})}}return groups}class MqttLights extends React.Component{static buildProps(api_base_path="",buttons=[]){return{key:"MqttLights",local_storage:new LocalStorageManager,api_base_path:api_base_path,buttons:buttons}}constructor(props){super(props);this.state={lights:null}}async componentDidMount(){this.fetchLights()}componentDidUpdate(prevProps){if(prevProps.buttons!==this.props.buttons&&this.state.groups){const lightPrefixes=Object.keys(this.state.groups);const buttonGroups=groupButtonsByLightPrefixes(this.props.buttons||[],lightPrefixes);const sortedPrefixes=this.computeSortedPrefixes(this.state.groups,buttonGroups);this.setState({buttonGroups,sortedPrefixes})}}on_app_became_visible(){this.fetchLights()}computeSortedPrefixes(groups,buttonGroups){const allPrefixes=new Set([...Object.keys(groups),...Object.keys(buttonGroups||{})]);return Array.from(allPrefixes).sort((a,b)=>{if(a==="Others")return 1;if(b==="Others")return-1;return a.localeCompare(b)})}setLightsState(lights,meta){const groups=groupLightsByPrefix(lights);const lightPrefixes=Object.keys(groups);const buttonGroups=groupButtonsByLightPrefixes(this.props.buttons||[],lightPrefixes);const sortedPrefixes=this.computeSortedPrefixes(groups,buttonGroups);this.setState({lights,groups,meta,buttonGroups,sortedPrefixes})}clearCache(){const storage=this.props.local_storage;storage.remove("zmw_lights_hash");storage.remove("lights_meta");this.fetchLights()}fetchLights(){const storage=this.props.local_storage;const cachedHash=storage.get("zmw_lights_hash",null);mJsonGet(`${this.props.api_base_path}/get_lights`,async lights=>{mJsonGet(`${this.props.api_base_path}/z2m/get_known_things_hash`,async serverHash=>{const cachedMeta=storage.cacheGet("lights_meta");if(cachedHash&&cachedHash===serverHash&&cachedMeta){this.setLightsState(lights,cachedMeta);return}const metaByName=await getLightsMeta(this.props.api_base_path,lights);storage.save("zmw_lights_hash",serverHash);storage.cacheSave("lights_meta",metaByName);this.setLightsState(lights,metaByName)})})}render(){if(!this.state.lights){return React.createElement("div",{className:"app-loading"},"Loading...")}return React.createElement("div",{id:"zmw_lights"},this.state.sortedPrefixes.map(prefix=>{const lights=this.state.groups[prefix]||[];const buttons=(this.state.buttonGroups||{})[prefix]||[];return React.createElement("details",{key:prefix},React.createElement("summary",null,prefix),React.createElement("ul",null,buttons.length>0&&React.createElement("li",null,buttons.map(button=>React.createElement(ZmwButton,{key:button.name,name:button.name,url:button.url,prefix:prefix}))),lights.map(light=>React.createElement(ZmwLight,{key:light.thing_name,light:light,meta:this.state.meta[light.thing_name],prefix:prefix,api_base_path:this.props.api_base_path}))))}),this.props.runningStandaloneApp&&React.createElement("button",{onClick:()=>this.clearCache()},"Clear cache"))}}class StandaloneMqttLights extends MqttLights{static buildProps(api_base_path="",buttons=[]){const p=super.buildProps(api_base_path,buttons);p.runningStandaloneApp=true;return p}}class CamViewer extends React.Component{static buildProps(api_base_path="",svc_full_url=""){return{key:"cam_viewer",api_base_path,svc_full_url}}constructor(props){super(props);this.state={imageTimestamp:Date.now(),isLoading:false,isRecording:false,recordDuration:20,recordingTimeLeft:0};this.countdownInterval=null;this.onSnapRequested=this.onSnapRequested.bind(this);this.onRecordRequested=this.onRecordRequested.bind(this)}on_app_became_visible(){}onSnapRequested(){this.setState({isLoading:true});mTextGet(`${this.props.api_base_path}/snap`,()=>{console.log("Snapshot captured");setTimeout(()=>{this.setState({imageTimestamp:Date.now(),isLoading:false})},500)},err=>{showGlobalError("Failed to capture snapshot: "+err);this.setState({isLoading:false})})}onRecordRequested(){const secs=this.state.recordDuration;this.setState({isRecording:true,recordingTimeLeft:secs});mTextGet(`${this.props.api_base_path}/record?secs=${secs}`,()=>{console.log(`Recording started for ${secs} seconds`);this.countdownInterval=setInterval(()=>{this.setState(prevState=>{const newTime=prevState.recordingTimeLeft-1;if(newTime<=0){clearInterval(this.countdownInterval);return{isRecording:false,recordingTimeLeft:0}}return{recordingTimeLeft:newTime}})},1000)},err=>{showGlobalError("Failed to start recording: "+err.response);this.setState({isRecording:false,recordingTimeLeft:0})})}render(){return React.createElement("section",{id:"zwm_reolink_doorcam"},React.createElement("div",null,React.createElement("button",{onClick:this.onSnapRequested,disabled:this.state.isLoading||this.state.isRecording},this.state.isLoading?"Capturing...":"Take New Snapshot"),React.createElement("button",{onClick:this.onRecordRequested,disabled:this.state.isRecording||this.state.isLoading},this.state.isRecording?`Recording (${this.state.recordingTimeLeft}s)...`:`Record Video (${this.state.recordDuration}s)`),React.createElement("button",{onClick:()=>window.location.href=`${this.props.svc_full_url}/nvr`},"View Recordings"),React.createElement("input",{type:"range",min:"10",max:"100",value:this.state.recordDuration,onChange:e=>this.setState({recordDuration:parseInt(e.target.value)}),disabled:this.state.isRecording})),React.createElement("a",{href:`${this.props.api_base_path}/lastsnap?t=${this.state.imageTimestamp}`},React.createElement("img",{className:"img-always-on-screen quite-round",src:`${this.props.api_base_path}/lastsnap?t=${this.state.imageTimestamp}`,alt:"Last doorbell snap"})))}}const INTERESTING_PLOT_METRICS=["temperature","humidity","pm25","voc_index"];function buildUrlForPeriod(period,prefix="/history"){if(!period||period=="all")return"";let unit="days";let time=1;if(period=="hour_1"){unit="hours";time=1}if(period=="hour_6"){unit="hours";time=6}if(period=="hour_12"){unit="hours";time=12}if(period=="day_1"){unit="days";time=1}if(period=="day_2"){unit="days";time=2}return`${prefix}/${unit}/${time}`}function renderSensorValues(sensorData,metrics){function getUnit(metric){const units={temperature:"\xB0C",device_temperature:"\xB0C",humidity:"%",voltage:"V",voltage_volts:"V",battery:"%",pm25:"\xB5g/m\xB3",active_power_watts:"W",current_amps:"A",lifetime_energy_use_watt_hour:"Wh",last_minute_energy_use_watt_hour:"Wh"};return units[metric]||""}function formatValue(value,metric){if(typeof value!=="number"){return"?"}const unit=getUnit(metric);return unit?`${value}${unit}`:value}if(sensorData===undefined){return"..."}if(sensorData===null){return"?"}const hasAnyValue=metrics.some(m=>typeof sensorData[m]==="number");if(!hasAnyValue){return"No data yet"}if(metrics.length===1){return formatValue(sensorData[metrics[0]],metrics[0])}else{return metrics.map(m=>`${m}=${formatValue(sensorData[m],m)}`).join(", ")}}function simple_dygraph_plot(html_elm_id,url){let dygraph_opts={fillGraph:false,connectSeparatedPoints:true,highlightCircleSize:2,strokeWidth:1,width:window.innerWidth*.9,rollPeriod:5,legend:"always",highlightSeriesOpts:{strokeWidth:3,strokeBorderWidth:1,highlightCircleSize:5}};mTextGet(url,t_csv=>{const label_elm=document.getElementById(html_elm_id+"_label");if(label_elm){dygraph_opts["labelsDiv"]=label_elm}new Dygraph(document.getElementById(html_elm_id),t_csv,dygraph_opts)})}class SensorsHistoryPane extends React.Component{static buildProps(){const urlParams=new URLSearchParams(window.location.search);const urlQueryMetric=urlParams.get("metric");const metric=urlQueryMetric?[urlQueryMetric]:INTERESTING_PLOT_METRICS;const urlQueryPeriod=urlParams.get("period");const period=urlQueryPeriod?[urlQueryPeriod]:"day_2";const plotSingleMetric=!!urlQueryMetric;const selectedSensor=urlParams.get("sensor");return{plotSingleMetric,metrics_to_plot:metric,period,selectedSensor,key:"SensorsHistoryPane"}}constructor(props){super(props);this.loadPlotsForSensorMeasuring=this.loadPlotsForSensorMeasuring.bind(this);this.updateConfigPeriod=this.updateConfigPeriod.bind(this);this.updateConfigMetric=this.updateConfigMetric.bind(this);this.sensorsListRef=React.createRef();this.state={sensors:null,period:this.props.period,allMetrics:[],selectedMetrics:this.props.metrics_to_plot,selectedSensor:this.props.selectedSensor,sensorMetrics:null}}componentDidMount(){this.on_app_became_visible()}on_app_became_visible(){mJsonGet("/sensors/metrics",metrics=>{this.setState({allMetrics:metrics,sensors:null})});if(this.sensorsListRef.current){this.sensorsListRef.current.loadSensors()}}updateConfigPeriod(){const period=document.getElementById("SensorsHistoryConfig_period").value;window.history.replaceState(null,"Sensors",`?metric=${this.state.selectedMetrics.join(",")}&period=${period}`);this.setState({period})}updateConfigMetric(){const select=document.getElementById("SensorsHistoryConfig_metric");const selected=Array.from(select.selectedOptions).map(o=>o.value);window.history.replaceState(null,"Sensors",`?metric=${selected.join(",")}&period=${this.state.period}`);this.setState({selectedMetrics:selected,sensors:null})}render(){return React.createElement("div",{id:"SensorsHistoryPane"},React.createElement("div",{class:"SensorsHistoryConfig"},React.createElement("label",{htmlFor:"SensorsHistoryConfig_period"},"Period:"),React.createElement("select",{value:this.state.period,name:"SensorsHistoryConfig_period",id:"SensorsHistoryConfig_period",onChange:this.updateConfigPeriod},React.createElement("option",{value:"hour_1"},"Last hour"),React.createElement("option",{value:"hour_6"},"Last 6 hours"),React.createElement("option",{value:"hour_12"},"Last 12 hours"),React.createElement("option",{value:"day_1"},"Last day"),React.createElement("option",{value:"day_2"},"Last 2 days"),React.createElement("option",{value:"all"},"All")),React.createElement("label",{htmlFor:"SensorsHistoryConfig_metric",style:{marginLeft:"10px"}},"Metrics:"),React.createElement("select",{id:"SensorsHistoryConfig_metric",multiple:true,value:this.state.selectedMetrics,onChange:this.updateConfigMetric},this.state.allMetrics.map(m=>React.createElement("option",{value:m,key:m},m)))),React.createElement(SensorsList,{ref:this.sensorsListRef,metrics:this.state.selectedMetrics,api_base_path:this.props.api_base_path}),this.render_plots())}render_plots(){if(this.state.selectedSensor){if(!this.state.sensorMetrics){this.loadMetricsForSensor(this.state.selectedSensor);return"Loading sensor metrics..."}return this.renderSingleSensor(this.state.selectedSensor,this.state.sensorMetrics)}const metrics=this.state.selectedMetrics;if(metrics.length===1&&!this.state.sensors){this.loadPlotsForSensorMeasuring(metrics[0]);return"Loading sensors..."}else if(metrics.length===1){return this.renderSingleMetric(metrics[0],this.state.sensors)}else{return this.renderMetricInAllSensors(metrics)}}loadMetricsForSensor(sensorName){mJsonGet(`/sensors/metrics/${sensorName}`,metrics=>{this.setState({sensorMetrics:metrics})})}renderSingleSensor(sensorName,metrics){let local_plots=[];for(const metric of metrics){const plotId=`local_plot_${sensorName}_${metric}`;const url=`/sensors/get_metric_in_sensor_csv/${sensorName}/${metric}${buildUrlForPeriod(this.state.period)}`;setTimeout(()=>{const plotDiv=document.getElementById(plotId);if(plotDiv){plotDiv.innerHTML=""}simple_dygraph_plot(plotId,url)},50);local_plots.push(React.createElement("div",{className:"card",key:`${sensorName}_${metric}_${this.state.period}_div`},React.createElement("h3",null,React.createElement("a",{href:`?metric=${metric}`},metric)," for ",sensorName),React.createElement("div",{id:plotId}),React.createElement("div",{id:`${plotId}_label`})))}return local_plots}renderMetricInAllSensors(metrics){let local_plots=[];for(const metric of metrics){const plotId=`local_plot_${metric}`;const url=`/sensors/get_single_metric_in_all_sensors_csv/${metric}${buildUrlForPeriod(this.state.period,"")}`;setTimeout(()=>{const plotDiv=document.getElementById(plotId);if(plotDiv){plotDiv.innerHTML=""}simple_dygraph_plot(plotId,url)},0);local_plots.push(React.createElement("div",{className:"card",key:`${metric}_${this.state.period}_div`},React.createElement("h3",null,React.createElement("a",{href:`?metric=${metric}`},metric)),React.createElement("div",{id:plotId}),React.createElement("div",{id:`${plotId}_label`})))}return local_plots}loadPlotsForSensorMeasuring(metric){mJsonGet(`/sensors/measuring/${metric}`,sensors=>{this.setState({sensors})})}renderSingleMetric(metric,sensors){let local_plots=[];for(const sensor of sensors){const plotId=`local_plot_${sensor}`;const url=`/sensors/get_metric_in_sensor_csv/${sensor}/${metric}${buildUrlForPeriod(this.state.period)}`;setTimeout(()=>{const plotDiv=document.getElementById(plotId);if(plotDiv){plotDiv.innerHTML=""}simple_dygraph_plot(plotId,url)},50);local_plots.push(React.createElement("div",{className:"card",key:`${sensor}_${this.state.period}_div`},React.createElement("h3",null,metric," for ",sensor),React.createElement("div",{id:plotId}),React.createElement("div",{id:`${plotId}_label`})))}return local_plots}};class SensorsList extends React.Component{constructor(props){super(props);this.state={sensors:null,sensorData:{}}}componentDidMount(){this.loadSensors()}componentDidUpdate(prevProps){if(prevProps.metrics!==this.props.metrics){this.loadSensors()}}loadSensors(){const metrics=this.props.metrics;if(!metrics||metrics.length===0){this.setState({sensors:[],sensorData:{}});return}const basePath=this.props.api_base_path||"";if(metrics.length===1){mJsonGet(`${basePath}/sensors/measuring/${metrics[0]}`,sensors=>{this.setState({sensors,sensorData:{}});this.loadSensorData(sensors)})}else{const allSensors=new Set;let pending=metrics.length;metrics.forEach(metric=>{mJsonGet(`${basePath}/sensors/measuring/${metric}`,sensorLst=>{sensorLst.forEach(s=>allSensors.add(s));pending--;if(pending===0){const sensors=Array.from(allSensors).sort();this.setState({sensors,sensorData:{}});this.loadSensorData(sensors)}})})}}loadSensorData(sensors){const basePath=this.props.api_base_path||"";sensors.forEach(sensor=>{mJsonGet(`${basePath}/sensors/get/${sensor}`,data=>{this.setState(prevState=>({sensorData:{...prevState.sensorData,[sensor]:data}}))})})}render(){if(this.state.sensors===null){return React.createElement("div",{className:"card hint"},React.createElement("p",null,"Loading sensors!"),React.createElement("p",null,"Please wait..."))}return React.createElement("ul",{className:"not-a-list"},this.state.sensors.map(sensor=>React.createElement("li",{key:sensor,className:"infobadge"},React.createElement("a",{href:`?sensor=${sensor}`},sensor),": ",renderSensorValues(this.state.sensorData[sensor],this.props.metrics))))}}function getMediaType(speaker){if(speaker.is_playing_line_in)return"Line-In";if(speaker.is_playing_radio)return"Radio";if(speaker.is_playing_tv)return"TV";if(speaker.transport_state==="PLAYING")return"Other";return null}function findSpeakerGroup(speakerName,groups){for(const[coordinator,members]of Object.entries(groups)){if(members.includes(speakerName)){return coordinator}}return null}class SonosSpeaker extends React.Component{onVolumeChange(e){const v=parseInt(e.target.value,10);this.props.onVolumeChange(this.props.speaker.name,v)}renderExtraCfgs(){const speaker=this.props.speaker;const speakerInfo=speaker.speaker_info||{};const mediaType=getMediaType(speaker);return React.createElement("details",{className:"light_details"},React.createElement("summary",null,"\u2699"),React.createElement("div",null,React.createElement("div",null,"Name: ",speakerInfo.player_name||speaker.name),React.createElement("div",null,"Model: ",speakerInfo.model_name),React.createElement("div",null,"Model Number: ",speakerInfo.model_number),React.createElement("div",null,"Zone: ",speakerInfo.zone_name),React.createElement("div",null,"URI: ",speaker.uri||"None"),React.createElement("div",null,"Media Type: ",mediaType||"None")))}render(){const speaker=this.props.speaker;const groups=this.props.groups;const groupCoordinator=findSpeakerGroup(speaker.name,groups);let transport=speaker.transport_state;if(speaker.transport_state==="PLAYING")transport="\u25B6";if(speaker.transport_state==="PAUSED_PLAYBACK")transport="\u23F8";if(speaker.transport_state==="STOPPED")transport="Stopped";if(groupCoordinator&&groupCoordinator!=speaker.name)transport=`Follows ${groupCoordinator}`;return React.createElement("li",null,React.createElement("p",null,React.createElement("input",{id:`${speaker.name}_control`,type:"checkbox",checked:this.props.controlSelected,onChange:()=>this.props.onControlToggle(speaker.name)}),React.createElement("label",{htmlFor:`${speaker.name}_control`},speaker.name)," [",transport,"]"),"Vol: ",this.props.volume,React.createElement(DebouncedRange,{min:0,max:100,value:this.props.volume,onChange:e=>this.onVolumeChange(e)}),this.renderExtraCfgs())}}class SonosCtrl extends React.Component{static buildProps(api_base_path="",baseServer=""){return{key:"SonosCtrl",api_base_path:api_base_path,baseServer:baseServer}}constructor(props){super(props);this.state={speakers:null,groups:null,zones:null,controlSpeakers:{},masterVolume:50,spotifyContext:null,speakerVolumes:{},volumeRatios:{},wsInProgress:false,wsLogs:[],wsComplete:false}}onControlToggle(speakerName){this.setState(prev=>({controlSpeakers:{...prev.controlSpeakers,[speakerName]:!prev.controlSpeakers[speakerName]}}))}startWebSocketAction(endpoint,initialMsg,payload){this.setState({wsInProgress:true,wsLogs:[initialMsg],wsComplete:false});let wsUrl;if(this.props.baseServer){const wsHost=this.props.baseServer.replace(/^https?:\/\//,"");const protocol=this.props.baseServer.startsWith("https:")?"wss:":"ws:";wsUrl=`${protocol}//${wsHost}${endpoint}`}else{const protocol=window.location.protocol==="https:"?"wss:":"ws:";wsUrl=`${protocol}//${window.location.host}${this.props.api_base_path}${endpoint}`}const ws=new WebSocket(wsUrl);ws.onopen=()=>{ws.send(JSON.stringify(payload))};ws.onmessage=event=>{this.setState(prev=>({wsLogs:[...prev.wsLogs,event.data]}))};ws.onclose=()=>{this.setState({wsInProgress:false,wsComplete:true})};ws.onerror=()=>{this.setState({wsInProgress:false,wsComplete:true})}}getSelectedSpeakers(){const{controlSpeakers,speakerVolumes}=this.state;const speakers={};const speakerNames=[];for(const[name,selected]of Object.entries(controlSpeakers)){if(selected){speakers[name]={vol:speakerVolumes[name]||0};speakerNames.push(name)}}return{speakers,speakerNames}}onSpotifyHijack(){const{speakers,speakerNames}=this.getSelectedSpeakers();if(Object.keys(speakers).length===0){showGlobalError("You need to select a set of speakers to control");return}this.startWebSocketAction("/spotify_hijack",`Requested Spotify-Hijack to ${speakerNames.join(", ")}`,speakers)}onLineInRequested(){const{speakers,speakerNames}=this.getSelectedSpeakers();if(Object.keys(speakers).length===0){showGlobalError("You need to select a set of speakers to control");return}this.startWebSocketAction("/line_in_requested",`Requested Line-In to ${speakerNames.join(", ")}`,speakers)}onWsLogClose(){this.setState({wsLogs:[],wsComplete:false})}onStopAll(){mJsonPut(`${this.props.api_base_path}/stop_all_playback`)}onPrevTrackRq(){mJsonPut(`${this.props.api_base_path}/prev_track`)}onNextTrackRq(){mJsonPut(`${this.props.api_base_path}/next_track`)}onSpeakerVolumeChange(speakerName,volume){this.setState(prev=>{const newRatio=volume>0?prev.masterVolume/volume:prev.masterVolume;return{speakerVolumes:{...prev.speakerVolumes,[speakerName]:volume},volumeRatios:{...prev.volumeRatios,[speakerName]:newRatio}}});mJsonPut(`${this.props.api_base_path}/volume`,{[speakerName]:volume})}onMasterVolumeChange(e){const newMaster=parseInt(e.target.value,10);const{volumeRatios,controlSpeakers,speakerVolumes}=this.state;const updatedVolumes={};for(const[name,ratio]of Object.entries(volumeRatios)){if(controlSpeakers[name]){const newVol=Math.round(Math.min(100,Math.max(0,newMaster/ratio)));updatedVolumes[name]=newVol}}if(Object.keys(updatedVolumes).length>0){mJsonPut(`${this.props.api_base_path}/volume`,updatedVolumes)}this.setState({masterVolume:newMaster,speakerVolumes:{...speakerVolumes,...updatedVolumes}})}componentDidMount(){this.fetchState()}on_app_became_visible(){this.fetchState()}fetchState(){mJsonGet(`${this.props.api_base_path}/world_state`,data=>{const speakerVolumes={};const volumeRatios={};const masterVolume=this.state.masterVolume;for(const speaker of data.speakers){speakerVolumes[speaker.name]=speaker.volume;volumeRatios[speaker.name]=speaker.volume>0?masterVolume/speaker.volume:masterVolume}this.setState({speakers:data.speakers,groups:data.groups,zones:data.zones,speakerVolumes:speakerVolumes,volumeRatios:volumeRatios})});mJsonGet(`${this.props.api_base_path}/get_spotify_context`,data=>{this.setState({spotifyContext:data})})}render(){var _this$state$spotifyCo;if(!this.state.speakers){return React.createElement("div",null,"Loading...")}const spotifyUri=(_this$state$spotifyCo=this.state.spotifyContext)===null||_this$state$spotifyCo===void 0||(_this$state$spotifyCo=_this$state$spotifyCo.media_info)===null||_this$state$spotifyCo===void 0||(_this$state$spotifyCo=_this$state$spotifyCo.context)===null||_this$state$spotifyCo===void 0?void 0:_this$state$spotifyCo.uri;const hasSpotify=spotifyUri!=null;return React.createElement("div",{id:"zmw_lights"},React.createElement("div",{id:"master_ctrls",className:"card"},React.createElement("button",{onClick:()=>this.fetchState()},"\u21BB"),React.createElement("button",{onClick:()=>this.onSpotifyHijack(),disabled:!hasSpotify||this.state.wsInProgress},this.state.wsInProgress?"Working...":hasSpotify?"Spotify Hijack":"Spotify Hijack (Not playing)"),React.createElement("button",{onClick:()=>this.onLineInRequested(),disabled:this.state.wsInProgress},"Line in"),React.createElement("button",{onClick:()=>this.onStopAll()},"Stop all"),React.createElement("button",{onClick:()=>this.onPrevTrackRq()},"Prev"),React.createElement("button",{onClick:()=>this.onNextTrackRq()},"Next"),React.createElement("label",null,"Master volume"),React.createElement(DebouncedRange,{min:0,max:100,value:this.state.masterVolume,onChange:e=>this.onMasterVolumeChange(e)})),this.state.wsLogs.length>0&&React.createElement("div",{id:"ws_log"},React.createElement("pre",null,this.state.wsLogs.join("\n")),this.state.wsComplete&&React.createElement("button",{onClick:()=>this.onWsLogClose()},"Close")),React.createElement("details",{open:true},React.createElement("summary",null,"Speakers"),React.createElement("ul",null,this.state.speakers.map(speaker=>React.createElement(SonosSpeaker,{key:speaker.name,speaker:speaker,groups:this.state.groups,api_base_path:this.props.api_base_path,controlSelected:!!this.state.controlSpeakers[speaker.name],onControlToggle:name=>this.onControlToggle(name),volume:this.state.speakerVolumes[speaker.name]||0,onVolumeChange:(name,vol)=>this.onSpeakerVolumeChange(name,vol)})))))}}class TTSAnnounce extends React.Component{static buildProps(api_base_path="",https_server=""){return{key:"tts_announce",api_base_path,https_server}}constructor(props){super(props);this.canRecordMic=window.location.protocol==="https:";this.state={ttsPhrase:"",ttsLang:"es-ES",ttsVolume:50,isRecording:false,speakerList:null,announcementHistory:[],historyExpanded:false,httpsServer:null};this.recorderRef=React.createRef();this.onTTSRequested=this.onTTSRequested.bind(this);this.onMicRecRequested=this.onMicRecRequested.bind(this);this.onMicRecSend=this.onMicRecSend.bind(this);this.onCancel=this.onCancel.bind(this);this.fetchAnnouncementHistory=this.fetchAnnouncementHistory.bind(this)}componentDidMount(){this.on_app_became_visible()}on_app_became_visible(){mJsonGet(`${this.props.api_base_path}/ls_speakers`,data=>this.setState({speakerList:data}));mJsonGet(`${this.props.api_base_path}/svc_config`,data=>this.setState({httpsServer:data.https_server}));this.fetchAnnouncementHistory()}fetchAnnouncementHistory(){mJsonGet(`${this.props.api_base_path}/announcement_history`,data=>this.setState({announcementHistory:data}))}onTTSRequested(){const phrase=this.state.ttsPhrase.trim()||prompt("What is so important?");if(!phrase)return;this.setState({ttsPhrase:phrase});console.log(`announce {"lang": "${this.state.ttsLang}", "phrase": "${phrase}"}`);const newEntry={timestamp:new Date().toISOString(),phrase:phrase,lang:this.state.ttsLang,volume:this.state.ttsVolume,uri:`${this.props.api_base_path}/tts/${phrase}_${this.state.ttsLang}.mp3`};this.setState(prev=>({announcementHistory:[...prev.announcementHistory,newEntry].slice(-10)}));console.log(`${this.props.api_base_path}/announce_tts?lang=${this.state.ttsLang}&phrase=${phrase}&vol=${this.state.ttsVolume}`);mJsonGet(`${this.props.api_base_path}/announce_tts?lang=${this.state.ttsLang}&phrase=${phrase}&vol=${this.state.ttsVolume}`,()=>{console.log("Sent TTS request");this.setState({ttsPhrase:""});this.fetchAnnouncementHistory()})}async onMicRecRequested(){if(!this.canRecordMic){showGlobalError("Mic recording only works on https pages");return}if(!navigator.mediaDevices){showGlobalError("Your browser does not support microphone recording");return}try{const stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});const rec=new MediaRecorder(stream);rec.chunks=[];rec.ondataavailable=e=>rec.chunks.push(e.data);this.recorderRef.current=rec;rec.start();this.setState({isRecording:true})}catch(err){showGlobalError("Mic error: "+err)}}onMicRecSend(){const rec=this.recorderRef.current;if(!rec){showGlobalError("No microphone recording in progress");return}rec.onstop=()=>{const blob=new Blob(rec.chunks,{type:"audio/ogg; codecs=opus"});const form=new FormData;form.append("audio_data",blob,"mic_cap.ogg");form.append("vol",this.state.ttsVolume);fetch(`${this.props.api_base_path}/announce_user_recording`,{method:"POST",body:form}).then(resp=>{if(!resp.ok)throw new Error(`HTTP ${resp.status}`);console.log("Sent user recording")}).catch(showGlobalError);rec.stream.getTracks().forEach(t=>t.stop());this.recorderRef.current=null;this.setState({isRecording:false})};rec.stop()}onCancel(){const rec=this.recorderRef.current;if(rec){rec.stream.getTracks().forEach(t=>t.stop());this.recorderRef.current=null}this.setState({isRecording:false})}render(){return React.createElement("div",null,React.createElement("input",{type:"text",placeholder:"Text to announce",value:this.state.ttsPhrase,onChange:e=>this.setState({ttsPhrase:e.target.value})}),React.createElement("div",{className:"ctrl-box-with-range"},React.createElement("button",{onClick:this.onTTSRequested},"Announce!"),React.createElement("select",{value:this.state.ttsLang,onChange:e=>this.setState({ttsLang:e.target.value})},React.createElement("option",{value:"es-ES"},"ES"),React.createElement("option",{value:"es-419"},"es 419"),React.createElement("option",{value:"en-GB"},"EN GB")),!this.canRecordMic?this.state.httpsServer?React.createElement("button",{onClick:()=>window.location.href=this.state.httpsServer},"OpenRecorder"):React.createElement("button",{disabled:true},"Record"):this.state.isRecording?React.createElement(React.Fragment,null,React.createElement("div",{className:"card warn",style:{flex:"0 0 25%"}},React.createElement("p",null,"Recording in progress!"),React.createElement("button",{onClick:this.onMicRecSend},"Send"),React.createElement("button",{onClick:this.onCancel},"Cancel"))):React.createElement("button",{onClick:this.onMicRecRequested},"Record"),React.createElement("label",null,"Vol"),React.createElement("input",{type:"range",min:"0",max:"100",value:this.state.ttsVolume,onChange:e=>this.setState({ttsVolume:parseInt(e.target.value,10)}),title:`Volume: ${this.state.ttsVolume}%`})),this.state.speakerList&&React.createElement("small",null,"Will announce in: ",React.createElement("ul",{className:"compact-list"},this.state.speakerList.map(x=>React.createElement("li",{key:x},x)))),React.createElement("details",{className:"light_details"},React.createElement("summary",null,React.createElement("small",null,"Announcement History (",this.state.announcementHistory.length,")")),this.state.announcementHistory.length===0?React.createElement("p",null,"No announcements yet"):React.createElement("table",null,React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Time"),React.createElement("th",null,"Phrase"),React.createElement("th",null,"Lang"),React.createElement("th",null,"Vol"),React.createElement("th",null,"Link"))),React.createElement("tbody",null,this.state.announcementHistory.slice().reverse().map((item,idx)=>React.createElement("tr",{key:idx},React.createElement("td",null,new Date(item.timestamp).toLocaleString()),React.createElement("td",null,item.phrase),React.createElement("td",null,item.lang||"default"),React.createElement("td",null,item.volume),React.createElement("td",null,React.createElement("a",{href:item.uri},"\uD83D\uDD0A"))))))))}}const ProxiedServices={CACHE_KEY:"proxied_services",_services:null,_storage:new LocalStorageManager,_fetchServices(callback){mJsonGet("/get_proxied_services",services=>{this._services=services;this._storage.cacheSave(this.CACHE_KEY,services);if(callback)callback(services)})},get(serviceName){return this._services?this._services[serviceName]:null},init(callback){const fresh=this._storage.cacheGet(this.CACHE_KEY);const cached=fresh||this._storage.cacheGet_ignoreExpire(this.CACHE_KEY);if(cached){this._services=cached;if(!fresh)this._fetchServices();callback()}else{this._fetchServices(callback)}}};class AlertsList extends React.Component{constructor(props){super(props);this.state={alerts:[]}}componentDidMount(){this.fetchAlerts();this.interval=setInterval(()=>this.fetchAlerts(),30000)}componentWillUnmount(){if(this.interval)clearInterval(this.interval)}fetchAlerts(){mJsonGet("/svc_alerts",res=>{this.setState({alerts:res||[]})})}render(){if(this.state.alerts.length===0){return null}return React.createElement("div",{className:"card warn"},React.createElement("p",null,"Alert!"),React.createElement("ul",null,this.state.alerts.map((alert,idx)=>React.createElement("li",{key:idx},alert))))}}class ScenesList extends React.Component{constructor(props){super(props);this.state={scenes:[],sceneStatus:null};this.fetchScenes=this.fetchScenes.bind(this);this.applyScene=this.applyScene.bind(this)}componentDidMount(){this.fetchScenes()}fetchScenes(){mJsonGet(this.props.api_base_path+"/ls_scenes",res=>{this.setState({scenes:res||[]})})}applyScene(scene){mJsonGet(this.props.api_base_path+"/apply_scene?scene="+encodeURIComponent(scene),res=>{if(res&&res.success){this.setState({sceneStatus:"Scene applied"});setTimeout(()=>{this.setState({sceneStatus:null})},3000)}})}render(){if(this.state.scenes.length===0){return null}return React.createElement("ul",{className:"not-a-list"},this.state.scenes.map((scene,idx)=>React.createElement("li",{key:idx},React.createElement("button",{type:"button",onClick:()=>this.applyScene(scene)},scene.replace(/_/g," ")))),this.state.sceneStatus&&React.createElement("li",null,React.createElement("blockquote",{className:"hint"},this.state.sceneStatus)))}}class LightsSection extends React.Component{constructor(props){super(props);this.state={scenes:[]}}componentDidMount(){mJsonGet("/Scenes/ls_scenes",scenes=>{if(!scenes||!Array.isArray(scenes)){showGlobalError("Scenes API isn't working");return}const buttons=scenes.map(scene=>({[scene]:`/Scenes/apply_scene?scene=${encodeURIComponent(scene)}`}));this.setState({scenes:buttons})})}render(){return React.createElement("section",{id:"lights-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwLights")},React.createElement("img",{src:"/ZmwLights/favicon.ico"})),React.createElement(MqttLights,MqttLights.buildProps("/ZmwLights",this.state.scenes)))}}function SensorsListSection(props){return React.createElement("section",{id:"sensors-list-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwSensormon")},React.createElement("img",{src:"/ZmwSensormon/favicon.ico"})),React.createElement(SensorsList,{metrics:["temperature"],api_base_path:"/ZmwSensormon"}))}function TTSAnnounceSection(props){return React.createElement("section",{id:"ttsannounce-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwSpeakerAnnounce")},React.createElement("img",{src:"/ZmwSpeakerAnnounce/favicon.ico"})),React.createElement(TTSAnnounce,TTSAnnounce.buildProps("/ZmwSpeakerAnnounce")))}function ContactMonSection(props){return React.createElement("section",{id:"contactmon-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwContactmon")},React.createElement("img",{src:"/ZmwContactmon/favicon.ico"})),React.createElement(ContactMonitor,ContactMonitor.buildProps("/ZmwContactmon")))}function MqttHeatingSection(props){return React.createElement("section",{id:"heating-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwHeating")},React.createElement("img",{src:"/ZmwHeating/favicon.ico"})),React.createElement(HeatingControls,HeatingControls.buildProps("/ZmwHeating")))}function ReolinkDoorbellSection(props){return React.createElement("section",{id:"reolink-doorbell-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwReolinkDoorbell")},React.createElement("img",{src:"/ZmwReolinkDoorbell/favicon.ico"})),React.createElement(CamViewer,CamViewer.buildProps("/ZmwReolinkDoorbell",ProxiedServices.get("ZmwReolinkDoorbell"))))}function SonosCtrlSection(props){return React.createElement("section",{id:"sonos-ctrl-section"},React.createElement("a",{className:"section-badge",href:ProxiedServices.get("ZmwSonosCtrl")},React.createElement("img",{src:"/ZmwSonosCtrl/favicon.ico"})),React.createElement(SonosCtrl,SonosCtrl.buildProps("/ZmwSonosCtrl",ProxiedServices.get("ZmwSonosCtrl"))))}function ConfigSection(props){var _store$cacheGet;const store=React.useMemo(()=>new LocalStorageManager,[]);const savedTheme=((_store$cacheGet=store.cacheGet("ZmwDashboardConfig"))===null||_store$cacheGet===void 0?void 0:_store$cacheGet.theme)||"no-theme";const[userLinks,setUserLinks]=React.useState([]);React.useEffect(()=>{mJsonGet("/get_user_defined_links",links=>{setUserLinks(links||[])})},[]);const handleThemeChange=e=>{const theme=e.target.value;document.documentElement.setAttribute("data-theme",theme);store.cacheSave("ZmwDashboardConfig",{theme})};const handleClearCache=()=>{localStorage.clear();location.reload()};return React.createElement("section",{id:"config-section"},React.createElement("img",{className:"section-badge",src:"/settings.ico"}),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr",gap:"0.5rem",alignItems:"center"}},React.createElement("label",null,"Fix things:"),React.createElement("div",null,React.createElement("button",{alt:"This fixes things if something is out of sync",onClick:handleClearCache},"Clear cache")),React.createElement("label",{htmlFor:"configTheme"},"Theme:"),React.createElement("div",null,React.createElement("select",{id:"configTheme",defaultValue:savedTheme,onChange:handleThemeChange},React.createElement("option",{value:"no-theme"},"no theme"),React.createElement("option",{value:"dark"},"dark"),React.createElement("option",{value:"light"},"light"),React.createElement("option",{value:"sepia"},"sepia"),React.createElement("option",{value:"milligram"},"milligram"),React.createElement("option",{value:"pure"},"pure"),React.createElement("option",{value:"sakura"},"sakura"),React.createElement("option",{value:"skeleton"},"skeleton"),React.createElement("option",{value:"bootstrap"},"bootstrap"),React.createElement("option",{value:"medium"},"medium"),React.createElement("option",{value:"tufte"},"tufte"))),React.createElement("label",null,"More services:"),React.createElement("div",null,userLinks.map((link,idx)=>React.createElement("button",{key:idx,onClick:()=>window.open(link.url,"_blank")},React.createElement("img",{src:link.icon,alt:""}),link.label)))))}function Dashboard(props){const[expandedSection,setExpandedSection]=React.useState(null);const contentRef=React.useRef(null);const toggleSection=section=>{const newSection=expandedSection===section?null:section;setExpandedSection(newSection);if(newSection!==null){setTimeout(()=>{if(contentRef.current){contentRef.current.scrollIntoView({behavior:"smooth",block:"start"})}},50)}};const renderIcoBtn=(sectionName,icoUrl)=>{return React.createElement("button",{"data-selected":expandedSection===sectionName,onClick:()=>toggleSection(sectionName)},React.createElement("img",{src:icoUrl,alt:""}),sectionName)};const renderSvcBtn=(sectionName,serviceName)=>renderIcoBtn(sectionName,`/${serviceName}/favicon.ico`);return React.createElement("main",null,React.createElement(AlertsList,null),React.createElement(LightsSection,null),React.createElement(SensorsListSection,null),React.createElement("section",{id:"zmw_other_services"},renderSvcBtn("Shout","ZmwSpeakerAnnounce"),renderSvcBtn("Door","ZmwContactmon"),renderSvcBtn("Heat","ZmwHeating"),renderSvcBtn("Cams","ZmwReolinkDoorbell"),renderSvcBtn("Sonos","ZmwSonosCtrl"),renderIcoBtn("\u2699","/settings.ico")),React.createElement("div",{ref:contentRef},expandedSection==="Shout"&&React.createElement(TTSAnnounceSection,null),expandedSection==="Door"&&React.createElement(ContactMonSection,null),expandedSection==="Heat"&&React.createElement(MqttHeatingSection,null),expandedSection==="Cams"&&React.createElement(ReolinkDoorbellSection,null),expandedSection==="Sonos"&&React.createElement(SonosCtrlSection,null),expandedSection==="\u2699"&&React.createElement(ConfigSection,null)))}Dashboard.buildProps=()=>({key:"dashboard"});const store=new LocalStorageManager;const opts=store.cacheGet("ZmwDashboardConfig",null);document.documentElement.setAttribute("data-theme",opts===null||opts===void 0?void 0:opts.theme);ProxiedServices.init(()=>{});z2mStartReactApp("#app_root",Dashboard);
